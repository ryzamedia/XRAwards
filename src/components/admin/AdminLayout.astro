---
/**
 * Admin Layout Component
 * Provides consistent navigation and structure for admin pages
 * Handles authentication centrally - no need for individual pages to handle auth
 */

import { requireAdminAuth } from '../../utils/supabase';
import ProfileEditForm from './ProfileEditForm';

interface Props {
  title: string;
  activePage?: 'dashboard' | 'media-library' | 'categories' | 'finalists' | 'tags' | 'events' | 'sponsors' | 'judges' | 'accolades' | 'contacts' | 'communications' | 'articles';
}

const { title, activePage } = Astro.props;

// Handle authentication centrally in the layout
const authResult = await requireAdminAuth(Astro.cookies, Astro.request);

// Redirect if not authenticated
if (!authResult.authenticated) {
  return Astro.redirect(authResult.redirect);
}

const { user, supabase: serverSupabase } = authResult;

// Get the session to pass access token to client-side scripts
const { data: { session } } = await serverSupabase.auth.getSession();
const accessToken = session?.access_token || '';
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;

const navItems = [
  { id: 'dashboard', label: 'Dashboard', href: '/admin/' },
  { id: 'articles', label: 'Articles', href: '/admin/articles/' },
  { id: 'communications', label: 'Communications', href: '/admin/communications/' },
  { id: 'events', label: 'Event Details', href: '/admin/events/' },
  { id: 'media-library', label: 'Media Library', href: '/admin/media-library/' },
  { id: 'categories', label: 'Categories', href: '/admin/categories/' },
  { id: 'accolades', label: 'Accolades', href: '/admin/accolades/' },
  { id: 'finalists', label: 'Finalists', href: '/admin/finalists/' },
  { id: 'sponsors', label: 'Sponsors', href: '/admin/sponsors/' },
  { id: 'judges', label: 'Judges', href: '/admin/judges/' },
  { id: 'contacts', label: 'Contacts', href: '/admin/contacts/' },
  { id: 'tags', label: 'Tags', href: '/admin/tags/' },
];
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} - Admin</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Pass auth token and Supabase URL to client-side scripts -->
    <script is:inline define:vars={{ accessToken, supabaseUrl }}>
      window.__SUPABASE_ACCESS_TOKEN__ = accessToken;
      window.__SUPABASE_URL__ = supabaseUrl;
    </script>
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
        <!-- Logo/Header -->
        <div class="p-6 border-b border-gray-200">
          <h1 class="text-xl font-bold text-gray-900">XR Awards</h1>
          <p class="text-sm text-gray-600 mt-1">Admin Panel</p>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-1">
          {navItems.map((item) => (
            <a
              href={item.href}
              class={`block px-4 py-3 rounded-lg transition-colors ${
                activePage === item.id
                  ? 'bg-blue-50 text-blue-700 font-medium'
                  : 'text-gray-700 hover:bg-gray-50'
              }`}
            >
              {item.label}
            </a>
          ))}
        </nav>

        <!-- User Info & Logout -->
        <div class="p-4 border-t border-gray-200">
          <button
            id="profileBtn"
            class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50 transition-colors mb-3 text-left"
          >
            <div
              id="profileAvatar"
              class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-medium text-sm flex-shrink-0"
            >
              <span id="avatarInitials">A</span>
              <img
                id="avatarImage"
                src=""
                alt="Profile"
                class="w-full h-full rounded-full object-cover hidden"
              />
            </div>
            <div class="flex-1 min-w-0 text-sm">
              <p id="profileName" class="text-gray-900 font-medium truncate">{user?.email || 'Admin'}</p>
              <p class="text-gray-500 text-xs">Administrator</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-400 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              />
            </svg>
          </button>
          <button
            id="signOutBtn"
            class="w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors"
          >
            Sign Out
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 overflow-auto">
        <div class="max-w-6xl mx-auto p-8">
          <slot />
        </div>
      </main>
    </div>

    <!-- Profile Edit Form -->
    <ProfileEditForm client:only="react" />

    <script>
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) {
        signOutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout/', {
              method: 'POST',
            });
            window.location.href = '/admin/login/';
          } catch (error) {
            console.error('Logout error:', error);
            // Still redirect even if logout fails
            window.location.href = '/admin/login/';
          }
        });
      }

      // Profile management
      let profileData = null;
      let profileModalOpen = false;

      // Fetch profile data
      async function fetchProfile() {
        try {
          const response = await fetch('/api/profile/');
          if (response.ok) {
            profileData = await response.json();
            updateProfileDisplay();
          }
        } catch (error) {
          console.error('Failed to fetch profile:', error);
        }
      }

      // Update profile display in sidebar
      function updateProfileDisplay() {
        const profileNameEl = document.getElementById('profileName');
        const avatarInitialsEl = document.getElementById('avatarInitials');
        const avatarImageEl = document.getElementById('avatarImage');

        if (profileData) {
          const fullName = `${profileData.firstName || ''} ${profileData.lastName || ''}`.trim();
          if (fullName && profileNameEl) {
            profileNameEl.textContent = fullName;
          }

          // Update avatar
          if (profileData.profilePhotoUrl && avatarImageEl && avatarInitialsEl) {
            avatarImageEl.src = profileData.profilePhotoUrl;
            avatarImageEl.classList.remove('hidden');
            avatarInitialsEl.classList.add('hidden');
          } else if (avatarInitialsEl && avatarImageEl) {
            // Show initials
            const initials = profileData.firstName?.[0] || profileData.lastName?.[0] || 'A';
            avatarInitialsEl.textContent = initials.toUpperCase();
            avatarInitialsEl.classList.remove('hidden');
            avatarImageEl.classList.add('hidden');
          }
        }
      }

      // Open profile modal
      function openProfileModal() {
        profileModalOpen = true;
        // Dispatch custom event to open modal
        window.dispatchEvent(new CustomEvent('openProfileModal', {
          detail: profileData
        }));
      }

      // Handle profile save
      window.addEventListener('profileSaved', async () => {
        await fetchProfile();
      });

      // Initialize
      const profileBtn = document.getElementById('profileBtn');
      if (profileBtn) {
        profileBtn.addEventListener('click', openProfileModal);
      }

      // Fetch profile on load
      fetchProfile();
    </script>
  </body>
</html>

<style>
  @import "tailwindcss";
</style>

