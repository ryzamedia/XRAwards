---
/**
 * Individual Category Page
 * Dynamic route for displaying a single category with its details
 */
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import CTAFooter from '../../components/CTAFooter.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { createClient } from '@supabase/supabase-js';
import { nl2br } from '../../utils/helpers';
import { getCTAButton, getEventPhase } from '../../utils/date-checker';

export const prerender = true;

// Get all category slugs for static generation
export async function getStaticPaths() {
  const { supabase } = await import('../../utils/supabase');

  const { data: categories } = await supabase
    .from('categories')
    .select('slug')
    .eq('is_visible', true);

  return (categories || []).map((category) => ({
    params: { slug: category.slug },
  }));
}

const { slug } = Astro.params;

// Fetch the specific category
const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const { data: category, error: categoryError } = await supabase
  .from('categories')
  .select('*')
  .eq('slug', slug)
  .eq('is_visible', true)
  .single();

if (categoryError || !category) {
  return Astro.redirect('/404/');
}

// Fetch active event details for nomination URL and deadline
const { data: eventDetails } = await supabase
  .from('event_details')
  .select('id, nomination_portal_url, nominations_close, event_year')
  .eq('is_active', true)
  .single();

// Get current event phase and CTA button
const eventPhase = await getEventPhase();
const ctaButton = await getCTAButton('header');
// For post-ceremony, use footer context which shows Register Interest
const postCeremonyCTA = eventPhase.phase === 'post-ceremony' 
  ? await getCTAButton('footer')
  : ctaButton;

// Fetch finalists for this category (ordered alphabetically by title)
const { data: allFinalists } = await supabase
  .from('finalists')
  .select(`
    *,
    event_details (
      event_year
    )
  `)
  .eq('category_id', category.id)
  .order('is_winner', { ascending: false })
  .order('title', { ascending: true });

// Filter to only winners, sort by year descending, and limit to last 3
const winners = (allFinalists || [])
  .filter((f: any) => f.is_winner)
  .sort((a: any, b: any) => {
    const yearA = a.event_details?.event_year || 0;
    const yearB = b.event_details?.event_year || 0;
    return yearB - yearA; // Descending order (most recent first)
  })
  .slice(0, 3);

const finalists = winners;

// Fetch other categories for "Explore Other Categories" section
// Only show categories from the active event
const { data: otherCategories } = await supabase
  .from('categories')
  .select(`
    *,
    category_events!inner (
      event_id,
      event_details!inner (
        id,
        is_active
      )
    )
  `)
  .eq('is_visible', true)
  .eq('category_events.event_details.is_active', true)
  .neq('id', category.id)
  .order('sort_order', { ascending: true })
  .limit(3);

// Fetch accolades for this category
// Get accolade types (level 1) linked to this category via category_accolades
const { data: categoryAccolades } = await supabase
  .from('category_accolades')
  .select(`
    accolade_id,
    accolades (
      id,
      code,
      name,
      description,
      sort_order
    )
  `)
  .eq('category_id', category.id);

// Get all individual accolades (level 2) that are children of the category's accolade types
const accoladeTypeIds = categoryAccolades?.map((ca: any) => ca.accolades?.id).filter(Boolean) || [];
let allAccolades: any[] = [];
if (accoladeTypeIds.length > 0) {
  const { data } = await supabase
    .from('accolades')
    .select('*')
    .in('parent_id', accoladeTypeIds)
    .eq('is_active', true)
    .order('sort_order', { ascending: true })
    .order('code', { ascending: true });
  allAccolades = data || [];
}

// Group individual accolades by their parent type
const accoladesByType = (categoryAccolades || [])
  .map((ca: any) => {
    const type = ca.accolades;
    if (!type) return null;
    
    const children = (allAccolades || []).filter((a: any) => a.parent_id === type.id);
    
    return {
      type,
      children: children.sort((a: any, b: any) => 
        (a.code || '').localeCompare(b.code || '')
      )
    };
  })
  .filter(Boolean)
  .sort((a: any, b: any) =>
    (a.type.code || '').localeCompare(b.type.code || '')
  );

// Fetch related case studies via finalists in this category
const finalistIds = (allFinalists || []).map((f: any) => f.id);
let categoryCaseStudies: any[] = [];
if (finalistIds.length > 0) {
  const { data: caseStudyLinks } = await supabase
    .from('article_finalists')
    .select(`
      articles!inner (*)
    `)
    .in('finalist_id', finalistIds)
    .eq('articles.is_published', true);

  if (caseStudyLinks) {
    // Deduplicate by article id and limit to 3
    const seen = new Set<string>();
    for (const link of caseStudyLinks) {
      const article = (link as any).articles;
      if (article && !seen.has(article.id)) {
        seen.add(article.id);
        categoryCaseStudies.push(article);
      }
    }
    categoryCaseStudies = categoryCaseStudies
      .sort((a, b) => new Date(b.published_at).getTime() - new Date(a.published_at).getTime())
      .slice(0, 3);
  }
}
---

<Layout
  title={`${category.name} - AIXR XR Awards`}
  description={category.description || `Learn more about the ${category.name} category at the AIXR XR Awards.`}
>
  <Header />
  
  <main class="min-h-screen bg-white">
    <!-- Category Header -->
    <section class="relative bg-[#0E1022] pt-32 md:pt-40 pb-20 md:pb-32 overflow-hidden">
      <!-- Decorative Background Rings -->
      <!-- Left Ring - Offset Up with Gradient -->
      <div class="absolute -left-20 md:left-0 top-1/4 -translate-y-1/2 -translate-x-1/2 w-[300px] h-[300px] md:w-[450px] md:h-[450px]">
        <div class="absolute inset-0 rounded-full" style="background: linear-gradient(180deg, #E91E8C 0%, #5D1635 100%);"></div>
        <div class="absolute top-[55px] left-[55px] right-[55px] bottom-[55px] md:top-[75px] md:left-[75px] md:right-[75px] md:bottom-[75px] rounded-full bg-[#0E1022]"></div>
      </div>
      <!-- Right Ring - Offset Down with Gradient -->
      <div class="absolute -right-20 md:right-0 top-3/4 -translate-y-1/2 translate-x-1/2 w-[300px] h-[300px] md:w-[450px] md:h-[450px]">
        <div class="absolute inset-0 rounded-full" style="background: linear-gradient(180deg, #00D4D8 0%, #0A4B52 100%);"></div>
        <div class="absolute top-[55px] left-[55px] right-[55px] bottom-[55px] md:top-[75px] md:left-[75px] md:right-[75px] md:bottom-[75px] rounded-full bg-[#0E1022]"></div>
      </div>
      
      <!-- Content -->
      <div class="relative z-10 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="category-title text-white mb-6">
          {category.name}
        </h1>
        
        <!-- Decorative Dots -->
        <div class="flex justify-center gap-2 mb-6">
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
        </div>
        
        <p class="category-subtitle text-white">
          Nominate and cement your work in the history books forever
        </p>
      </div>
    </section>

    <!-- Category Details -->
    <section class="py-16">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
          <!-- Main Content -->
          <div class="lg:col-span-2">
            <div class="mb-12">
              <h2 class="category-overview-title font-bold text-gray-900 mb-6">
                Category Overview
              </h2>
              {category.description && (
                <div class="category-description-text prose prose-sm max-w-none mb-6">
                  <div set:html={nl2br(category.description)} />
                </div>
              )}
              {category.additional_info && (
                <div class="category-description-text prose prose-sm max-w-none">
                  <div set:html={nl2br(category.additional_info)} />
                </div>
              )}
              {!category.description && !category.additional_info && (
                <p class="category-description-text">
                  More information about this category will be available soon.
                </p>
              )}
            </div>

            <!-- XR Accolades Accordion -->
            {accoladesByType && accoladesByType.length > 0 && (
              <div class="mb-12">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                  XR Accolades
                </h2>
                <div class="category-description-text prose prose-sm max-w-none mb-6">
                  <p>
                    When you nominate for this category, you submit your work for the entire category. 
                    Our judges evaluate all submissions and may award XR Accolades for standout work in specialized areas.
                  </p>
                  <p>
                    These accolades recognize excellence in specific types of work within the category and can be awarded 
                    in addition to winning the main category award. You cannot apply directly for accolades, they are 
                    awarded at the judges' discretion based on the quality and specialization of your submission.
                  </p>
                </div>
                <div class="space-y-2">
                  {accoladesByType.map((group: any) => (
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                      <button
                        class="accordion-button w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between group"
                        type="button"
                      >
                        <div class="flex-1">
                          <h3 class="font-semibold text-gray-900">
                            {group.type.code} - {group.type.name}
                          </h3>
                          {group.type.description && (
                            <p class="text-sm text-gray-600 mt-1">{group.type.description}</p>
                          )}
                        </div>
                        <svg 
                          class="accordion-icon w-5 h-5 text-gray-500 transition-transform duration-200 flex-shrink-0 ml-4"
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                      <div 
                        class="accordion-content overflow-hidden transition-all duration-200"
                        style="max-height: 0;"
                      >
                        <div class="px-6 py-4 bg-white border-t border-gray-200">
                          {group.children && group.children.length > 0 ? (
                            <ul class="space-y-3">
                              {group.children.map((accolade: any) => (
                                <li class="flex items-start">
                                  <span class="text-[#4923EB] font-mono text-sm mr-3 flex-shrink-0">{accolade.code}</span>
                                  <div class="flex-1">
                                    <span class="font-medium text-gray-900">{accolade.name}</span>
                                    {accolade.description && (
                                      <p class="text-sm text-gray-600 mt-1">{accolade.description}</p>
                                    )}
                                  </div>
                                </li>
                              ))}
                            </ul>
                          ) : (
                            <p class="text-sm text-gray-500">No individual accolades available for this type.</p>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div class="mb-8">
              <a
                href="/categories/"
                class="text-blue-600 hover:text-blue-700 font-medium inline-flex items-center"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to all categories
              </a>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="lg:col-span-1">
            <div class="rounded-lg p-8" style="background-color: #0E1021;">
              {eventPhase.phase === 'nominations-open' ? (
                <>
                  <h3 class="text-lg font-bold text-white mb-4">
                    Judging Criteria & Eligibility
                  </h3>
                  <p class="text-gray-300 mb-6">
                    Download the Entry Kit to have a full breakdown of judging criteria.
                  </p>
                  <div class="space-y-4">
                    <a
                      href="/nominate/entry-kit/"
                      class="block w-full text-center text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                      style="background-color: #4923EB; color: #ffffff;"
                      onmouseover="this.style.backgroundColor='#3a1bbd'; this.style.color='#ffffff';"
                      onmouseout="this.style.backgroundColor='#4923EB'; this.style.color='#ffffff';"
                    >
                      Download Entry Kit
                    </a>
                    <a
                      href={ctaButton.href}
                      class="block w-full text-center text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                      style="background-color: #FF7733; color: #ffffff;"
                      onmouseover="this.style.backgroundColor='#ff6620'; this.style.color='#ffffff';"
                      onmouseout="this.style.backgroundColor='#FF7733'; this.style.color='#ffffff';"
                    >
                      {ctaButton.text}
                    </a>
                    {eventDetails?.nominations_close && (
                      <p class="text-gray-300 text-sm mt-3 text-left">
                        Deadline: {new Date(eventDetails.nominations_close).toLocaleDateString('en-GB', { 
                          day: '2-digit', 
                          month: 'long', 
                          year: 'numeric' 
                        })}
                      </p>
                    )}
                  </div>
                </>
              ) : eventPhase.phase === 'nominations-closed' || eventPhase.phase === 'finalists-announced' || eventPhase.phase === 'judging-period' ? (
                <>
                  <h3 class="text-lg font-bold text-white mb-4">
                    Nominations Closed for {eventDetails?.event_year || '2025'}
                  </h3>
                  <p class="text-gray-300 mb-6">
                    The nomination deadline has passed. Stay tuned for finalist announcements and secure your tickets to the awards ceremony.
                  </p>
                  <div class="space-y-4">
                    <a
                      href={ctaButton.href}
                      class="block w-full text-center text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                      style="background-color: #FF7733; color: #ffffff;"
                      onmouseover="this.style.backgroundColor='#ff6620'; this.style.color='#ffffff';"
                      onmouseout="this.style.backgroundColor='#FF7733'; this.style.color='#ffffff';"
                    >
                      {ctaButton.text}
                    </a>
                    <a
                      href={`/winners-and-finalists-${eventDetails?.event_year || '2025'}/`}
                      class="block w-full text-center text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                      style="background-color: #4923EB; color: #ffffff;"
                      onmouseover="this.style.backgroundColor='#3a1bbd'; this.style.color='#ffffff';"
                      onmouseout="this.style.backgroundColor='#4923EB'; this.style.color='#ffffff';"
                    >
                      View Finalists
                    </a>
                  </div>
                </>
              ) : eventPhase.phase === 'post-ceremony' ? (
                <>
                  <h3 class="text-lg font-bold text-white mb-4">
                    Awards Ceremony Complete
                  </h3>
                  <p class="text-gray-300 mb-6">
                    The {eventDetails?.event_year || '2025'} awards ceremony has concluded. Register your interest for next year's awards and stay updated on upcoming opportunities.
                  </p>
                  <div class="space-y-4">
                    <a
                      href={postCeremonyCTA.href}
                      class="block w-full text-center text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                      style="background-color: #FF7733; color: #ffffff;"
                      onmouseover="this.style.backgroundColor='#ff6620'; this.style.color='#ffffff';"
                      onmouseout="this.style.backgroundColor='#FF7733'; this.style.color='#ffffff';"
                    >
                      {postCeremonyCTA.text}
                    </a>
                  </div>
                </>
              ) : (
                <>
                  <h3 class="text-lg font-bold text-white mb-4">
                    Nominations Opening Soon
                  </h3>
                  <p class="text-gray-300 mb-6">
                    Nominations for the {eventDetails?.event_year || '2025'} XR Awards will open soon. Stay tuned for updates.
                  </p>
                  <div class="space-y-4">
                    <a
                      href="/about-xr-awards/"
                      class="block w-full text-center text-white px-6 py-3 rounded-lg font-semibold transition-colors"
                      style="background-color: #4923EB; color: #ffffff;"
                      onmouseover="this.style.backgroundColor='#3a1bbd'; this.style.color='#ffffff';"
                      onmouseout="this.style.backgroundColor='#4923EB'; this.style.color='#ffffff';"
                    >
                      Learn More
                    </a>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Previous Winners/Finalists Section -->
    {finalists && finalists.length > 0 && (
      <section class="py-16 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-12 text-center">
            {finalists.length === 1 ? 'Previous Winner' : 'Previous Winners'}
          </h2>
          <div class={`grid gap-8 ${
            finalists.length === 1 
              ? 'grid-cols-1 max-w-4xl mx-auto' 
              : finalists.length === 2 
              ? 'grid-cols-1 md:grid-cols-2' 
              : 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'
          }`}>
            {finalists.map((finalist) => (
              <div class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                {finalist.image_url && (
                  <div class="h-48 bg-gray-200 overflow-hidden">
                    <img
                      src={finalist.image_url}
                      alt={finalist.title}
                      class="w-full h-full object-cover object-center transition-transform duration-500 ease-out hover:scale-105"
                    />
                  </div>
                )}
                <div class="p-6">
                  {finalist.is_winner && (
                    <span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-3 py-1 rounded-full mb-3">
                      Winner {finalist.event_details?.event_year || ''}
                    </span>
                  )}
                  <h3 class="text-xl font-bold text-gray-900 mb-2">
                    {finalist.title}
                  </h3>
                  {finalist.organization && (
                    <p class="text-gray-600 mb-3 font-medium">
                      {finalist.organization}
                    </p>
                  )}
                  {finalist.description && (
                    <div class="text-gray-600 text-sm prose prose-sm max-w-none">
                      <div set:html={nl2br(finalist.description)} />
                    </div>
                  )}
                  {finalist.website_url && (
                    <a
                      href={finalist.website_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:text-blue-700 text-sm font-medium mt-3 inline-block"
                    >
                      Learn more â†’
                    </a>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Related Case Studies -->
    {categoryCaseStudies.length > 0 && (
      <section class="py-16 bg-white">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-12 text-center">
            Related Case Studies
          </h2>
          <div class={`grid gap-8 ${
            categoryCaseStudies.length === 1
              ? 'grid-cols-1 max-w-lg mx-auto'
              : categoryCaseStudies.length === 2
              ? 'grid-cols-1 md:grid-cols-2'
              : 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'
          }`}>
            {categoryCaseStudies.map((article) => (
              <ArticleCard article={article} />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Explore Other Categories -->
    {otherCategories && otherCategories.length > 0 && (
      <section class="py-16" style="background-color: #F2F2F2;">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="explore-categories-title font-bold text-gray-900">
            Explore Other Categories
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {otherCategories.map((cat) => (
              <a
                href={`/categories/${cat.slug}/`}
                class="category-card-item rounded-lg px-8 pt-6 pb-5 hover:shadow-xl group block relative overflow-hidden"
              >
                <h3 class="text-xl font-bold text-white mb-2">
                  {cat.name}
                </h3>
                <div class="flex items-center gap-2">
                  <span class="text-white text-sm font-medium">
                    Explore Category
                  </span>
                  <div class="flex items-center justify-center w-7 h-7 rounded-full bg-white/20 group-hover:bg-white/30 transition-colors flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17L17 7M17 7H7M17 7V17" />
                    </svg>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- CTA Section -->
    <CTAFooter />
  </main>

  <Footer />
</Layout>

<style>
  .category-title {
    font-size: 35px;
    font-weight: 600;
  }

  .category-subtitle {
    font-size: 16px;
    font-weight: 300;
    font-family: "IBM Plex Mono", monospace;
  }

  .category-overview-title {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }
  
  .explore-categories-title {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 3rem;
  }

  .category-description-text {
    font-size: 16px;
    font-weight: 500;
    line-height: 1.6;
    color: #000;
  }

  .category-description-text p {
    font-size: 16px;
    font-weight: 500;
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .category-card-item {
    background: linear-gradient(135deg, #4A1B5C 0%, #3A1447 100%);
    min-height: 130px;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease, box-shadow 0.3s ease !important;
    text-decoration: none !important;
    position: relative;
    z-index: 1;
  }

  .category-card-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #5A2B6C 0%, #4A1857 100%);
    border-radius: inherit;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: -1;
  }

  .category-card-item:hover {
    transform: translateY(-2px);
  }

  .category-card-item:hover::before {
    opacity: 1;
  }

  .category-card-item .flex.items-center.justify-center {
    transition: transform 0.3s ease;
  }

  .category-card-item:hover .flex.items-center.justify-center {
    transform: rotate(45deg);
  }

  .accordion-icon {
    transition: transform 0.2s ease;
    transform: rotate(-90deg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const accordionButtons = document.querySelectorAll('.accordion-button');
    
    accordionButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const content = button.nextElementSibling as HTMLElement;
        const icon = button.querySelector('.accordion-icon') as HTMLElement;
        
        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
          content.style.maxHeight = '0';
          icon.style.transform = 'rotate(-90deg)';
        } else {
          content.style.maxHeight = content.scrollHeight + 'px';
          icon.style.transform = 'rotate(0deg)';
        }
      });
    });
  });
</script>
