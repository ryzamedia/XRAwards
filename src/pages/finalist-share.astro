---
/**
 * Media & Assets page for finalists and winners
 * URL: /finalist-share
 * Download crests, shareable images, and social media assets for finalists and winners
 */
export const prerender = true;

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CTAFooter from '../components/CTAFooter.astro';
import { Image } from 'astro:assets';
import { getR2ImageUrl, getOptimizedR2Image } from '../utils/r2';
import { supabase } from '../utils/supabase';
import { getEventPhase } from '../utils/date-checker';

// Fetch active event details
const { data: eventDetails, error: eventError } = await supabase
  .from('event_details')
  .select('*')
  .eq('is_active', true)
  .single();

// Get current event phase
const eventPhase = await getEventPhase();

// Get all available event years for the dropdown
const { data: allEvents, error: eventsError } = await supabase
  .from('event_details')
  .select('event_year')
  .order('event_year', { ascending: false });

const availableYears = (allEvents?.map(e => e.event_year) || []).filter(year => year >= 2024);
if (eventDetails?.event_year && eventDetails.event_year >= 2024 && !availableYears.includes(eventDetails.event_year)) {
  availableYears.unshift(eventDetails.event_year);
}

// Get finalists for all events (we'll filter by year in the frontend)
let finalists = [];
const { data: finalistsData, error: finalistsError } = await supabase
  .from('finalists')
  .select(`
    id,
    title,
    organization,
    image_url,
    description,
    category_id,
    is_winner,
    event_id,
    categories!category_id (
      name,
      slug,
      category_tags (
        tag_id,
        tags (
          id,
          name,
          slug
        )
      )
    ),
    finalist_accolades!finalist_id (
      accolade_id,
      accolades!accolade_id (
        id,
        code,
        name,
        description
      )
    ),
    event_details!event_id (
      event_year
    )
  `)
  .order('title', { ascending: true });

if (finalistsError) {
  console.error('Error fetching finalists:', finalistsError);
} else {
  finalists = finalistsData || [];
}

// Get the logo images for the social share card
const logoUrl = getR2ImageUrl('/images/2025/12/xra-logo_1765616281600.png');
const euLogoUrl = getR2ImageUrl('/images/2025/12/european-xr-awards-logo_1765616346565.png');

// Product images for purchase CTAs
const trophyImageUrl = getR2ImageUrl('/images/2025/10/xr-awards-main-trophy-design_1760351347176.png');
const accoladesImageUrl = getR2ImageUrl('/images/2025/10/xr-awards-accolades-tropy-design_1760351357634.png');

// Category tag IDs
const EU_CATEGORY_ID = 'bf2511f3-267e-4acb-ba79-a6003f715fe3';
const CROSS_CATEGORY_ID = '348b57c4-66af-4601-a424-499f7497f53f';


// Get the base crest images with R2 URLs
const crestConfigs = {
  default: {
    baseImageBlack: getR2ImageUrl('/images/2025/12/xra-winner_crests-252_1765577014221.png'),
    baseImageWhite: getR2ImageUrl('/images/2025/12/xra-winner_crests-253_1765577030174.png')
  },
  eu: {
    baseImageBlack: getR2ImageUrl('/images/2025/12/xra-winner_crests-eu-252_1765658549691.png'),
    baseImageWhite: getR2ImageUrl('/images/2025/12/xra-winner_crests-eu-253_1765658563271.png')
  },
  shared: {
    baseImageBlack: getR2ImageUrl('/images/2025/12/xra-shared-winner_crests-252_1765658372395.png'),
    baseImageWhite: getR2ImageUrl('/images/2025/12/xra-shared-winner_crests-253_1765658391928.png')
  }
};

// Ensure we have valid data - if not, provide empty defaults
const safeEventDetails = eventDetails || null;
const safeFinalists = finalists || [];
---

<Layout
  title="Media & Assets - Finalists & Winners - AIXR XR Awards"
  description="Download media assets, crests, and shareable images for XR Awards finalists and winners. Generate social media content and press release templates."
>
  <Header />

  <main class="min-h-screen bg-white">
    <!-- Page Header -->
    <section class="relative bg-[#0E1022] pt-32 md:pt-40 pb-20 md:pb-32 overflow-hidden">
      <!-- Decorative Background Rings -->
      <div class="absolute -left-20 md:left-0 top-1/4 -translate-y-1/2 -translate-x-1/2 w-[300px] h-[300px] md:w-[450px] md:h-[450px]">
        <div class="absolute inset-0 rounded-full" style="background: linear-gradient(180deg, #E91E8C 0%, #5D1635 100%);"></div>
        <div class="absolute top-[55px] left-[55px] right-[55px] bottom-[55px] md:top-[75px] md:left-[75px] md:right-[75px] md:bottom-[75px] rounded-full bg-[#0E1022]"></div>
      </div>
      <div class="absolute -right-20 md:right-0 top-3/4 -translate-y-1/2 translate-x-1/2 w-[300px] h-[300px] md:w-[450px] md:h-[450px]">
        <div class="absolute inset-0 rounded-full" style="background: linear-gradient(180deg, #00D4D8 0%, #0A4B52 100%);"></div>
        <div class="absolute top-[55px] left-[55px] right-[55px] bottom-[55px] md:top-[75px] md:left-[75px] md:right-[75px] md:bottom-[75px] rounded-full bg-[#0E1022]"></div>
      </div>

      <!-- Content -->
      <div class="relative z-10 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="page-title text-white mb-6">
          Media & Assets
        </h1>

        <!-- Decorative Dots -->
        <div class="flex justify-center gap-2 mb-6">
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span>
        </div>

        <p class="page-subtitle text-white mb-8">
          Download crests, shareable images, and social media assets for finalists and winners
        </p>

        <!-- Search Section -->
        <div class="max-w-2xl mx-auto mt-8">
          <div class="relative">
            <div class="flex flex-col sm:flex-row gap-3">
              <!-- Year Dropdown -->
              <div class="flex-shrink-0">
                <select 
                  id="year-select"
                  class="w-full sm:w-auto min-w-[120px] px-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-cyan-400 focus:border-transparent appearance-none cursor-pointer"
                  style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27white%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpath d=%27M6 9l6 6 6-6%27/%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.25rem; padding-right: 2.5rem;"
                >
                  <!-- Options will be populated by JavaScript -->
                </select>
              </div>
              
              <!-- Search Input -->
              <div class="flex-1 relative">
                <input 
                  type="text" 
                  id="finalist-search" 
                  placeholder="Type at least 3 characters to search finalists..."
                  class="w-full px-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg text-white placeholder-white/60 focus:ring-2 focus:ring-cyan-400 focus:border-transparent focus:outline-none"
                  autocomplete="off"
                />
                <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-white/60 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Search Results Dropdown (outside section to avoid clipping) -->
    <div id="finalists-list" class="fixed bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-y-auto z-[100] hidden">
      <!-- Results will be populated here -->
    </div>

    <!-- Empty State - Shows when no finalist selected -->
    <section id="empty-state" class="py-20 md:py-32 bg-white">
      <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-center text-center">
        <!-- Icon -->
        <div class="mb-8">
          <div class="flex items-center justify-center w-24 h-24 rounded-full bg-gray-50 border-2 border-dashed border-gray-200">
            <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
        </div>
        
        <!-- Message -->
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Select a Finalist</h2>
        <p class="text-sm text-gray-500 mb-8 max-w-md leading-relaxed">
          Use the search above to find a finalist or winner, then generate shareable media assets, crests, and social media copy.
        </p>
        
        <!-- Visual hint arrow pointing up -->
        <svg class="w-6 h-6 text-gray-300 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
      </div>
    </section>

    <!-- Main Tool Section -->
    <section id="main-tool-section" class="py-8 md:py-12 bg-white hidden">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
          <!-- Left: Preview Images -->
          <div class="space-y-6">
            <!-- Preview Section -->
            <div class="space-y-6">
              <h3 class="text-xl font-semibold text-gray-900">Social Media Preview</h3>
              
              <!-- Image Preview -->
              <div class="relative bg-gray-900 rounded-2xl shadow-lg overflow-hidden">
                <div id="finalist-preview" class="relative bg-gray-900 aspect-ratio-container" data-ratio="square">
                  <!-- Placeholder when no finalist selected -->
                  <div id="preview-placeholder" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-center">
                      <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <p class="text-gray-500">Select a finalist to see preview</p>
                    </div>
                  </div>
                  
                  <!-- Finalist image container -->
                  <div id="finalist-image-container" class="absolute inset-0 hidden">
                    <!-- Finalist image will be loaded here -->
                  </div>
                  
                </div>
              </div>
              
              <!-- Aspect Ratio Selection -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Aspect Ratio</label>
                <div class="flex gap-2">
                  <button 
                    type="button"
                    class="aspect-ratio-btn flex-1 px-3 py-2 text-sm font-medium rounded-lg border-2 transition-colors"
                    data-ratio="square"
                  >
                    <span class="block text-xs text-gray-500 mb-0.5">Square</span>
                    <span class="block font-semibold">1:1</span>
                  </button>
                  <button 
                    type="button"
                    class="aspect-ratio-btn flex-1 px-3 py-2 text-sm font-medium rounded-lg border-2 transition-colors"
                    data-ratio="landscape"
                  >
                    <span class="block text-xs text-gray-500 mb-0.5">Landscape</span>
                    <span class="block font-semibold">16:9</span>
                  </button>
                  <button 
                    type="button"
                    class="aspect-ratio-btn flex-1 px-3 py-2 text-sm font-medium rounded-lg border-2 transition-colors"
                    data-ratio="portrait"
                  >
                    <span class="block text-xs text-gray-500 mb-0.5">Portrait</span>
                    <span class="block font-semibold">9:16</span>
                  </button>
                </div>
              </div>
              
              <!-- Download Button -->
              <button 
                id="download-btn"
                class="w-full px-6 py-3 bg-[#4923EB] text-white font-medium rounded-lg hover:bg-[#3a1bb8] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Download Image
              </button>
            </div>

          </div>

          <!-- Right: Selected Entry Info + Crests -->
          <div class="space-y-6">
            <!-- Selected Entry Info -->
            <div id="selected-finalist-info" class="bg-gray-50 rounded-lg p-4 hidden">
              <h3 class="font-semibold text-gray-900 mb-2">Selected Entry</h3>
              <div id="finalist-info-content">
                <!-- Content will be populated here -->
              </div>
              
              <!-- Thumbnail Selection -->
              <div id="thumbnail-selection" class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Custom Thumbnail (Optional)</h4>
                <div class="space-y-3">
                  <!-- Current thumbnail preview -->
                  <div id="current-thumbnail-preview" class="flex items-center space-x-3">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                      <img id="current-thumbnail-img" src="" alt="Current thumbnail" class="w-full h-full object-cover" />
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="text-sm text-gray-600">Using original finalist image</p>
                      <p class="text-xs text-gray-500">Click "Change Thumbnail" to select a different image</p>
                    </div>
                  </div>
                  
                  <!-- File upload for custom thumbnail -->
                  <div id="thumbnail-upload-container" class="hidden">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                      <input 
                        type="file" 
                        id="thumbnail-file-input"
                        accept="image/png,image/jpeg,image/webp"
                        class="hidden"
                      />
                      <div id="upload-area" class="cursor-pointer">
                        <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-sm text-gray-600 mb-1">Click to upload a custom thumbnail</p>
                        <p class="text-xs text-gray-500">PNG, JPEG, or WebP • Max 10MB • 1:1 aspect ratio recommended</p>
                      </div>
                    </div>
                    
                    <!-- Uploaded file preview -->
                    <div id="uploaded-file-preview" class="mt-3 hidden">
                      <div class="flex items-center space-x-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="w-12 h-12 bg-green-100 rounded-lg overflow-hidden flex-shrink-0">
                          <img id="uploaded-thumbnail-preview" src="" alt="Uploaded thumbnail" class="w-full h-full object-cover" />
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-green-800">Custom thumbnail loaded</p>
                          <p id="uploaded-filename" class="text-xs text-green-600 truncate"></p>
                        </div>
                        <button 
                          type="button"
                          id="remove-uploaded-thumbnail"
                          class="text-red-500 hover:text-red-700 transition-colors"
                          title="Remove uploaded thumbnail"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Thumbnail controls -->
                  <div class="flex items-center space-x-2">
                    <button 
                      id="change-thumbnail-btn"
                      type="button"
                      class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      Change Thumbnail
                    </button>
                    <button 
                      id="reset-thumbnail-btn"
                      type="button"
                      class="px-3 py-2 text-sm bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors hidden"
                    >
                      Reset to Original
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Crests Section -->
    <section id="crests-section" class="py-8 md:py-12 bg-gray-50 hidden">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Downloadable Crests</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Left: Crests -->
          <div class="space-y-4">
            <!-- Finalist Crests Section -->
            <div id="finalist-crests-section" class="hidden">
              <div id="finalist-crests-container" class="space-y-4">
                <!-- Finalist crests will be generated here -->
              </div>
            </div>

            <!-- Winner Crests Section -->
            <div id="winner-crests-section" class="hidden">
              <div id="winner-crests-container" class="space-y-4">
                <!-- Winner crests will be generated here -->
              </div>
            </div>

            <!-- Accolade Crests Section -->
            <div id="accolade-crests-section" class="hidden">
              <div id="accolade-crests-container" class="space-y-4">
                <!-- Accolade crests will be generated here -->
              </div>
            </div>
          </div>

          <!-- Right: Usage Guidelines -->
          <div class="space-y-6">
            <!-- How to Best Use Your Crest -->
            <div>
              <h3 class="text-lg font-bold text-gray-900 mb-4">How to Best Use Your Crest</h3>
              <ul class="text-base text-gray-600 space-y-3 list-disc list-outside ml-8">
                <li><span class="font-medium text-gray-800">Display It Online:</span> Add to your website's About page, homepage, or project portfolios.</li>
                <li><span class="font-medium text-gray-800">Email Signature:</span> Include in your emails as a subtle reminder of your expertise.</li>
                <li><span class="font-medium text-gray-800">XR Storefronts:</span> Feature on Meta, Pico, and Steam store pages.</li>
                <li><span class="font-medium text-gray-800">Presentations:</span> Include in pitch decks, slideshows, or proposals.</li>
              </ul>
            </div>

            <!-- Approved & Disapproved Uses -->
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-green-50 rounded-lg p-4">
                <p class="text-sm font-semibold text-green-800 mb-3">Approved uses:</p>
                <ul class="text-base text-green-700 space-y-1.5">
                  <li>✓ Product store pages</li>
                  <li>✓ Email signatures</li>
                  <li>✓ Professional proposals</li>
                  <li>✓ Social profiles</li>
                  <li>✓ Your website</li>
                </ul>
              </div>
              <div class="bg-red-50 rounded-lg p-4">
                <p class="text-sm font-semibold text-red-800 mb-3">Disapproved uses:</p>
                <ul class="text-base text-red-700 space-y-1.5">
                  <li>✗ Modifying the logo</li>
                  <li>✗ Stretching or distorting</li>
                  <li>✗ Breaking brand guidelines</li>
                  <li>✗ Payment/login screens</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Physical Awards Purchase Section -->
    <section id="purchase-section" class="py-8 md:py-12 bg-gray-50 hidden">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Order Physical Awards</h2>
        
        <!-- Two-column grid layout (when both cards shown) -->
        <div id="purchase-cards-grid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Trophy Card Grid Version -->
          <div id="trophy-card-grid" class="hidden bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="aspect-square bg-gray-50 overflow-hidden">
              <img src={trophyImageUrl} alt="XR Awards Trophy" class="w-full h-full object-cover object-left" loading="lazy" />
            </div>
            <div class="p-5 bg-[#0E1022] text-left">
              <h3 class="text-base font-semibold text-white mb-2">Duplicate Trophy</h3>
              <p class="text-sm text-gray-300 mb-4 leading-relaxed">
                Want another trophy for your office or team? Each trophy is 100% custom made to order, fully handmade and machined in the UK.
              </p>
              <ul class="text-xs text-gray-400 space-y-1 mb-4">
                <li>• Only for Award Category Winners</li>
                <li>• Manufacturing & insurance included</li>
              </ul>
              <div class="flex items-center justify-between pt-4 border-t border-gray-700">
                <div>
                  <span class="text-base font-bold text-white">£820</span>
                  <span class="text-xs text-gray-400 ml-1">+VAT</span>
                </div>
                <a 
                  href="https://buy.stripe.com/00w9AU99o28E7HdaEAa7C0g"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-[#4923EB] text-white text-sm font-medium rounded-lg hover:bg-[#3a1bb8] transition-colors"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Order Now
                </a>
              </div>
            </div>
          </div>
          
          <!-- Accolade Card Grid Version -->
          <div id="accolade-card-grid" class="hidden bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="aspect-square bg-gray-50 overflow-hidden">
              <img src={accoladesImageUrl} alt="XR Accolade Award" class="w-full h-full object-cover" loading="lazy" />
            </div>
            <div class="p-5 bg-[#0E1022]">
              <h3 class="text-base font-semibold text-white mb-2">Physical Accolade</h3>
              <p class="text-sm text-gray-300 mb-4 leading-relaxed">
                Accolades are digital awards, but you can order a physical version to showcase your achievement. 100% solid metal, half the size of the main trophy.
              </p>
              <ul class="text-xs text-gray-400 space-y-1 mb-4">
                <li>• Only for Accolade Winners</li>
                <li>• Manufacturing & insurance included</li>
              </ul>
              <div class="flex items-center justify-between pt-4 border-t border-gray-700">
                <div>
                  <span class="text-base font-bold text-white">£395</span>
                  <span class="text-xs text-gray-400 ml-1">+VAT</span>
                </div>
                <a 
                  href="https://buy.stripe.com/aFa7sMgBQ7sYaTp4gca7C0h"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-[#4923EB] text-white text-sm font-medium rounded-lg hover:bg-[#3a1bb8] transition-colors"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Order Now
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Full-width horizontal layout (when single card shown) -->
        <!-- Trophy Full Width -->
        <div id="trophy-card-full" class="hidden bg-white rounded-xl border border-gray-200 overflow-hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-0">
            <div class="bg-gray-50 overflow-hidden min-h-[300px] md:min-h-[400px]">
              <img src={trophyImageUrl} alt="XR Awards Trophy" class="w-full h-full object-cover object-left" loading="lazy" />
            </div>
            <div class="p-6 md:p-8 flex flex-col justify-center bg-[#0E1022] text-left">
              <h3 class="text-xl font-semibold text-white mb-3">Duplicate Trophy</h3>
              <p class="text-sm text-gray-300 mb-4 leading-relaxed">
                Want another trophy for your office or team? Each trophy is 100% custom made to order, fully handmade and machined in the UK. A perfect keepsake to celebrate your achievement.
              </p>
              <ul class="text-sm text-gray-400 space-y-2 mb-6">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Only for Award Category Winners
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Fully handmade and machined in the UK
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Manufacturing & insurance included
                </li>
              </ul>
              <div class="flex items-center gap-4 pt-4 border-t border-gray-700">
                <div>
                  <span class="text-lg font-bold text-white">£820</span>
                  <span class="text-xs text-gray-400 ml-1">+VAT</span>
                </div>
                <a 
                  href="https://buy.stripe.com/00w9AU99o28E7HdaEAa7C0g"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-5 py-2.5 bg-[#4923EB] text-white text-sm font-medium rounded-lg hover:bg-[#3a1bb8] transition-colors"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Order Now
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Accolade Full Width -->
        <div id="accolade-card-full" class="hidden bg-white rounded-xl border border-gray-200 overflow-hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-0">
            <div class="bg-gray-50 overflow-hidden min-h-[300px] md:min-h-[400px]">
              <img src={accoladesImageUrl} alt="XR Accolade Award" class="w-full h-full object-cover" loading="lazy" />
            </div>
            <div class="p-6 md:p-8 flex flex-col justify-center bg-[#0E1022]">
              <h3 class="text-xl font-semibold text-white mb-3">Physical Accolade</h3>
              <p class="text-sm text-gray-300 mb-4 leading-relaxed">
                Accolades are digital awards, but you can order a physical version to showcase your achievement. 100% solid metal, half the size of the main trophy, it's a perfect keepsake for your desk or office.
              </p>
              <ul class="text-sm text-gray-400 space-y-2 mb-6">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Only for Accolade Winners
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Fully handmade and machined in the UK
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Manufacturing & insurance included
                </li>
              </ul>
              <div class="flex items-center gap-4 pt-4 border-t border-gray-700">
                <div>
                  <span class="text-lg font-bold text-white">£395</span>
                  <span class="text-xs text-gray-400 ml-1">+VAT</span>
                </div>
                <a 
                  href="https://buy.stripe.com/aFa7sMgBQ7sYaTp4gca7C0h"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-5 py-2.5 bg-[#4923EB] text-white text-sm font-medium rounded-lg hover:bg-[#3a1bb8] transition-colors"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Order Now
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Social Media Copy Section -->
    <section id="social-copy-section" class="py-8 md:py-12 bg-white hidden">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="social-copy" class="hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Social Media Copy</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Twitter/X Copy -->
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-sm font-medium text-gray-700">Twitter/X</label>
                    <button 
                      id="share-twitter" 
                      class="flex items-center gap-1 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                      title="Share on Twitter/X"
                    >
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                      </svg>
                      Share
                    </button>
                  </div>
                  <div class="relative">
                    <textarea 
                      id="twitter-copy" 
                      readonly 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm resize-none"
                      rows="4"
                    ></textarea>
                    <button 
                      id="copy-twitter" 
                      class="absolute top-2 right-2 p-1 text-gray-500 hover:text-gray-700 transition-colors"
                      title="Copy to clipboard"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- LinkedIn Copy -->
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-sm font-medium text-gray-700">LinkedIn</label>
                    <button 
                      id="share-linkedin" 
                      class="flex items-center gap-1 px-2 py-1 text-xs bg-blue-700 text-white rounded hover:bg-blue-800 transition-colors"
                      title="Share on LinkedIn"
                    >
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                      </svg>
                      Share
                    </button>
                  </div>
                  <div class="relative">
                    <textarea 
                      id="linkedin-copy" 
                      readonly 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm resize-none"
                      rows="4"
                    ></textarea>
                    <button 
                      id="copy-linkedin" 
                      class="absolute top-2 right-2 p-1 text-gray-500 hover:text-gray-700 transition-colors"
                      title="Copy to clipboard"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- Instagram Copy -->
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-sm font-medium text-gray-700">Instagram</label>
                    <button 
                      id="share-instagram" 
                      class="flex items-center gap-1 px-2 py-1 text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded hover:from-purple-600 hover:to-pink-600 transition-colors"
                      title="Share on Instagram"
                    >
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                      </svg>
                      Share
                    </button>
                  </div>
                  <div class="relative">
                    <textarea 
                      id="instagram-copy" 
                      readonly 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm resize-none"
                      rows="4"
                    ></textarea>
                    <button 
                      id="copy-instagram" 
                      class="absolute top-2 right-2 p-1 text-gray-500 hover:text-gray-700 transition-colors"
                      title="Copy to clipboard"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- Press Release Template -->
                <div class="md:col-span-2">
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-sm font-medium text-gray-700">Press Release Template</label>
                    <div class="flex gap-1">
                      <button 
                        id="download-press-release" 
                        class="flex items-center gap-1 px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                        title="Download as .txt file"
                      >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Download
                      </button>
                    </div>
                  </div>
                  <div class="relative">
                    <textarea 
                      id="press-release-copy" 
                      readonly 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm resize-none"
                      rows="12"
                    ></textarea>
                    <button 
                      id="copy-press-release" 
                      class="absolute top-2 right-2 p-1 text-gray-500 hover:text-gray-700 transition-colors"
                      title="Copy to clipboard"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <CTAFooter />
  </main>

  <Footer />
</Layout>

<!-- Import utilities -->
<script>
  import { 
    generateAccoladeCrest, 
    generateWinnerCrest,
    generateFinalistCrest,
    wrapText, 
    cleanupBlobUrls,
    getCrestConfigForTags
  } from '../utils/crest-generator';
  import { 
    generateSocialCopy, 
    getShareUrl, 
    getInstagramShareText 
  } from '../utils/social-copy-generator';
  import { 
    generateFinalistImage, 
    downloadImage, 
    sanitizeFilename, 
    revokeBlobUrl, 
    getProxyImageUrl 
  } from '../utils/finalist-image-generator';
  
  // Expose to window for use by the main script
  (window as any).CrestGenerator = {
    generateAccoladeCrest,
    generateWinnerCrest,
    generateFinalistCrest,
    wrapText,
    cleanupBlobUrls,
    getCrestConfigForTags
  };
  (window as any).SocialCopyGenerator = {
    generateSocialCopy,
    getShareUrl,
    getInstagramShareText
  };
  (window as any).FinalistImageGenerator = {
    generateFinalistImage,
    downloadImage,
    sanitizeFilename,
    revokeBlobUrl,
    getProxyImageUrl
  };
</script>

<script define:vars={{ finalists: safeFinalists, logoUrl, euLogoUrl, EU_CATEGORY_ID, CROSS_CATEGORY_ID, eventDetails: safeEventDetails, crestConfigs, availableYears }}>
  document.addEventListener('astro:page-load', () => {
    // DOM Elements
    const searchInput = document.getElementById('finalist-search');
    const yearSelect = document.getElementById('year-select');
    const finalistsList = document.getElementById('finalists-list');
    const selectedFinalistInfo = document.getElementById('selected-finalist-info');
    const finalistInfoContent = document.getElementById('finalist-info-content');
    const previewPlaceholder = document.getElementById('preview-placeholder');
    const finalistImageContainer = document.getElementById('finalist-image-container');
    const downloadBtn = document.getElementById('download-btn');
    const socialCopy = document.getElementById('social-copy');
    const twitterCopy = document.getElementById('twitter-copy');
    const linkedinCopy = document.getElementById('linkedin-copy');
    const instagramCopy = document.getElementById('instagram-copy');
    const pressReleaseCopy = document.getElementById('press-release-copy');
    
    // Thumbnail elements
    const thumbnailSelection = document.getElementById('thumbnail-selection');
    const currentThumbnailPreview = document.getElementById('current-thumbnail-preview');
    const currentThumbnailImg = document.getElementById('current-thumbnail-img');
    const thumbnailUploadContainer = document.getElementById('thumbnail-upload-container');
    const thumbnailFileInput = document.getElementById('thumbnail-file-input');
    const uploadArea = document.getElementById('upload-area');
    const uploadedFilePreview = document.getElementById('uploaded-file-preview');
    const uploadedThumbnailPreview = document.getElementById('uploaded-thumbnail-preview');
    const uploadedFilename = document.getElementById('uploaded-filename');
    const removeUploadedThumbnail = document.getElementById('remove-uploaded-thumbnail');
    const changeThumbnailBtn = document.getElementById('change-thumbnail-btn');
    const resetThumbnailBtn = document.getElementById('reset-thumbnail-btn');

    // State
    let selectedFinalist = null;
    let allFinalists = [];
    let filteredFinalists = [];
    let customThumbnailFile = null;
    let customThumbnailUrl = null;
    let currentBlobUrl = null;
    let selectedAspectRatio = 'square'; // 'square', 'landscape', 'portrait'

    // Get utilities from window
    const CrestGenerator = window.CrestGenerator;
    const SocialCopyGenerator = window.SocialCopyGenerator;
    const FinalistImageGenerator = window.FinalistImageGenerator;

    // Initialize year dropdown
    function initializeYearDropdown() {
      if (!yearSelect || !availableYears || availableYears.length === 0) return;
      
      const defaultYear = eventDetails?.event_year || availableYears[0];
      
      yearSelect.innerHTML = availableYears.map(year => 
        `<option value="${year}" ${year === defaultYear ? 'selected' : ''} style="background-color: white; color: #0E1022;">${year}</option>`
      ).join('');
      
      // Trigger filter when year changes
      yearSelect.addEventListener('change', () => {
        // Update URL with year
        const finalistId = selectedFinalist ? selectedFinalist.id : null;
        updateURL(finalistId, yearSelect.value);
        
        if (searchInput.value.length >= 3) {
          filterFinalists(searchInput.value.toLowerCase());
        } else {
          clearResults();
        }
      });
    }

    // Initialize aspect ratio buttons
    function initializeAspectRatioButtons() {
      const buttons = document.querySelectorAll('.aspect-ratio-btn');
      const previewContainer = document.getElementById('finalist-preview');
      
      // Set initial active state
      buttons.forEach(btn => {
        const ratio = btn.getAttribute('data-ratio');
        if (ratio === selectedAspectRatio) {
          btn.classList.add('active');
        }
        
        btn.addEventListener('click', () => {
          // Update active state
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Update selected ratio
          selectedAspectRatio = ratio;
          
          // Update preview container aspect ratio
          if (previewContainer) {
            previewContainer.setAttribute('data-ratio', ratio);
          }
          
          // Regenerate preview with new aspect ratio
          if (selectedFinalist) {
            updatePreview();
          }
        });
      });
    }

    // Initialize finalists data
    function initializeFinalists() {
      allFinalists = finalists?.map((finalist) => {
        // Extract tag IDs from category_tags
        const categoryTags = finalist.categories?.category_tags || [];
        const tagIds = categoryTags.map((ct) => ct.tag_id).filter(Boolean);
        
        return {
          id: finalist.id,
          title: finalist.title || 'Untitled',
          organization: finalist.organization || '',
          image: finalist.image_url ? FinalistImageGenerator.getProxyImageUrl(finalist.image_url) : '',
          description: finalist.description || '',
          category: finalist.categories ? finalist.categories.name : '',
          categoryId: finalist.category_id || null,
          tagIds: tagIds,
          accolades: (finalist.finalist_accolades || []).map((fa) => fa.accolades).filter(Boolean),
          isWinner: finalist.is_winner || false,
          eventYear: finalist.event_details?.event_year || null
        };
      }) || [];
    }

    // Search functionality
    searchInput?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      if (searchTerm.length >= 3) {
        filterFinalists(searchTerm);
      } else {
        clearResults();
      }
    });

    function clearResults() {
      if (!finalistsList) return;
      finalistsList.innerHTML = '';
      finalistsList.classList.add('hidden');
      filteredFinalists = [];
    }

    function filterFinalists(searchTerm) {
      if (!yearSelect) return;
      
      const selectedYear = parseInt(yearSelect.value);
      
      filteredFinalists = allFinalists.filter(f => {
        // Filter by year first
        if (f.eventYear !== selectedYear) return false;
        
        // Then filter by search term
        const title = f.title?.toLowerCase() || '';
        const organization = f.organization?.toLowerCase() || '';
        const category = f.category?.toLowerCase() || '';
        return title.includes(searchTerm) || organization.includes(searchTerm) || category.includes(searchTerm);
      });
      
      renderFinalistsList();
    }

    function positionDropdown() {
      if (!finalistsList || !searchInput) return;
      
      const searchRect = searchInput.getBoundingClientRect();
      const searchContainer = searchInput.closest('.max-w-2xl');
      const containerRect = searchContainer?.getBoundingClientRect();
      
      if (containerRect) {
        finalistsList.style.top = `${searchRect.bottom + 8}px`;
        finalistsList.style.left = `${containerRect.left}px`;
        finalistsList.style.width = `${containerRect.width}px`;
      }
    }

    function renderFinalistsList() {
      if (!finalistsList) return;
      
      if (filteredFinalists.length === 0) {
        finalistsList.innerHTML = '<div class="px-4 py-8 text-center text-gray-500">No finalists found matching your search</div>';
        positionDropdown();
        finalistsList.classList.remove('hidden');
      } else {
        finalistsList.innerHTML = filteredFinalists.map((f) => `
          <div class="finalist-item px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors" data-finalist-id="${f.id}">
            <div class="flex items-start justify-between">
              <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-900 truncate">${f.title}</div>
                ${f.organization ? `<div class="text-sm text-[#4923EB] truncate">${f.organization}</div>` : ''}
                ${f.category ? `<div class="text-xs text-gray-500 uppercase mt-1">${f.category}</div>` : ''}
              </div>
              <div class="ml-3 flex-shrink-0">
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        positionDropdown();
        finalistsList.classList.remove('hidden');
      }
    }

    // Handle click on finalist items
    finalistsList?.addEventListener('click', (e) => {
      const item = e.target.closest('.finalist-item');
      if (item) selectFinalist(item);
    });

    function updateURL(finalistId, year) {
      const url = new URL(window.location.href);
      if (finalistId) {
        url.searchParams.set('finalist', finalistId);
      } else {
        url.searchParams.delete('finalist');
      }
      if (year) {
        url.searchParams.set('year', year);
      }
      window.history.pushState({}, '', url);
    }

    function selectFinalist(element) {
      const finalistId = element.getAttribute('data-finalist-id');
      const finalist = allFinalists.find(f => f.id === finalistId);
      if (!finalist) return;
      
      selectedFinalist = { ...finalist };
      searchInput.value = selectedFinalist.title || '';
      
      // Update URL
      const selectedYear = yearSelect ? yearSelect.value : null;
      updateURL(finalistId, selectedYear);
      
      // Close the dropdown
      if (finalistsList) {
        finalistsList.classList.add('hidden');
      }
      
      // Hide empty state and show main content
      hideEmptyState();
      
      updatePreview();
      updateSelectedInfo();
      updateSocialCopy();
      enableDownload();
      updateThumbnailPreview();
      updateFinalistCrests();
      updateAccoladeCrests();
      updateWinnerCrests();
      updatePurchaseSection();
    }

    function selectFinalistById(finalistId) {
      const finalist = allFinalists.find(f => f.id === finalistId);
      if (!finalist) return;
      
      // Set the year dropdown to match the finalist's year
      if (finalist.eventYear && yearSelect) {
        yearSelect.value = finalist.eventYear.toString();
      }
      
      selectedFinalist = { ...finalist };
      searchInput.value = selectedFinalist.title || '';
      
      // Hide empty state and show main content
      hideEmptyState();
      
      updatePreview();
      updateSelectedInfo();
      updateSocialCopy();
      enableDownload();
      updateThumbnailPreview();
      updateFinalistCrests();
      updateAccoladeCrests();
      updateWinnerCrests();
      updatePurchaseSection();
    }

    function loadFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const yearParam = urlParams.get('year');
      const finalistId = urlParams.get('finalist');
      
      // Set year if provided
      if (yearParam && yearSelect) {
        yearSelect.value = yearParam;
      }
      
      // Load finalist if provided
      if (finalistId && allFinalists.length > 0) {
        selectFinalistById(finalistId);
      }
    }

    function resetSelection() {
      FinalistImageGenerator.revokeBlobUrl(currentBlobUrl);
      currentBlobUrl = null;
      CrestGenerator?.cleanupBlobUrls(document.getElementById('finalist-crests-container'));
      CrestGenerator?.cleanupBlobUrls(document.getElementById('accolade-crests-container'));
      CrestGenerator?.cleanupBlobUrls(document.getElementById('winner-crests-container'));
      
      selectedFinalist = null;
      customThumbnailFile = null;
      customThumbnailUrl = null;
      
      // Reset aspect ratio to square
      selectedAspectRatio = 'square';
      const previewContainer = document.getElementById('finalist-preview');
      if (previewContainer) {
        previewContainer.setAttribute('data-ratio', 'square');
      }
      document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-ratio') === 'square');
      });
      
      // Show empty state and hide main content
      showEmptyState();
      
      showPlaceholder();
      hideSelectedInfo();
      hideSocialCopy();
      disableDownload();
      hideThumbnailSelection();
      
      document.getElementById('finalist-crests-section')?.classList.add('hidden');
      document.getElementById('accolade-crests-section')?.classList.add('hidden');
      document.getElementById('winner-crests-section')?.classList.add('hidden');
      purchaseSection?.classList.add('hidden');
    }

    async function updatePreview() {
      if (!selectedFinalist) {
        showPlaceholder();
        return;
      }

      hidePlaceholder();
      showImageContainer();

      if (!selectedFinalist.image) {
        showPlaceholder();
        return;
      }

      try {
        const imageToUse = customThumbnailUrl || selectedFinalist.image;
        
        // Determine which logo(s) to use based on category tags
        const tagIds = selectedFinalist.tagIds || [];
        const hasEuTag = tagIds.includes(EU_CATEGORY_ID);
        const hasCrossTag = tagIds.includes(CROSS_CATEGORY_ID);
        
        let primaryLogoUrl, secondaryLogoUrl;
        let isEuOnly = false;
        
        if (hasCrossTag) {
          // Cross category - both logos side by side
          primaryLogoUrl = FinalistImageGenerator.getProxyImageUrl(logoUrl);
          secondaryLogoUrl = FinalistImageGenerator.getProxyImageUrl(euLogoUrl);
        } else if (hasEuTag) {
          // EU category - only EU logo (bigger)
          primaryLogoUrl = FinalistImageGenerator.getProxyImageUrl(euLogoUrl);
          secondaryLogoUrl = undefined;
          isEuOnly = true;
        } else {
          // Default - main XR Awards logo
          primaryLogoUrl = FinalistImageGenerator.getProxyImageUrl(logoUrl);
          secondaryLogoUrl = undefined;
        }
        
        const result = await FinalistImageGenerator.generateFinalistImage({
          finalistImageUrl: imageToUse,
          logoUrl: primaryLogoUrl,
          secondLogoUrl: secondaryLogoUrl,
          isEuOnly: isEuOnly,
          title: selectedFinalist.title || '',
          organization: selectedFinalist.organization || '',
          category: selectedFinalist.category || '',
          isWinner: selectedFinalist.isWinner || false,
          year: selectedFinalist.eventYear?.toString() || eventDetails?.event_year?.toString() || '2025',
          size: 800,
          aspectRatio: selectedAspectRatio
        });

        // Cleanup old blob URL
        FinalistImageGenerator.revokeBlobUrl(currentBlobUrl);
        currentBlobUrl = result.blobUrl;

        // Create image element
        const img = document.createElement('img');
        img.src = result.blobUrl;
        img.alt = `${selectedFinalist.title} - Finalist Share Image`;
        img.className = 'w-full h-full object-cover';
        img.style.cursor = 'pointer';
        img.title = 'Right-click to download';
        
        img.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          FinalistImageGenerator.downloadImage(result.blobUrl, selectedFinalist.title, 'finalist_share', selectedAspectRatio);
        });
        
        finalistImageContainer.innerHTML = '';
        finalistImageContainer.appendChild(img);
      } catch (error) {
        console.error('Error generating preview:', error);
        showPlaceholder();
      }
    }

    function updateSelectedInfo() {
      if (!selectedFinalist) return;
      
      // Status badge (Winner or Finalist)
      const statusBadge = selectedFinalist.isWinner 
        ? `<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-yellow-400 text-yellow-900 rounded">Winner</span>`
        : `<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-gray-200 text-gray-700 rounded">Finalist</span>`;
      
      // Accolades display
      const accolades = selectedFinalist.accolades || [];
      const accoladesHtml = accolades.length > 0 
        ? `<div class="mt-3 pt-3 border-t border-gray-200">
            <p class="text-xs text-gray-500 uppercase mb-2">Accolades</p>
            <div class="flex flex-wrap gap-1.5">
              ${accolades.map(a => `<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-800 rounded">${a.name}</span>`).join('')}
            </div>
           </div>`
        : '';
      
      finalistInfoContent.innerHTML = `
        <div class="space-y-2">
          <div class="flex items-baseline gap-2 flex-wrap">
            <span class="font-semibold text-gray-900">${selectedFinalist.title || 'Untitled'}</span>
            ${statusBadge}
          </div>
          ${selectedFinalist.organization ? `<p class="text-sm text-[#4923EB]">${selectedFinalist.organization}</p>` : ''}
          ${selectedFinalist.category ? `<p class="text-xs text-gray-500 uppercase">${selectedFinalist.category}</p>` : ''}
          ${selectedFinalist.description ? `<p class="text-sm text-gray-600 mt-2 leading-relaxed">${selectedFinalist.description}</p>` : ''}
          ${accoladesHtml}
        </div>
      `;
      selectedFinalistInfo?.classList.remove('hidden');
    }

    function updateSocialCopy() {
      if (!selectedFinalist) return;

      const eventYear = selectedFinalist.eventYear || eventDetails?.event_year || '2025';
      const config = {
        eventYear,
        finalistName: selectedFinalist.title,
        category: selectedFinalist.category,
        organization: selectedFinalist.organization,
        description: selectedFinalist.description,
        eventName: eventDetails?.event_name || 'XR Awards',
        isWinner: selectedFinalist.isWinner || false
      };

      const copy = SocialCopyGenerator.generateSocialCopy(config);
      
      twitterCopy.value = copy.twitter;
      linkedinCopy.value = copy.linkedin;
      instagramCopy.value = copy.instagram;
      pressReleaseCopy.value = copy.pressRelease;
      
      showSocialCopy();
    }

    // UI State helpers
    const emptyState = document.getElementById('empty-state');
    const mainToolSection = document.getElementById('main-tool-section');
    const crestsSection = document.getElementById('crests-section');
    const socialCopySection = document.getElementById('social-copy-section');
    const purchaseSection = document.getElementById('purchase-section');
    const purchaseCardsGrid = document.getElementById('purchase-cards-grid');
    const trophyCardGrid = document.getElementById('trophy-card-grid');
    const accoladeCardGrid = document.getElementById('accolade-card-grid');
    const trophyCardFull = document.getElementById('trophy-card-full');
    const accoladeCardFull = document.getElementById('accolade-card-full');
    
    function showEmptyState() { 
      emptyState?.classList.remove('hidden'); 
      mainToolSection?.classList.add('hidden');
      crestsSection?.classList.add('hidden');
      socialCopySection?.classList.add('hidden');
      purchaseSection?.classList.add('hidden');
    }
    function hideEmptyState() { 
      emptyState?.classList.add('hidden'); 
      mainToolSection?.classList.remove('hidden');
      crestsSection?.classList.remove('hidden');
      socialCopySection?.classList.remove('hidden');
    }
    
    function updatePurchaseSection() {
      if (!selectedFinalist) {
        purchaseSection?.classList.add('hidden');
        return;
      }
      
      const isWinner = selectedFinalist.isWinner || false;
      const hasAccolades = (selectedFinalist.accolades || []).length > 0;
      
      // Hide all cards first
      purchaseCardsGrid?.classList.add('hidden');
      trophyCardGrid?.classList.add('hidden');
      accoladeCardGrid?.classList.add('hidden');
      trophyCardFull?.classList.add('hidden');
      accoladeCardFull?.classList.add('hidden');
      
      // Show section if winner or has accolades
      if (isWinner || hasAccolades) {
        purchaseSection?.classList.remove('hidden');
        
        if (isWinner && hasAccolades) {
          // Both: show grid layout with both cards
          purchaseCardsGrid?.classList.remove('hidden');
          trophyCardGrid?.classList.remove('hidden');
          accoladeCardGrid?.classList.remove('hidden');
        } else if (isWinner) {
          // Only winner: show full-width trophy card
          trophyCardFull?.classList.remove('hidden');
        } else if (hasAccolades) {
          // Only accolades: show full-width accolade card
          accoladeCardFull?.classList.remove('hidden');
        }
      } else {
        purchaseSection?.classList.add('hidden');
      }
    }
    function showPlaceholder() { previewPlaceholder?.classList.remove('hidden'); finalistImageContainer?.classList.add('hidden'); }
    function hidePlaceholder() { previewPlaceholder?.classList.add('hidden'); }
    function showImageContainer() { finalistImageContainer?.classList.remove('hidden'); }
    function hideSelectedInfo() { selectedFinalistInfo?.classList.add('hidden'); }
    function showSocialCopy() { socialCopy?.classList.remove('hidden'); }
    function hideSocialCopy() { socialCopy?.classList.add('hidden'); }
    function enableDownload() { downloadBtn.disabled = false; }
    function disableDownload() { downloadBtn.disabled = true; }
    function showThumbnailSelection() { thumbnailSelection?.classList.remove('hidden'); }
    function hideThumbnailSelection() { thumbnailSelection?.classList.add('hidden'); }
    function showThumbnailUpload() { thumbnailUploadContainer?.classList.remove('hidden'); changeThumbnailBtn?.classList.add('hidden'); }
    function hideThumbnailUpload() { thumbnailUploadContainer?.classList.add('hidden'); changeThumbnailBtn?.classList.remove('hidden'); }

    function updateThumbnailPreview() {
      if (!selectedFinalist) { hideThumbnailSelection(); return; }
      showThumbnailSelection();
      
      const thumbnailUrl = customThumbnailUrl || selectedFinalist.image;
      if (thumbnailUrl) {
        currentThumbnailImg.src = thumbnailUrl;
        currentThumbnailImg.alt = customThumbnailUrl ? 'Custom thumbnail' : 'Original finalist image';
      }
      
      const previewText = currentThumbnailPreview.querySelector('p');
      if (previewText) previewText.textContent = customThumbnailUrl ? 'Using custom thumbnail' : 'Using original finalist image';
      
      customThumbnailUrl ? resetThumbnailBtn?.classList.remove('hidden') : resetThumbnailBtn?.classList.add('hidden');
    }

    function handleFileUpload(file) {
      const allowedTypes = ['image/png', 'image/jpeg', 'image/webp'];
      if (!allowedTypes.includes(file.type)) { alert('Please select a PNG, JPEG, or WebP image file.'); return; }
      if (file.size > 10 * 1024 * 1024) { alert('File size must be less than 10MB.'); return; }

      if (customThumbnailUrl) URL.revokeObjectURL(customThumbnailUrl);

      customThumbnailFile = file;
      customThumbnailUrl = URL.createObjectURL(file);

      uploadedThumbnailPreview.src = customThumbnailUrl;
      uploadedFilename.textContent = file.name;
      uploadedFilePreview?.classList.remove('hidden');
      
      updateThumbnailPreview();
      updatePreview();
      hideThumbnailUpload();
    }

    function removeCustomThumbnail() {
      if (customThumbnailUrl) URL.revokeObjectURL(customThumbnailUrl);
      customThumbnailFile = null;
      customThumbnailUrl = null;
      uploadedFilePreview?.classList.add('hidden');
      updateThumbnailPreview();
      updatePreview();
    }

    // Download functionality
    downloadBtn?.addEventListener('click', () => {
      if (!selectedFinalist || !currentBlobUrl) { alert('Please wait for the image to load before downloading.'); return; }
      FinalistImageGenerator.downloadImage(currentBlobUrl, selectedFinalist.title, 'finalist_share', selectedAspectRatio);
    });

    // Copy button functionality
    function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!')).catch(() => fallbackCopyToClipboard(text));
      } else {
        fallbackCopyToClipboard(text);
      }
    }

    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy') ? alert('Copied to clipboard!') : alert('Failed to copy');
      } catch { alert('Failed to copy'); }
      document.body.removeChild(textArea);
    }

    document.getElementById('copy-twitter')?.addEventListener('click', () => copyToClipboard(twitterCopy.value));
    document.getElementById('copy-linkedin')?.addEventListener('click', () => copyToClipboard(linkedinCopy.value));
    document.getElementById('copy-instagram')?.addEventListener('click', () => copyToClipboard(instagramCopy.value));
    document.getElementById('copy-press-release')?.addEventListener('click', () => copyToClipboard(pressReleaseCopy.value));

    // Share button functionality
    function shareToSocial(platform) {
      if (!selectedFinalist) return;

      const eventYear = selectedFinalist.eventYear || eventDetails?.event_year || '2025';
      const config = { 
        eventYear, 
        finalistName: selectedFinalist.title, 
        category: selectedFinalist.category,
        isWinner: selectedFinalist.isWinner || false
      };
      
      if (platform === 'instagram') {
        const text = SocialCopyGenerator.getInstagramShareText(config);
        navigator.clipboard.writeText(text).then(() => {
          alert('Text copied to clipboard! You can now paste it in Instagram with your image.');
          window.open('https://www.instagram.com/', '_blank');
        });
        return;
      }

      const shareUrl = SocialCopyGenerator.getShareUrl(platform, config);
      if (shareUrl) window.open(shareUrl, '_blank', 'width=600,height=400,scrollbars=yes,resizable=yes');
    }

    document.getElementById('share-twitter')?.addEventListener('click', () => shareToSocial('twitter'));
    document.getElementById('share-linkedin')?.addEventListener('click', () => shareToSocial('linkedin'));
    document.getElementById('share-instagram')?.addEventListener('click', () => shareToSocial('instagram'));

    // Press release download
    document.getElementById('download-press-release')?.addEventListener('click', () => {
      if (!selectedFinalist) return;
      const filename = `${FinalistImageGenerator.sanitizeFilename(selectedFinalist.title)}_press_release.txt`;
      const blob = new Blob([pressReleaseCopy.value], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Thumbnail event listeners
    changeThumbnailBtn?.addEventListener('click', showThumbnailUpload);
    resetThumbnailBtn?.addEventListener('click', removeCustomThumbnail);
    uploadArea?.addEventListener('click', () => thumbnailFileInput?.click());
    thumbnailFileInput?.addEventListener('change', (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0]); });
    removeUploadedThumbnail?.addEventListener('click', removeCustomThumbnail);

    // Drag and drop
    uploadArea?.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('border-blue-400', 'bg-blue-50'); });
    uploadArea?.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('border-blue-400', 'bg-blue-50'); });
    uploadArea?.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
      if (e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files[0]);
    });

    // Function to get the correct crest config based on tags
    function getCrestConfig() {
      const tagIds = selectedFinalist?.tagIds || [];
      return CrestGenerator.getCrestConfigForTags(tagIds, crestConfigs);
    }

    async function updateFinalistCrests() {
      const container = document.getElementById('finalist-crests-container');
      const section = document.getElementById('finalist-crests-section');
      
      if (!container || !selectedFinalist) { section?.classList.add('hidden'); return; }
      
      // Only show finalist crest if NOT a winner
      if (selectedFinalist.isWinner) { section?.classList.add('hidden'); return; }

      section?.classList.remove('hidden');
      container.innerHTML = '<p class="text-sm text-gray-500 mb-4">Generating finalist crest...</p>';

      const eventYear = selectedFinalist.eventYear || eventDetails?.event_year || '2025';
      const projectName = selectedFinalist.title || '';
      const categoryName = selectedFinalist.category || '';

      try {
        const crestConfig = getCrestConfig();
        const [blackCrest, whiteCrest] = await Promise.all([
          CrestGenerator.generateFinalistCrest(categoryName, projectName, eventYear, 'black', crestConfig),
          CrestGenerator.generateFinalistCrest(categoryName, projectName, eventYear, 'white', crestConfig)
        ]);

        container.innerHTML = `
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="text-sm font-medium text-gray-700 mb-3">${categoryName} Finalist</h4>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <p class="text-xs text-gray-500 mb-1 text-center">Black Version</p>
                <div class="relative bg-gray-50 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                  <img src="${blackCrest}" alt="Finalist Crest (Black)" class="max-w-full h-auto object-contain" />
                </div>
                <button class="w-full px-3 py-1.5 bg-gray-800 text-white text-xs font-medium rounded-lg hover:bg-gray-900 transition-colors download-finalist-crest-btn" data-crest-url="${blackCrest}" data-variant="black">Download Black</button>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1 text-center">White Version</p>
                <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                  <img src="${whiteCrest}" alt="Finalist Crest (White)" class="max-w-full h-auto object-contain" />
                </div>
                <button class="w-full px-3 py-1.5 bg-gray-100 text-gray-800 text-xs font-medium rounded-lg hover:bg-gray-200 transition-colors download-finalist-crest-btn border border-gray-300" data-crest-url="${whiteCrest}" data-variant="white">Download White</button>
              </div>
            </div>
          </div>
        `;

        container.querySelectorAll('.download-finalist-crest-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const url = btn.getAttribute('data-crest-url');
            const variant = btn.getAttribute('data-variant');
            if (url) {
              const projectSlug = FinalistImageGenerator.sanitizeFilename(projectName);
              const a = document.createElement('a');
              a.href = url;
              a.download = `${projectSlug}_finalist_crest_${variant}_${eventYear}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          });
        });
      } catch (error) {
        console.error('Error generating finalist crest:', error);
        container.innerHTML = '<p class="text-sm text-red-500">Error generating finalist crest</p>';
      }
    }

    async function updateAccoladeCrests() {
      const container = document.getElementById('accolade-crests-container');
      const section = document.getElementById('accolade-crests-section');
      
      if (!container || !selectedFinalist) { section?.classList.add('hidden'); return; }

      const accolades = selectedFinalist.accolades || [];
      if (accolades.length === 0) { section?.classList.add('hidden'); return; }

      section?.classList.remove('hidden');
      container.innerHTML = '<p class="text-sm text-gray-500 mb-4">Generating accolade crests...</p>';

      const eventYear = selectedFinalist.eventYear || eventDetails?.event_year || '2025';
      const projectName = selectedFinalist.title || '';

      const crestConfig = getCrestConfig();
      const crestPromises = accolades.flatMap(async (accolade) => {
        try {
          const [blackCrest, whiteCrest] = await Promise.all([
            CrestGenerator.generateAccoladeCrest(accolade, projectName, eventYear, 'black', crestConfig),
            CrestGenerator.generateAccoladeCrest(accolade, projectName, eventYear, 'white', crestConfig)
          ]);
          return [
            { accolade, crestUrl: blackCrest, variant: 'black' },
            { accolade, crestUrl: whiteCrest, variant: 'white' }
          ];
        } catch (error) {
          console.error('Error generating crest:', accolade, error);
          return [];
        }
      });

      const allCrests = await Promise.all(crestPromises);
      const validCrests = allCrests.flat().filter(Boolean);

      if (validCrests.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">No accolade crests available</p>';
        return;
      }

      const groupedCrests = {};
      validCrests.forEach(item => {
        const key = item.accolade.id || item.accolade.name;
        if (!groupedCrests[key]) groupedCrests[key] = { accolade: item.accolade, variants: {} };
        groupedCrests[key].variants[item.variant] = item.crestUrl;
      });

      container.innerHTML = Object.values(groupedCrests).map((group) => `
        <div class="bg-white rounded-lg border border-gray-200 p-4">
          <h4 class="text-sm font-medium text-gray-700 mb-3">${group.accolade.name}</h4>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <p class="text-xs text-gray-500 mb-1 text-center">Black Version</p>
              <div class="relative bg-gray-50 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                <img src="${group.variants.black}" alt="${group.accolade.name} Crest (Black)" class="max-w-full h-auto object-contain" />
              </div>
              <button class="w-full px-3 py-1.5 bg-gray-800 text-white text-xs font-medium rounded-lg hover:bg-gray-900 transition-colors download-crest-btn" data-crest-url="${group.variants.black}" data-accolade-name="${FinalistImageGenerator.sanitizeFilename(group.accolade.name)}" data-variant="black">Download Black</button>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1 text-center">White Version</p>
              <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                <img src="${group.variants.white}" alt="${group.accolade.name} Crest (White)" class="max-w-full h-auto object-contain" />
              </div>
              <button class="w-full px-3 py-1.5 bg-gray-100 text-gray-800 text-xs font-medium rounded-lg hover:bg-gray-200 transition-colors download-crest-btn border border-gray-300" data-crest-url="${group.variants.white}" data-accolade-name="${FinalistImageGenerator.sanitizeFilename(group.accolade.name)}" data-variant="white">Download White</button>
            </div>
          </div>
        </div>
      `).join('');

      container.querySelectorAll('.download-crest-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const url = btn.getAttribute('data-crest-url');
          const name = btn.getAttribute('data-accolade-name');
          const variant = btn.getAttribute('data-variant');
          if (url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}_accolade_crest_${variant}_${eventYear}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        });
      });
    }

    async function updateWinnerCrests() {
      const container = document.getElementById('winner-crests-container');
      const section = document.getElementById('winner-crests-section');
      
      if (!container || !selectedFinalist) { section?.classList.add('hidden'); return; }
      if (!selectedFinalist.isWinner) { section?.classList.add('hidden'); return; }

      section?.classList.remove('hidden');
      container.innerHTML = '<p class="text-sm text-gray-500 mb-4">Generating winner crest...</p>';

      const eventYear = selectedFinalist.eventYear || eventDetails?.event_year || '2025';
      const projectName = selectedFinalist.title || '';
      const categoryName = selectedFinalist.category || '';

      try {
        const crestConfig = getCrestConfig();
        const [blackCrest, whiteCrest] = await Promise.all([
          CrestGenerator.generateWinnerCrest(categoryName, projectName, eventYear, 'black', crestConfig),
          CrestGenerator.generateWinnerCrest(categoryName, projectName, eventYear, 'white', crestConfig)
        ]);

        container.innerHTML = `
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="text-sm font-medium text-gray-700 mb-3">${categoryName} Winner</h4>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <p class="text-xs text-gray-500 mb-1 text-center">Black Version</p>
                <div class="relative bg-gray-50 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                  <img src="${blackCrest}" alt="Winner Crest (Black)" class="max-w-full h-auto object-contain" />
                </div>
                <button class="w-full px-3 py-1.5 bg-gray-800 text-white text-xs font-medium rounded-lg hover:bg-gray-900 transition-colors download-winner-crest-btn" data-crest-url="${blackCrest}" data-variant="black">Download Black</button>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1 text-center">White Version</p>
                <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-2 flex items-center justify-center p-2">
                  <img src="${whiteCrest}" alt="Winner Crest (White)" class="max-w-full h-auto object-contain" />
                </div>
                <button class="w-full px-3 py-1.5 bg-gray-100 text-gray-800 text-xs font-medium rounded-lg hover:bg-gray-200 transition-colors download-winner-crest-btn border border-gray-300" data-crest-url="${whiteCrest}" data-variant="white">Download White</button>
              </div>
            </div>
          </div>
        `;

        container.querySelectorAll('.download-winner-crest-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const url = btn.getAttribute('data-crest-url');
            const variant = btn.getAttribute('data-variant');
            if (url) {
              const projectSlug = FinalistImageGenerator.sanitizeFilename(projectName);
              const a = document.createElement('a');
              a.href = url;
              a.download = `${projectSlug}_winner_crest_${variant}_${eventYear}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
          });
        });
      } catch (error) {
        console.error('Error generating winner crest:', error);
        container.innerHTML = '<p class="text-sm text-red-500">Error generating winner crest</p>';
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!finalistsList) return;
      const searchContainer = searchInput?.closest('.max-w-2xl');
      if (searchContainer && !searchContainer.contains(e.target) && !finalistsList.contains(e.target)) {
        finalistsList.classList.add('hidden');
      }
    });

    // Reposition dropdown on scroll/resize
    window.addEventListener('scroll', () => {
      if (finalistsList && !finalistsList.classList.contains('hidden')) {
        positionDropdown();
      }
    });

    window.addEventListener('resize', () => {
      if (finalistsList && !finalistsList.classList.contains('hidden')) {
        positionDropdown();
      }
    });

    // Initialize
    initializeYearDropdown();
    initializeFinalists();
    initializeAspectRatioButtons();
    filteredFinalists = [];
    // Don't render initial list - wait for user to type 3+ characters
    
    // Load finalist from URL if present
    loadFromURL();
  });
</script>

<style>
  .page-title {
    font-size: 35px;
    font-weight: 600;
  }

  .page-subtitle {
    font-size: 16px;
    font-weight: 300;
    font-family: "IBM Plex Mono", monospace;
  }

  .finalist-card {
    transition: all 0.3s ease;
  }

  .finalist-card:hover {
    transform: translateY(-2px);
  }

  /* Style the select element itself - white text for the selected value */
  #year-select {
    color: white;
  }

  /* Style the dropdown options - dark text on white background */
  #year-select option {
    background: white !important;
    color: #0E1022 !important;
    padding: 8px;
  }

  /* Ensure options are visible when dropdown is open */
  select#year-select option {
    background-color: white !important;
    color: #0E1022 !important;
  }

  /* Hover state for options */
  select#year-select option:hover,
  select#year-select option:focus,
  select#year-select option:checked {
    background-color: #f3f4f6 !important;
    color: #0E1022 !important;
  }

  /* Aspect ratio container styles */
  .aspect-ratio-container {
    transition: aspect-ratio 0.3s ease;
    margin: 0 auto;
  }

  .aspect-ratio-container[data-ratio="square"] {
    aspect-ratio: 1 / 1;
    width: 100%;
  }

  .aspect-ratio-container[data-ratio="landscape"] {
    aspect-ratio: 16 / 9;
    width: 100%;
  }

  .aspect-ratio-container[data-ratio="portrait"] {
    aspect-ratio: 9 / 16;
    max-height: 550px;
    width: auto;
    height: 550px;
  }

  /* Aspect ratio button styles */
  .aspect-ratio-btn {
    border-color: #e5e7eb;
    background-color: white;
    color: #374151;
  }

  .aspect-ratio-btn:hover {
    border-color: #9ca3af;
    background-color: #f9fafb;
  }

  .aspect-ratio-btn.active {
    border-color: #4923EB;
    background-color: #f5f3ff;
    color: #4923EB;
  }
</style>

