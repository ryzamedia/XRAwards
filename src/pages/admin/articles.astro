---
/**
 * Admin Articles Management Page
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';
import Modal from '../../components/admin/Modal.astro';
import MediaSelector from '../../components/admin/MediaSelector.astro';
import { ARTICLE_TYPES } from '../../utils/article-types';
import { SANITIZE_CONFIG } from '../../utils/markdown';
import '../../styles/article-content.css';

const articleTypesJson = JSON.stringify(ARTICLE_TYPES);
const sanitizeConfigJson = JSON.stringify(SANITIZE_CONFIG);
---

<AdminLayout title="Articles" activePage="articles">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Articles</h1>
        <p class="mt-2 text-gray-600">Manage blog posts, case studies, and expert insights</p>
      </div>
      <button
        id="addArticleBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
      >
        + Add Article
      </button>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex flex-wrap gap-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Search articles..."
          class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 min-w-64"
        />
        <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Types</option>
          {Object.entries(ARTICLE_TYPES).map(([key, { label }]) => (
            <option value={key}>{label}</option>
          ))}
        </select>
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="all">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>
      </div>
    </div>

    <!-- Articles Table -->
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="articlesTableBody" class="divide-y divide-gray-200">
          <tr>
            <td colspan="5" class="text-center py-12 text-gray-500">Loading articles...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Article Modal -->
    <Modal id="articleModal" title="Add Article" size="wide">
      <form id="articleModalForm" class="space-y-6 max-w-full">
        <input type="hidden" id="articleId" name="id" />

        <!-- Basic Info -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Basic Information</h3>

          <div>
            <label for="articleTitle" class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
            <input
              type="text"
              id="articleTitle"
              name="title"
              required
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Article title"
            />
          </div>

          <div>
            <label for="articleSlug" class="block text-sm font-medium text-gray-700 mb-1">
              Slug
              <span class="text-xs text-gray-500 font-normal">(auto-generated from title)</span>
            </label>
            <input
              type="text"
              id="articleSlug"
              name="slug"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="auto-generated-slug"
            />
          </div>

          <div>
            <label for="articleType" class="block text-sm font-medium text-gray-700 mb-1">Article Type *</label>
            <select
              id="articleType"
              name="article_type"
              required
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select type...</option>
              {Object.entries(ARTICLE_TYPES).map(([key, { label }]) => (
                <option value={key}>{label}</option>
              ))}
            </select>
          </div>

          <div>
            <label for="articleExcerpt" class="block text-sm font-medium text-gray-700 mb-1">Excerpt</label>
            <textarea
              id="articleExcerpt"
              name="excerpt"
              rows="2"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Brief summary for article cards..."
            ></textarea>
          </div>
        </div>

        <!-- Content Editor -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Content *</h3>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Editor -->
            <div>
              <label for="articleContent" class="block text-sm font-medium text-gray-700 mb-1">
                Markdown / HTML
              </label>

              <!-- Formatting Toolbar -->
              <div class="flex flex-wrap gap-1 mb-1 p-1.5 bg-gray-100 border border-gray-300 border-b-0 rounded-t-lg">
                <!-- Basic formatting -->
                <button type="button" data-format="bold" title="Bold" class="toolbar-btn font-bold">B</button>
                <button type="button" data-format="italic" title="Italic" class="toolbar-btn italic">I</button>
                <button type="button" data-format="link" title="Insert Link" class="toolbar-btn text-xs text-blue-700">Link</button>
                <span class="w-px h-6 bg-gray-300 mx-1 self-center"></span>
                <button type="button" data-format="h2" title="Heading 2" class="toolbar-btn text-xs">H2</button>
                <button type="button" data-format="h3" title="Heading 3" class="toolbar-btn text-xs">H3</button>
                <span class="w-px h-6 bg-gray-300 mx-1 self-center"></span>
                <!-- Rich components -->
                <button type="button" data-format="quote" title="Quote Callout" class="toolbar-btn text-xs text-cyan-700">Quote</button>
                <button type="button" data-format="advice" title="Advice / Takeaway Box" class="toolbar-btn text-xs text-purple-700">Advice</button>
                <button type="button" data-format="numbered" title="Numbered Item" class="toolbar-btn text-xs text-gray-700">Numbered</button>
                <button type="button" data-format="cta" title="CTA Callout" class="toolbar-btn text-xs text-cyan-700">CTA</button>
                <button type="button" data-format="ctaBtn" title="Inline Button" class="toolbar-btn text-xs text-cyan-700">Button</button>
                <button type="button" data-format="hr" title="Section Divider" class="toolbar-btn text-xs text-gray-700">---</button>
              </div>

              <textarea
                id="articleContent"
                name="content"
                rows="20"
                class="w-full px-3 py-2 border border-gray-300 rounded-b-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                placeholder="Write in markdown or paste HTML..."
              ></textarea>
            </div>

            <!-- Preview -->
            <div>
              <p class="block text-sm font-medium text-gray-700 mb-1">Preview</p>
              <div class="p-1.5 bg-gray-100 border border-gray-300 border-b-0 rounded-t-lg">
                <span class="text-xs text-gray-500 px-1">Live preview â€” styled as on the public page</span>
              </div>
              <div
                id="contentPreview"
                class="w-full h-[480px] border border-gray-300 rounded-b-lg p-4 overflow-y-auto overflow-x-hidden bg-white"
              >
                <p class="text-gray-400 text-sm italic">Start typing to see preview...</p>
              </div>
            </div>
          </div>

          <!-- Content Reference (collapsible) -->
          <details class="border border-gray-200 rounded-lg">
            <summary class="px-4 py-3 text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50">
              HTML Snippet Reference (click to expand)
            </summary>
            <div class="px-4 pb-4 space-y-3 text-xs">
              <p class="font-semibold text-gray-500 uppercase tracking-wide mb-2">Basic Formatting</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Headings:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;h2&gt;Section Heading&lt;/h2&gt;
&lt;h3&gt;Sub Heading&lt;/h3&gt;
&lt;h4&gt;Minor Heading&lt;/h4&gt;</code></pre>
                </div>
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Bold &amp; Italic:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;strong&gt;Bold text&lt;/strong&gt;
&lt;em&gt;Italic text&lt;/em&gt;
&lt;strong&gt;&lt;em&gt;Bold italic&lt;/em&gt;&lt;/strong&gt;</code></pre>
                </div>
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Links:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;!-- Same tab --&gt;
&lt;a href="/page/"&gt;Link text&lt;/a&gt;

&lt;!-- New tab (add target + rel) --&gt;
&lt;a href="https://example.com" target="_blank" rel="noopener noreferrer"&gt;Link text&lt;/a&gt;</code></pre>
                </div>
              </div>
              <p class="font-semibold text-gray-500 uppercase tracking-wide mb-2">Rich Components</p>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Quote Callout:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="quote-callout"&gt;
  &lt;span class="quote-icon"&gt;&amp;ldquo;&lt;/span&gt;
  &lt;p class="quote-text"&gt;Your quote text here.&lt;/p&gt;
  &lt;p class="quote-attribution"&gt;&mdash; Author Name, Title&lt;/p&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Advice Box:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="studio-advice-box"&gt;
  &lt;h3&gt;Key Takeaway&lt;/h3&gt;
  &lt;p&gt;Your advice or takeaway text here.&lt;/p&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Numbered List:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="numbered-list"&gt;
  &lt;div class="numbered-item"&gt;
    &lt;div class="number-badge"&gt;1&lt;/div&gt;
    &lt;div class="numbered-content"&gt;
      &lt;h4&gt;Item Title&lt;/h4&gt;
      &lt;p&gt;Item description.&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">CTA Callout (dark banner with button):</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="article-cta"&gt;
  &lt;h3&gt;Your Heading Here&lt;/h3&gt;
  &lt;p&gt;Supporting text or description.&lt;/p&gt;
  &lt;a href="/your-link/" class="article-cta-btn"&gt;Button Text&lt;/a&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Inline Button:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;a href="/your-link/" class="article-inline-btn"&gt;Button Text&lt;/a&gt;</code></pre>
              </div>
            </div>
          </details>
        </div>

        <!-- Featured Image -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Featured Image</h3>
          <MediaSelector
            multiple={false}
            label="Featured Image"
            helpText="Select a featured image for this article"
          />
        </div>

        <!-- Author -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Author</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="authorName" class="block text-sm font-medium text-gray-700 mb-1">Author Name</label>
              <input
                type="text"
                id="authorName"
                name="author_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., Jane Smith"
              />
            </div>
            <div>
              <label for="authorTitle" class="block text-sm font-medium text-gray-700 mb-1">Author Title</label>
              <input
                type="text"
                id="authorTitle"
                name="author_title"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., CTO at Norcat"
              />
            </div>
          </div>
        </div>

        <!-- Case Study Fields -->
        <div id="caseStudyFields" class="space-y-4 hidden">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Case Study Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
              <input
                type="text"
                id="companyName"
                name="company_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">Project</label>
              <input
                type="text"
                id="projectName"
                name="project_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <input
                type="text"
                id="categoryName"
                name="category_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="edition" class="block text-sm font-medium text-gray-700 mb-1">Edition</label>
              <input
                type="text"
                id="edition"
                name="edition"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., 2025"
              />
            </div>
          </div>
        </div>

        <!-- SEO -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">SEO Overrides</h3>
          <div>
            <label for="metaTitle" class="block text-sm font-medium text-gray-700 mb-1">Meta Title</label>
            <input
              type="text"
              id="metaTitle"
              name="meta_title"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Override page title for SEO..."
            />
          </div>
          <div>
            <label for="metaDescription" class="block text-sm font-medium text-gray-700 mb-1">Meta Description</label>
            <textarea
              id="metaDescription"
              name="meta_description"
              rows="2"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Override meta description for SEO..."
            ></textarea>
          </div>
        </div>

        <!-- Publish Toggle -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Publishing</h3>
          <label class="flex items-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
            <input
              type="checkbox"
              id="isPublished"
              name="is_published"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <span class="text-sm text-gray-700">Publish this article</span>
          </label>
          <p id="publishedAtInfo" class="text-xs text-gray-500 hidden"></p>
        </div>
      </form>
    </Modal>
  </div>
</AdminLayout>

<script is:inline define:vars={{ articleTypesJson, sanitizeConfigJson }}>
  const ARTICLE_TYPES = JSON.parse(articleTypesJson);
  const SANITIZE_CONFIG = JSON.parse(sanitizeConfigJson);

  let articles = [];
  let filters = { type: '', status: 'all', search: '' };
  let editingArticle = null;
  let sections = [];
  let mediaSelectorId = '';
  let debounceTimer = null;

  // ---- Data Loading ----

  async function loadArticles() {
    try {
      const params = new URLSearchParams();
      if (filters.type) params.set('type', filters.type);
      if (filters.status !== 'all') params.set('status', filters.status);
      if (filters.search) params.set('search', filters.search);

      const response = await fetch(`/api/admin/articles/?${params}`);
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      articles = data.articles || [];
      renderTable();
    } catch (error) {
      console.error('Error loading articles:', error);
      document.getElementById('articlesTableBody').innerHTML =
        '<tr><td colspan="5" class="text-center py-12 text-red-500">Failed to load articles</td></tr>';
    }
  }

  function renderTable() {
    const tbody = document.getElementById('articlesTableBody');

    if (articles.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-12 text-gray-500">No articles found</td></tr>';
      return;
    }

    tbody.innerHTML = articles.map(article => {
      const typeConfig = ARTICLE_TYPES[article.article_type] || {};
      const statusBadge = article.is_published
        ? '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Published</span>'
        : '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Draft</span>';
      const typeBadge = typeConfig.badgeClass
        ? `<span class="px-2 py-1 text-xs font-medium rounded-full ${typeConfig.badgeClass}">${typeConfig.label || article.article_type}</span>`
        : article.article_type;
      const date = article.published_at
        ? new Date(article.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
        : (article.created_at ? new Date(article.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-');

      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">
            <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${article.title}</div>
            <div class="text-xs text-gray-500">/articles/${article.slug}/</div>
          </td>
          <td class="px-6 py-4">${typeBadge}</td>
          <td class="px-6 py-4">${statusBadge}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${date}</td>
          <td class="px-6 py-4 text-right space-x-2">
            <button onclick="editArticle('${article.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
            <button onclick="deleteArticle('${article.id}', '${article.title.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ---- Modal Management ----

  function openModal(mode = 'add') {
    const modal = document.getElementById('articleModal');
    const title = document.getElementById('articleModalTitle');
    modal.classList.remove('hidden');
    title.textContent = mode === 'add' ? 'Add Article' : 'Edit Article';
  }

  function closeModal() {
    document.getElementById('articleModal').classList.add('hidden');
    document.getElementById('articleModalForm').reset();
    document.getElementById('articleId').value = '';
    document.getElementById('contentPreview').innerHTML = '<p class="text-gray-400 text-sm italic">Start typing to see preview...</p>';
    document.getElementById('articleModalError')?.classList.add('hidden');
    document.getElementById('publishedAtInfo').classList.add('hidden');
    sections = [];
    editingArticle = null;
    toggleCaseStudyFields();
  }

  function showError(msg) {
    const el = document.getElementById('articleModalError');
    if (el) {
      el.textContent = msg;
      el.classList.remove('hidden');
    }
  }

  // ---- Slug auto-generation ----

  function slugify(text) {
    return text.toString().toLowerCase().trim()
      .replace(/\s+/g, '-').replace(/[^\w\-]+/g, '')
      .replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
  }

  document.getElementById('articleTitle').addEventListener('input', (e) => {
    const slugField = document.getElementById('articleSlug');
    // Only auto-generate if user hasn't manually edited the slug
    if (!editingArticle || slugField.dataset.manualEdit !== 'true') {
      slugField.value = slugify(e.target.value);
    }
  });

  document.getElementById('articleSlug').addEventListener('input', () => {
    document.getElementById('articleSlug').dataset.manualEdit = 'true';
  });

  // ---- Article Type toggle ----

  function toggleCaseStudyFields() {
    const type = document.getElementById('articleType').value;
    const isCaseStudy = type === 'case-study';
    document.getElementById('caseStudyFields').classList.toggle('hidden', !isCaseStudy);
  }

  document.getElementById('articleType').addEventListener('change', toggleCaseStudyFields);

  // ---- Paste Handler: capture HTML from clipboard (Google Docs, Word, etc.) ----

  document.getElementById('articleContent').addEventListener('paste', (e) => {
    const html = e.clipboardData.getData('text/html');
    if (!html) return; // No HTML on clipboard, let default plain-text paste happen

    e.preventDefault();

    // Clean Google Docs HTML: convert styled spans to semantic HTML, then strip junk
    let cleaned = html
      // Remove everything before <body> and after </body> (meta/head from Google Docs)
      .replace(/^[\s\S]*<body[^>]*>/i, '')
      .replace(/<\/body>[\s\S]*$/i, '')

      // --- Convert styled spans to semantic tags BEFORE stripping styles ---
      // Bold: <span style="font-weight:700"> or font-weight:bold
      .replace(/<span([^>]*?)style="[^"]*font-weight:\s*(700|800|900|bold)[^"]*"([^>]*)>([\s\S]*?)<\/span>/gi,
        '<strong>$4</strong>')
      // Italic: <span style="font-style:italic">
      .replace(/<span([^>]*?)style="[^"]*font-style:\s*italic[^"]*"([^>]*)>([\s\S]*?)<\/span>/gi,
        '<em>$3</em>')
      // Google Docs also uses <b> and <i> tags sometimes
      .replace(/<b[^>]*>([\s\S]*?)<\/b>/gi, '<strong>$1</strong>')
      .replace(/<i[^>]*>([\s\S]*?)<\/i>/gi, '<em>$1</em>')

      // --- Now strip remaining style/class/id attributes ---
      .replace(/\s+style="[^"]*"/gi, '')
      .replace(/\s+class="[^"]*"/gi, '')
      .replace(/\s+id="[^"]*"/gi, '')
      // Remove leftover empty spans: <span>text</span> -> text
      .replace(/<span[^>]*>([\s\S]*?)<\/span>/gi, '$1')
      // Remove Google Docs trailing <br> before </p>
      .replace(/<br\s*\/?>\s*<\/p>/gi, '</p>')

      // --- Add line breaks around block elements for readability ---
      // Newline before opening block tags
      .replace(/<(p|h[1-6]|div|blockquote|ul|ol|li|section|hr|table|tr)([^>]*)>/gi, '\n<$1$2>')
      // Newline after closing block tags
      .replace(/<\/(p|h[1-6]|div|blockquote|ul|ol|li|section|table|tr)>/gi, '</$1>\n')
      // Extra blank line between paragraphs / headings for visual separation
      .replace(/<\/(p|h[1-6])>\s*\n\s*<(p|h[1-6])/gi, '</$1>\n\n<$2')

      // Collapse 3+ blank lines down to 2
      .replace(/\n{3,}/g, '\n\n')
      // Remove leading/trailing whitespace
      .trim();

    // Insert at cursor using execCommand so Ctrl+Z undo works
    const textarea = e.target;
    textarea.focus();
    document.execCommand('insertText', false, cleaned);

    // Trigger preview update
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 300);
  });

  // ---- Content Preview (debounced) ----

  document.getElementById('articleContent').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 300);
  });

  async function updatePreview() {
    const content = document.getElementById('articleContent').value;
    const preview = document.getElementById('contentPreview');

    if (!content.trim()) {
      preview.innerHTML = '<p class="text-gray-400 text-sm italic">Start typing to see preview...</p>';
      return;
    }

    try {
      // Use marked CDN if available, otherwise just show raw
      if (window.marked) {
        let html = window.marked.parse(content);
        if (window.sanitizeHtml) {
          html = window.sanitizeHtml(html, SANITIZE_CONFIG);
        }
        preview.innerHTML = '<div class="article-prose">' + html + '</div>';
      } else {
        // Fallback: render HTML directly (for pasted HTML content)
        preview.innerHTML = '<div class="article-prose">' + content + '</div>';
      }
    } catch (err) {
      preview.innerHTML = '<p class="text-red-500 text-sm">Preview error: ' + err.message + '</p>';
    }
  }

  // ---- Scroll preview to match editor cursor/selection position ----
  function syncPreviewToCursor() {
    const textarea = document.getElementById('articleContent');
    const preview = document.getElementById('contentPreview');
    const articleProse = preview?.querySelector('.article-prose');
    if (!textarea || !articleProse || !articleProse.children.length) return;

    const source = textarea.value;
    const cursorPos = textarea.selectionStart;
    if (cursorPos == null) return;

    // Extract plain text around cursor to search in preview
    const searchStart = Math.max(0, cursorPos - 30);
    const snippet = source.substring(searchStart, searchStart + 80)
      .replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim().substring(0, 30);

    if (!snippet) return;

    // Search rendered leaf nodes for the snippet
    const children = articleProse.querySelectorAll('*');
    for (const child of children) {
      if (child.children.length > 0) continue;
      if (child.textContent && child.textContent.includes(snippet.substring(0, 15))) {
        child.scrollIntoView({ block: 'center', behavior: 'smooth' });
        return;
      }
    }
  }

  // Trigger on typing, clicking, arrow keys, and selection changes
  const contentTextarea = document.getElementById('articleContent');
  let syncTimer = null;
  function debouncedSync() {
    clearTimeout(syncTimer);
    syncTimer = setTimeout(syncPreviewToCursor, 150);
  }
  contentTextarea.addEventListener('keyup', debouncedSync);
  contentTextarea.addEventListener('click', debouncedSync);
  contentTextarea.addEventListener('select', debouncedSync);

  // ---- Click-to-locate: click preview to highlight source in editor ----

  document.getElementById('contentPreview').addEventListener('click', function (e) {
    // Walk up from click target to find a block-level element with text
    let el = e.target;
    while (el && el !== this && !el.textContent.trim()) {
      el = el.parentElement;
    }
    if (!el || el === this) return;

    // Get the text content of the clicked element to search in source
    const clickedText = el.textContent.trim();
    if (!clickedText || clickedText.length < 3) return;

    const textarea = document.getElementById('articleContent');
    const source = textarea.value;

    // Try to find a meaningful snippet (first 40 chars, cleaned) in the source
    const searchText = clickedText.substring(0, 60).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(searchText.substring(0, Math.min(searchText.length, 40)), 'i');
    const match = source.match(regex);

    if (match && match.index !== undefined) {
      // Set selection first, then scroll to it
      textarea.selectionStart = match.index;
      textarea.selectionEnd = match.index + match[0].length;

      // Scroll textarea so selection is vertically centered
      // Temporarily move cursor to force browser to scroll to it
      textarea.blur();
      textarea.focus();
      // Browser auto-scrolls to caret on focus, but we want it centered
      const linesBefore = source.substring(0, match.index).split('\n').length;
      const totalLines = source.split('\n').length || 1;
      const visibleLines = Math.floor(textarea.clientHeight / (textarea.scrollHeight / totalLines));
      const targetLine = Math.max(0, linesBefore - Math.floor(visibleLines / 2));
      textarea.scrollTop = (targetLine / totalLines) * textarea.scrollHeight;
    }

    // Visual feedback: briefly highlight the clicked preview element
    el.style.outline = '2px solid #00D4D8';
    el.style.outlineOffset = '2px';
    setTimeout(() => {
      el.style.outline = '';
      el.style.outlineOffset = '';
    }, 1200);
  });

  // ---- CRUD Operations ----

  window.editArticle = function(id) {
    const article = articles.find(a => a.id === id);
    if (!article) return;

    editingArticle = article;
    document.getElementById('articleId').value = article.id;
    document.getElementById('articleTitle').value = article.title || '';
    document.getElementById('articleSlug').value = article.slug || '';
    document.getElementById('articleSlug').dataset.manualEdit = 'true';
    document.getElementById('articleType').value = article.article_type || '';
    document.getElementById('articleExcerpt').value = article.excerpt || '';
    document.getElementById('articleContent').value = article.content || '';
    document.getElementById('authorName').value = article.author_name || '';
    document.getElementById('authorTitle').value = article.author_title || '';
    document.getElementById('companyName').value = article.company_name || '';
    document.getElementById('projectName').value = article.project_name || '';
    document.getElementById('categoryName').value = article.category_name || '';
    document.getElementById('edition').value = article.edition || '';
    document.getElementById('metaTitle').value = article.meta_title || '';
    document.getElementById('metaDescription').value = article.meta_description || '';
    document.getElementById('isPublished').checked = article.is_published || false;

    // Show published_at info
    if (article.published_at) {
      const infoEl = document.getElementById('publishedAtInfo');
      infoEl.textContent = 'First published: ' + new Date(article.published_at).toLocaleString();
      infoEl.classList.remove('hidden');
    }

    // Set featured image if MediaSelector supports it
    if (article.featured_image) {
      const mediaPreview = document.querySelector('.media-selector-component');
      if (mediaPreview) {
        mediaPreview.dispatchEvent(new CustomEvent('setMedia', { detail: { url: article.featured_image } }));
      }
    }

    // Preserve sections data for backward compat
    sections = Array.isArray(article.sections) ? [...article.sections] : [];

    toggleCaseStudyFields();
    updatePreview();
    openModal('edit');
  };

  window.deleteArticle = async function(id, title) {
    if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

    try {
      const response = await fetch('/api/admin/articles/', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id }),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      await loadArticles();
    } catch (error) {
      alert('Failed to delete article: ' + error.message);
    }
  };

  // ---- Form Submit ----

  document.getElementById('articleModalForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('articleId').value;
    const method = id ? 'PUT' : 'POST';

    // Get featured image from MediaSelector
    let featured_image = '';
    const mediaSelector = document.querySelector('.media-selector-component');
    if (mediaSelector) {
      const selectedMedia = mediaSelector.getAttribute('data-selected-url');
      if (selectedMedia) featured_image = selectedMedia;
    }

    const body = {
      ...(id ? { id } : {}),
      title: document.getElementById('articleTitle').value,
      slug: document.getElementById('articleSlug').value,
      article_type: document.getElementById('articleType').value,
      excerpt: document.getElementById('articleExcerpt').value,
      content: document.getElementById('articleContent').value,
      author_name: document.getElementById('authorName').value,
      author_title: document.getElementById('authorTitle').value,
      company_name: document.getElementById('companyName').value,
      project_name: document.getElementById('projectName').value,
      category_name: document.getElementById('categoryName').value,
      edition: document.getElementById('edition').value,
      meta_title: document.getElementById('metaTitle').value,
      meta_description: document.getElementById('metaDescription').value,
      is_published: document.getElementById('isPublished').checked,
      featured_image,
      sections,
    };

    try {
      const response = await fetch('/api/admin/articles/', {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      closeModal();
      await loadArticles();
    } catch (error) {
      showError(error.message);
    }
  });

  // ---- Filter Events ----

  document.getElementById('searchInput').addEventListener('input', (e) => {
    filters.search = e.target.value;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(loadArticles, 300);
  });

  document.getElementById('typeFilter').addEventListener('change', (e) => {
    filters.type = e.target.value;
    loadArticles();
  });

  document.getElementById('statusFilter').addEventListener('change', (e) => {
    filters.status = e.target.value;
    loadArticles();
  });

  // ---- Modal Buttons ----

  document.getElementById('addArticleBtn').addEventListener('click', () => {
    closeModal();
    openModal('add');
  });

  document.getElementById('articleModalCloseBtn').addEventListener('click', closeModal);
  document.getElementById('articleModalCancelBtn').addEventListener('click', closeModal);

  // ---- Formatting Toolbar ----

  function showLinkDialog(textarea) {
    const selStart = textarea.selectionStart;
    const selEnd = textarea.selectionEnd;
    const selected = textarea.value.substring(selStart, selEnd);

    // Remove any existing dialog
    document.getElementById('linkDialog')?.remove();

    const dialog = document.createElement('div');
    dialog.id = 'linkDialog';
    dialog.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4)';
    dialog.innerHTML = `
      <div style="background:#fff;border-radius:8px;padding:1.5rem;width:380px;max-width:90vw;box-shadow:0 8px 30px rgba(0,0,0,0.2)">
        <p style="font-weight:600;font-size:0.9375rem;margin:0 0 1rem;color:#111827">Insert Link</p>
        <label style="display:block;font-size:0.8125rem;font-weight:500;color:#374151;margin-bottom:0.25rem">URL</label>
        <input id="linkDialogUrl" type="text" placeholder="https://example.com" style="width:100%;padding:0.5rem 0.625rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;margin-bottom:0.75rem;outline:none" />
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.8125rem;color:#374151;margin-bottom:1.25rem;cursor:pointer">
          <input id="linkDialogNewTab" type="checkbox" style="width:1rem;height:1rem;accent-color:#2563eb" />
          Open in new tab
        </label>
        <div style="display:flex;justify-content:flex-end;gap:0.5rem">
          <button id="linkDialogCancel" type="button" style="padding:0.4rem 1rem;border:1px solid #d1d5db;border-radius:6px;background:#fff;font-size:0.8125rem;cursor:pointer">Cancel</button>
          <button id="linkDialogInsert" type="button" style="padding:0.4rem 1rem;border:none;border-radius:6px;background:#2563eb;color:#fff;font-size:0.8125rem;font-weight:500;cursor:pointer">Insert</button>
        </div>
      </div>
    `;
    document.body.appendChild(dialog);

    const urlInput = document.getElementById('linkDialogUrl');
    urlInput.focus();

    function cleanup() { dialog.remove(); }

    document.getElementById('linkDialogCancel').addEventListener('click', cleanup);
    dialog.addEventListener('click', (e) => { if (e.target === dialog) cleanup(); });

    function insertLink() {
      const url = urlInput.value.trim();
      if (!url) { cleanup(); return; }
      const newTab = document.getElementById('linkDialogNewTab').checked;
      const open = newTab ? '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' : '<a href="' + url + '">';
      cleanup();
      // Restore selection and insert
      textarea.focus();
      textarea.selectionStart = selStart;
      textarea.selectionEnd = selEnd;
      const placeholder = selected || 'Link text';
      document.execCommand('insertText', false, open + placeholder + '</a>');
      textarea.selectionStart = selStart + open.length;
      textarea.selectionEnd = selStart + open.length + placeholder.length;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(updatePreview, 300);
    }

    document.getElementById('linkDialogInsert').addEventListener('click', insertLink);
    urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); insertLink(); } });
  }

  function wrapSelection(before, after) {
    const textarea = document.getElementById('articleContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    const placeholder = selected || 'Your text here';
    const replacement = before + placeholder + after;

    // Use execCommand so the insertion is part of the browser's undo stack (Ctrl+Z works)
    textarea.focus();
    textarea.selectionStart = start;
    textarea.selectionEnd = end;
    document.execCommand('insertText', false, replacement);

    // Select the inner content so user can immediately type over it
    textarea.selectionStart = start + before.length;
    textarea.selectionEnd = start + before.length + placeholder.length;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 300);
  }

  document.querySelectorAll('[data-format]').forEach(btn => {
    btn.addEventListener('click', () => {
      const format = btn.dataset.format;
      const textarea = document.getElementById('articleContent');
      const selected = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();

      switch (format) {
        case 'bold':
          wrapSelection('<strong>', '</strong>');
          break;
        case 'italic':
          wrapSelection('<em>', '</em>');
          break;
        case 'link':
          showLinkDialog(textarea);
          break;
        case 'h2':
          wrapSelection('\n<h2>', '</h2>\n');
          break;
        case 'h3':
          wrapSelection('\n<h3>', '</h3>\n');
          break;
        case 'quote':
          wrapSelection(
            '\n<div class="quote-callout">\n  <span class="quote-icon">&ldquo;</span>\n  <p class="quote-text">',
            '</p>\n  <p class="quote-attribution">&mdash; Author Name, Title</p>\n</div>\n'
          );
          break;
        case 'advice':
          wrapSelection(
            '\n<div class="studio-advice-box">\n  <h3>Key Takeaway</h3>\n  <p>',
            '</p>\n</div>\n'
          );
          break;
        case 'hr':
          wrapSelection('\n<hr>\n', '');
          break;
        case 'cta':
          wrapSelection(
            '\n<div class="article-cta">\n  <h3>',
            '</h3>\n  <p>Supporting text here.</p>\n  <a href="/your-link/" class="article-cta-btn">Get Started</a>\n</div>\n'
          );
          break;
        case 'ctaBtn':
          wrapSelection(
            '\n<a href="/your-link/" class="article-inline-btn">',
            '</a>\n'
          );
          break;
        case 'numbered': {
          const count = (textarea.value.match(/number-badge/g) || []).length + 1;
          wrapSelection(
            `\n<div class="numbered-item">\n  <div class="number-badge">${count}</div>\n  <div class="numbered-content">\n    <h4>`,
            `</h4>\n    <p>Description here.</p>\n  </div>\n</div>\n`
          );
          break;
        }
      }
    });
  });

  // ---- Load CDN libraries for preview ----

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initPreviewLibs() {
    try {
      await loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js');
      // sanitize-html CDN is large; we'll rely on server-side sanitization for production
      // For admin preview, marked output is sufficient
    } catch (err) {
      console.warn('Preview libraries failed to load:', err);
    }
  }

  // ---- Initialize ----

  loadArticles();
  initPreviewLibs();
</script>

<style>
  @import "tailwindcss";

  .toolbar-btn {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background: white;
    border: 1px solid #d1d5db;
    cursor: pointer;
    line-height: 1.5;
    min-width: 1.75rem;
    text-align: center;
    transition: background-color 0.1s;
  }
  .toolbar-btn:hover {
    background: #e5e7eb;
  }

</style>

<!-- Global styles for dynamically injected preview content (innerHTML doesn't get Astro scoping attributes) -->
<style is:global>
  #contentPreview .article-prose {
    overflow-wrap: break-word;
    word-break: break-word;
  }

  /* Scale down for preview panel */
  #contentPreview .article-prose h2 {
    font-size: 1.375rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  #contentPreview .article-prose h3 {
    font-size: 1.125rem;
    margin-top: 1.5rem;
  }

  #contentPreview .article-prose p {
    margin-bottom: 1em;
  }

  #contentPreview .section-marker {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }

  #contentPreview .section-marker h2 {
    font-size: 1.125rem;
  }

  #contentPreview .quote-callout {
    margin: 1.5rem 0;
    padding: 1.75rem 1.5rem 1.25rem;
  }

  #contentPreview .quote-icon {
    font-size: 4rem;
    left: -0.5rem;
  }

  #contentPreview .quote-text {
    font-size: 1.1rem;
  }

  #contentPreview .studio-advice-box {
    margin: 1.5rem 0;
    padding: 1.5rem;
    padding-top: 2rem;
  }

  #contentPreview .studio-advice-box h3 {
    font-size: 0.9375rem;
    top: -0.625rem;
  }

  #contentPreview img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }

  #contentPreview .number-badge {
    width: 28px;
    height: 28px;
    font-size: 0.875rem;
  }

  #contentPreview .numbered-item {
    gap: 0.75rem;
    margin-bottom: 1.25rem;
  }

  #contentPreview .article-prose hr {
    border: none;
    height: 1px;
    background: #E5E7EB;
    margin: 2rem 0;
  }

  #contentPreview .article-cta {
    margin: 1.5rem 0;
    padding: 1.5rem 1.25rem;
    border-radius: 0.5rem;
  }

  #contentPreview .article-cta h3 {
    font-size: 1.125rem;
    color: #FFFFFF;
    margin-top: 0;
  }

  #contentPreview .article-cta p {
    font-size: 0.875rem;
    color: #9CA3AF;
  }

  #contentPreview .article-cta-btn {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    border-radius: 0.375rem;
  }

  #contentPreview .article-inline-btn {
    padding: 0.4rem 0.875rem;
    font-size: 0.8125rem;
    border-radius: 0.375rem;
  }
</style>
