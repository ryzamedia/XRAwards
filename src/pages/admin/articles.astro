---
/**
 * Admin Articles Management Page
 */
import AdminLayout from '../../components/admin/AdminLayout.astro';
import Modal from '../../components/admin/Modal.astro';
import MediaSelector from '../../components/admin/MediaSelector.astro';
import { ARTICLE_TYPES } from '../../utils/article-types';
import { SANITIZE_CONFIG } from '../../utils/markdown';
import '../../styles/article-content.css';

const articleTypesJson = JSON.stringify(ARTICLE_TYPES);
const sanitizeConfigJson = JSON.stringify(SANITIZE_CONFIG);
---

<AdminLayout title="Articles" activePage="articles">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Articles</h1>
        <p class="mt-2 text-gray-600">Manage blog posts, case studies, and expert insights</p>
      </div>
      <button
        id="addArticleBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
      >
        + Add Article
      </button>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex flex-wrap gap-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Search articles..."
          class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 min-w-64"
        />
        <select id="typeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Types</option>
          {Object.entries(ARTICLE_TYPES).map(([key, { label }]) => (
            <option value={key}>{label}</option>
          ))}
        </select>
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="all">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>
      </div>
    </div>

    <!-- Articles Table -->
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="articlesTableBody" class="divide-y divide-gray-200">
          <tr>
            <td colspan="5" class="text-center py-12 text-gray-500">Loading articles...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Article Modal -->
    <Modal id="articleModal" title="Add Article" size="wide">
      <form id="articleModalForm" class="space-y-6 max-w-full">
        <input type="hidden" id="articleId" name="id" />

        <!-- Basic Info -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Basic Information</h3>

          <div>
            <label for="articleTitle" class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
            <input
              type="text"
              id="articleTitle"
              name="title"
              required
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Article title"
            />
          </div>

          <div>
            <label for="articleSlug" class="block text-sm font-medium text-gray-700 mb-1">
              Slug
              <span class="text-xs text-gray-500 font-normal">(auto-generated from title)</span>
            </label>
            <input
              type="text"
              id="articleSlug"
              name="slug"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="auto-generated-slug"
            />
          </div>

          <div>
            <label for="articleType" class="block text-sm font-medium text-gray-700 mb-1">Article Type *</label>
            <select
              id="articleType"
              name="article_type"
              required
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select type...</option>
              {Object.entries(ARTICLE_TYPES).map(([key, { label }]) => (
                <option value={key}>{label}</option>
              ))}
            </select>
          </div>

          <div>
            <label for="articleExcerpt" class="block text-sm font-medium text-gray-700 mb-1">Excerpt</label>
            <textarea
              id="articleExcerpt"
              name="excerpt"
              rows="2"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Brief summary for article cards..."
            ></textarea>
          </div>
        </div>

        <!-- Content Editor -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Content *</h3>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Editor -->
            <div>
              <label for="articleContent" class="block text-sm font-medium text-gray-700 mb-1">
                Markdown / HTML
              </label>

              <!-- Formatting Toolbar -->
              <div class="flex flex-wrap gap-1 mb-1 p-1.5 bg-gray-100 border border-gray-300 border-b-0 rounded-t-lg">
                <!-- Basic formatting -->
                <button type="button" data-format="bold" title="Bold" class="toolbar-btn font-bold">B</button>
                <button type="button" data-format="italic" title="Italic" class="toolbar-btn italic">I</button>
                <button type="button" data-format="link" title="Insert Link" class="toolbar-btn text-xs text-blue-700">Link</button>
                <button type="button" data-format="image" title="Insert Image" class="toolbar-btn text-xs text-green-700">Img</button>
                <span class="w-px h-6 bg-gray-300 mx-1 self-center"></span>
                <button type="button" data-format="h2" title="Heading 2" class="toolbar-btn text-xs">H2</button>
                <button type="button" data-format="h3" title="Heading 3" class="toolbar-btn text-xs">H3</button>
                <span class="w-px h-6 bg-gray-300 mx-1 self-center"></span>
                <!-- Rich components -->
                <button type="button" data-format="quote" title="Quote Callout" class="toolbar-btn text-xs text-cyan-700">Quote</button>
                <button type="button" data-format="advice" title="Advice / Takeaway Box" class="toolbar-btn text-xs text-purple-700">Advice</button>
                <button type="button" data-format="numbered" title="Numbered Item" class="toolbar-btn text-xs text-gray-700">Numbered</button>
                <button type="button" data-format="cta" title="CTA Callout" class="toolbar-btn text-xs text-cyan-700">CTA</button>
                <button type="button" data-format="ctaBtn" title="Inline Button" class="toolbar-btn text-xs text-cyan-700">Button</button>
                <button type="button" data-format="hr" title="Section Divider" class="toolbar-btn text-xs text-gray-700">---</button>
              </div>

              <textarea
                id="articleContent"
                name="content"
                rows="20"
                class="w-full px-3 py-2 border border-gray-300 rounded-b-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                placeholder="Write in markdown or paste HTML..."
              ></textarea>
            </div>

            <!-- Preview -->
            <div>
              <p class="block text-sm font-medium text-gray-700 mb-1">Preview</p>
              <div class="p-1.5 bg-gray-100 border border-gray-300 border-b-0 rounded-t-lg">
                <span class="text-xs text-gray-500 px-1">Live preview â€” styled as on the public page</span>
              </div>
              <div
                id="contentPreview"
                class="w-full h-[480px] border border-gray-300 rounded-b-lg p-4 overflow-y-auto overflow-x-hidden bg-white"
              >
                <p class="text-gray-400 text-sm italic">Start typing to see preview...</p>
              </div>
            </div>
          </div>

          <!-- Content Reference (collapsible) -->
          <details class="border border-gray-200 rounded-lg">
            <summary class="px-4 py-3 text-sm font-medium text-gray-700 cursor-pointer hover:bg-gray-50">
              HTML Snippet Reference (click to expand)
            </summary>
            <div class="px-4 pb-4 space-y-3 text-xs">
              <p class="font-semibold text-gray-500 uppercase tracking-wide mb-2">Basic Formatting</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Headings:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;h2&gt;Section Heading&lt;/h2&gt;
&lt;h3&gt;Sub Heading&lt;/h3&gt;
&lt;h4&gt;Minor Heading&lt;/h4&gt;</code></pre>
                </div>
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Bold &amp; Italic:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;strong&gt;Bold text&lt;/strong&gt;
&lt;em&gt;Italic text&lt;/em&gt;
&lt;strong&gt;&lt;em&gt;Bold italic&lt;/em&gt;&lt;/strong&gt;</code></pre>
                </div>
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Links:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;!-- Same tab --&gt;
&lt;a href="/page/"&gt;Link text&lt;/a&gt;

&lt;!-- New tab (add target + rel) --&gt;
&lt;a href="https://example.com" target="_blank" rel="noopener noreferrer"&gt;Link text&lt;/a&gt;</code></pre>
                </div>
                <div>
                  <p class="font-semibold text-gray-600 mb-1">Images:</p>
                  <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;img src="https://..." alt="Description" /&gt;</code></pre>
                </div>
              </div>
              <p class="font-semibold text-gray-500 uppercase tracking-wide mb-2">Rich Components</p>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Quote Callout:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="quote-callout"&gt;
  &lt;span class="quote-icon"&gt;&amp;ldquo;&lt;/span&gt;
  &lt;p class="quote-text"&gt;Your quote text here.&lt;/p&gt;
  &lt;p class="quote-attribution"&gt;&mdash; Author Name, Title&lt;/p&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Advice Box:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="studio-advice-box"&gt;
  &lt;h3&gt;Key Takeaway&lt;/h3&gt;
  &lt;p&gt;Your advice or takeaway text here.&lt;/p&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Numbered List:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;div class="numbered-list"&gt;
  &lt;div class="numbered-item"&gt;
    &lt;div class="number-badge"&gt;1&lt;/div&gt;
    &lt;div class="numbered-content"&gt;
      &lt;h4&gt;Item Title&lt;/h4&gt;
      &lt;p&gt;Item description.&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">CTA Callout (dark banner with button):</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;!-- Dynamic: auto-updates text &amp; link from event phase --&gt;
&lt;div class="article-cta"&gt;
  &lt;h3&gt;Your Heading Here&lt;/h3&gt;
  &lt;p&gt;Supporting text or description.&lt;/p&gt;
  &lt;a href="#dynamic" class="article-cta-btn"&gt;Dynamic CTA&lt;/a&gt;
&lt;/div&gt;

&lt;!-- Static: set your own link and text --&gt;
&lt;div class="article-cta"&gt;
  &lt;h3&gt;Your Heading Here&lt;/h3&gt;
  &lt;p&gt;Supporting text or description.&lt;/p&gt;
  &lt;a href="/your-link/" class="article-cta-btn"&gt;Button Text&lt;/a&gt;
&lt;/div&gt;</code></pre>
              </div>
              <div>
                <p class="font-semibold text-gray-600 mb-1">Inline Button:</p>
                <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><code>&lt;a href="/your-link/" class="article-inline-btn"&gt;Button Text&lt;/a&gt;</code></pre>
              </div>
            </div>
          </details>
        </div>

        <!-- Featured Image -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Featured Image</h3>
          <MediaSelector
            multiple={false}
            label="Featured Image"
            helpText="Select a featured image for this article"
          />
        </div>

        <!-- Author -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Author</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="authorName" class="block text-sm font-medium text-gray-700 mb-1">Author Name</label>
              <input
                type="text"
                id="authorName"
                name="author_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., Jane Smith"
              />
            </div>
            <div>
              <label for="authorTitle" class="block text-sm font-medium text-gray-700 mb-1">Author Title</label>
              <input
                type="text"
                id="authorTitle"
                name="author_title"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., CTO at Norcat"
              />
            </div>
          </div>
        </div>

        <!-- Case Study Fields -->
        <div id="caseStudyFields" class="space-y-4 hidden">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Case Study Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
              <input
                type="text"
                id="companyName"
                name="company_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">Project</label>
              <input
                type="text"
                id="projectName"
                name="project_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <input
                type="text"
                id="categoryName"
                name="category_name"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="edition" class="block text-sm font-medium text-gray-700 mb-1">Edition</label>
              <input
                type="text"
                id="edition"
                name="edition"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., 2025"
              />
            </div>
          </div>
        </div>

        <!-- Relationships -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Relationships</h3>
          <p class="text-xs text-gray-500">Link this article to finalists, judges, or sponsors. These links power smart cross-references on public pages.</p>

          <!-- Linked Finalist (for case studies) -->
          <div>
            <label for="finalistSelect" class="block text-sm font-medium text-gray-700 mb-1">Linked Finalist</label>
            <select
              id="finalistSelect"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select a finalist...</option>
            </select>
            <div id="finalistPills" class="flex flex-wrap gap-2 mt-2"></div>
          </div>

          <!-- Linked Judges (for expert insights) -->
          <div>
            <label for="judgeSelect" class="block text-sm font-medium text-gray-700 mb-1">Linked Judges</label>
            <select
              id="judgeSelect"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select a judge...</option>
            </select>
            <div id="judgePills" class="flex flex-wrap gap-2 mt-2"></div>
          </div>

          <!-- Linked Sponsors -->
          <div>
            <label for="sponsorSelect" class="block text-sm font-medium text-gray-700 mb-1">Linked Sponsors</label>
            <select
              id="sponsorSelect"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select a sponsor...</option>
            </select>
            <div id="sponsorPills" class="flex flex-wrap gap-2 mt-2"></div>
          </div>
        </div>

        <!-- SEO -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">SEO Overrides</h3>
          <div>
            <label for="metaTitle" class="block text-sm font-medium text-gray-700 mb-1">Meta Title</label>
            <input
              type="text"
              id="metaTitle"
              name="meta_title"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Override page title for SEO..."
            />
          </div>
          <div>
            <label for="metaDescription" class="block text-sm font-medium text-gray-700 mb-1">Meta Description</label>
            <textarea
              id="metaDescription"
              name="meta_description"
              rows="2"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
              placeholder="Override meta description for SEO..."
            ></textarea>
          </div>
        </div>

        <!-- Publish Toggle -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Publishing</h3>
          <label class="flex items-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
            <input
              type="checkbox"
              id="isPublished"
              name="is_published"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <span class="text-sm text-gray-700">Publish this article</span>
          </label>
          <div>
            <label for="publishedAt" class="block text-sm font-medium text-gray-700 mb-1">Publish Date</label>
            <input
              type="datetime-local"
              id="publishedAt"
              name="published_at"
              class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
            />
            <p class="text-xs text-gray-500 mt-1">Leave blank to use the current time when first published</p>
          </div>
        </div>
      </form>
    </Modal>
  </div>
</AdminLayout>

<script is:inline define:vars={{ articleTypesJson, sanitizeConfigJson }}>
  const ARTICLE_TYPES = JSON.parse(articleTypesJson);
  const SANITIZE_CONFIG = JSON.parse(sanitizeConfigJson);

  let articles = [];
  let filters = { type: '', status: 'all', search: '' };
  let editingArticle = null;
  let sections = [];
  let mediaSelectorId = '';
  let debounceTimer = null;

  // Relationship state
  let allFinalists = [];
  let allJudges = [];
  let allSponsors = [];
  let selectedFinalistIds = [];
  let selectedJudgeIds = [];
  let selectedSponsorIds = [];

  // ---- Relationship Entity Loading ----

  async function loadRelationshipEntities() {
    try {
      const [finalistResp, judgeResp, sponsorResp] = await Promise.all([
        fetch('/api/finalists/?limit=500'),
        fetch('/api/judges/'),
        fetch('/api/sponsors/'),
      ]);

      if (finalistResp.ok) {
        const data = await finalistResp.json();
        allFinalists = (data.finalists || []).map(f => ({
          id: f.id, title: f.title, organization: f.organization
        }));
      }

      if (judgeResp.ok) {
        const data = await judgeResp.json();
        allJudges = (data.judges || []).map(j => ({
          id: j.id,
          name: `${j.first_name} ${j.last_name}`,
          organization: j.organization
        }));
      }

      if (sponsorResp.ok) {
        const data = await sponsorResp.json();
        allSponsors = (data.sponsors || []).map(s => ({
          id: s.id, name: s.name
        }));
      }
    } catch (err) {
      console.error('Error loading relationship entities:', err);
    }

    populateEntitySelects();
  }

  function populateEntitySelects() {
    const finSelect = document.getElementById('finalistSelect');
    const judgeSelect = document.getElementById('judgeSelect');
    const sponsorSelect = document.getElementById('sponsorSelect');

    finSelect.innerHTML = '<option value="">Select a finalist...</option>' +
      allFinalists.map(f =>
        `<option value="${f.id}">${f.title}${f.organization ? ` (${f.organization})` : ''}</option>`
      ).join('');

    judgeSelect.innerHTML = '<option value="">Select a judge...</option>' +
      allJudges.map(j =>
        `<option value="${j.id}">${j.name}${j.organization ? ` - ${j.organization}` : ''}</option>`
      ).join('');

    sponsorSelect.innerHTML = '<option value="">Select a sponsor...</option>' +
      allSponsors.map(s =>
        `<option value="${s.id}">${s.name}</option>`
      ).join('');
  }

  function renderPills(containerId, selectedIds, entityList, nameKey) {
    const container = document.getElementById(containerId);
    container.innerHTML = selectedIds.map(id => {
      const entity = entityList.find(e => e.id === id);
      const label = entity
        ? (nameKey === 'title' ? `${entity.title}${entity.organization ? ` (${entity.organization})` : ''}` : entity[nameKey] || entity.name || id)
        : id;
      return `<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
        ${label}
        <button type="button" data-remove-id="${id}" class="ml-0.5 text-blue-600 hover:text-blue-900">&times;</button>
      </span>`;
    }).join('');

    container.querySelectorAll('[data-remove-id]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const removeId = btn.dataset.removeId;
        if (containerId === 'finalistPills') {
          selectedFinalistIds = selectedFinalistIds.filter(i => i !== removeId);
          renderPills('finalistPills', selectedFinalistIds, allFinalists, 'title');
        } else if (containerId === 'judgePills') {
          selectedJudgeIds = selectedJudgeIds.filter(i => i !== removeId);
          renderPills('judgePills', selectedJudgeIds, allJudges, 'name');
        } else if (containerId === 'sponsorPills') {
          selectedSponsorIds = selectedSponsorIds.filter(i => i !== removeId);
          renderPills('sponsorPills', selectedSponsorIds, allSponsors, 'name');
        }
      });
    });
  }

  // Select handlers for adding relationships
  document.getElementById('finalistSelect').addEventListener('change', (e) => {
    const val = e.target.value;
    if (val && !selectedFinalistIds.includes(val)) {
      selectedFinalistIds.push(val);
      renderPills('finalistPills', selectedFinalistIds, allFinalists, 'title');
    }
    e.target.value = '';
  });

  document.getElementById('judgeSelect').addEventListener('change', (e) => {
    const val = e.target.value;
    if (val && !selectedJudgeIds.includes(val)) {
      selectedJudgeIds.push(val);
      renderPills('judgePills', selectedJudgeIds, allJudges, 'name');
    }
    e.target.value = '';
  });

  document.getElementById('sponsorSelect').addEventListener('change', (e) => {
    const val = e.target.value;
    if (val && !selectedSponsorIds.includes(val)) {
      selectedSponsorIds.push(val);
      renderPills('sponsorPills', selectedSponsorIds, allSponsors, 'name');
    }
    e.target.value = '';
  });

  // ---- Data Loading ----

  async function loadArticles() {
    try {
      const params = new URLSearchParams();
      if (filters.type) params.set('type', filters.type);
      if (filters.status !== 'all') params.set('status', filters.status);
      if (filters.search) params.set('search', filters.search);

      const response = await fetch(`/api/admin/articles/?${params}`);
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      articles = data.articles || [];
      renderTable();
    } catch (error) {
      console.error('Error loading articles:', error);
      document.getElementById('articlesTableBody').innerHTML =
        '<tr><td colspan="5" class="text-center py-12 text-red-500">Failed to load articles</td></tr>';
    }
  }

  function renderTable() {
    const tbody = document.getElementById('articlesTableBody');

    if (articles.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-12 text-gray-500">No articles found</td></tr>';
      return;
    }

    tbody.innerHTML = articles.map(article => {
      const typeConfig = ARTICLE_TYPES[article.article_type] || {};
      const statusBadge = article.is_published
        ? '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Published</span>'
        : '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Draft</span>';
      const typeBadge = typeConfig.badgeClass
        ? `<span class="px-2 py-1 text-xs font-medium rounded-full ${typeConfig.badgeClass}">${typeConfig.label || article.article_type}</span>`
        : article.article_type;
      const date = article.published_at
        ? new Date(article.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
        : (article.created_at ? new Date(article.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-');

      return `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">
            <div class="text-sm font-medium text-gray-900 truncate max-w-xs">${article.title}</div>
            <div class="text-xs text-gray-500">/articles/${article.slug}/</div>
          </td>
          <td class="px-6 py-4">${typeBadge}</td>
          <td class="px-6 py-4">${statusBadge}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${date}</td>
          <td class="px-6 py-4 text-right space-x-2">
            <a href="/articles/${article.slug}/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</a>
            <button onclick="editArticle('${article.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
            <button onclick="deleteArticle('${article.id}', '${article.title.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ---- Modal Management ----

  function openModal(mode = 'add') {
    const modal = document.getElementById('articleModal');
    const title = document.getElementById('articleModalTitle');
    modal.classList.remove('hidden');
    title.textContent = mode === 'add' ? 'Add Article' : 'Edit Article';
  }

  function closeModal() {
    document.getElementById('articleModal').classList.add('hidden');
    document.getElementById('articleModalForm').reset();
    document.getElementById('articleId').value = '';
    document.getElementById('contentPreview').innerHTML = '<p class="text-gray-400 text-sm italic">Start typing to see preview...</p>';
    document.getElementById('articleModalError')?.classList.add('hidden');
    sections = [];
    editingArticle = null;
    selectedFinalistIds = [];
    selectedJudgeIds = [];
    selectedSponsorIds = [];
    document.getElementById('finalistPills').innerHTML = '';
    document.getElementById('judgePills').innerHTML = '';
    document.getElementById('sponsorPills').innerHTML = '';
    toggleCaseStudyFields();
  }

  function showError(msg) {
    const el = document.getElementById('articleModalError');
    if (el) {
      el.textContent = msg;
      el.classList.remove('hidden');
    }
  }

  // ---- Slug auto-generation ----

  function slugify(text) {
    return text.toString().toLowerCase().trim()
      .replace(/\s+/g, '-').replace(/[^\w\-]+/g, '')
      .replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
  }

  document.getElementById('articleTitle').addEventListener('input', (e) => {
    const slugField = document.getElementById('articleSlug');
    // Only auto-generate if user hasn't manually edited the slug
    if (!editingArticle || slugField.dataset.manualEdit !== 'true') {
      slugField.value = slugify(e.target.value);
    }
  });

  document.getElementById('articleSlug').addEventListener('input', () => {
    document.getElementById('articleSlug').dataset.manualEdit = 'true';
  });

  // ---- Article Type toggle ----

  function toggleCaseStudyFields() {
    const type = document.getElementById('articleType').value;
    const isCaseStudy = type === 'case-study';
    document.getElementById('caseStudyFields').classList.toggle('hidden', !isCaseStudy);
  }

  document.getElementById('articleType').addEventListener('change', toggleCaseStudyFields);

  // ---- Paste Handler: capture HTML from clipboard (Google Docs, Word, etc.) ----

  document.getElementById('articleContent').addEventListener('paste', (e) => {
    const html = e.clipboardData.getData('text/html');
    if (!html) return; // No HTML on clipboard, let default plain-text paste happen

    e.preventDefault();

    // Clean Google Docs HTML: convert styled spans to semantic HTML, then strip junk
    let cleaned = html
      // Remove everything before <body> and after </body> (meta/head from Google Docs)
      .replace(/^[\s\S]*<body[^>]*>/i, '')
      .replace(/<\/body>[\s\S]*$/i, '')

      // --- Convert styled spans to semantic tags BEFORE stripping styles ---
      // Bold: <span style="font-weight:700"> or font-weight:bold
      .replace(/<span([^>]*?)style="[^"]*font-weight:\s*(700|800|900|bold)[^"]*"([^>]*)>([\s\S]*?)<\/span>/gi,
        '<strong>$4</strong>')
      // Italic: <span style="font-style:italic">
      .replace(/<span([^>]*?)style="[^"]*font-style:\s*italic[^"]*"([^>]*)>([\s\S]*?)<\/span>/gi,
        '<em>$3</em>')
      // Google Docs also uses <b> and <i> tags sometimes
      .replace(/<b[^>]*>([\s\S]*?)<\/b>/gi, '<strong>$1</strong>')
      .replace(/<i[^>]*>([\s\S]*?)<\/i>/gi, '<em>$1</em>')

      // --- Now strip remaining style/class/id attributes ---
      .replace(/\s+style="[^"]*"/gi, '')
      .replace(/\s+class="[^"]*"/gi, '')
      .replace(/\s+id="[^"]*"/gi, '')
      // Remove leftover empty spans: <span>text</span> -> text
      .replace(/<span[^>]*>([\s\S]*?)<\/span>/gi, '$1')
      // Remove Google Docs trailing <br> before </p>
      .replace(/<br\s*\/?>\s*<\/p>/gi, '</p>')

      // --- Add line breaks around block elements for readability ---
      // Newline before opening block tags
      .replace(/<(p|h[1-6]|div|blockquote|ul|ol|li|section|hr|table|tr)([^>]*)>/gi, '\n<$1$2>')
      // Newline after closing block tags
      .replace(/<\/(p|h[1-6]|div|blockquote|ul|ol|li|section|table|tr)>/gi, '</$1>\n')
      // Extra blank line between paragraphs / headings for visual separation
      .replace(/<\/(p|h[1-6])>\s*\n\s*<(p|h[1-6])/gi, '</$1>\n\n<$2')

      // Collapse 3+ blank lines down to 2
      .replace(/\n{3,}/g, '\n\n')
      // Remove leading/trailing whitespace
      .trim();

    // Insert at cursor using execCommand so Ctrl+Z undo works
    const textarea = e.target;
    textarea.focus();
    document.execCommand('insertText', false, cleaned);

    // Trigger preview update
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 300);
  });

  // ---- Content Preview (debounced) ----

  document.getElementById('articleContent').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 300);
  });

  async function updatePreview() {
    const content = document.getElementById('articleContent').value;
    const preview = document.getElementById('contentPreview');

    if (!content.trim()) {
      preview.innerHTML = '<p class="text-gray-400 text-sm italic">Start typing to see preview...</p>';
      return;
    }

    try {
      // Use marked CDN if available, otherwise just show raw
      if (window.marked) {
        let html = window.marked.parse(content);
        if (window.sanitizeHtml) {
          html = window.sanitizeHtml(html, SANITIZE_CONFIG);
        }
        preview.innerHTML = '<div class="article-prose">' + html + '</div>';
      } else {
        // Fallback: render HTML directly (for pasted HTML content)
        preview.innerHTML = '<div class="article-prose">' + content + '</div>';
      }
    } catch (err) {
      preview.innerHTML = '<p class="text-red-500 text-sm">Preview error: ' + err.message + '</p>';
    }
  }

  // ---- Scroll preview to match editor cursor/selection position ----
  function syncPreviewToCursor() {
    const textarea = document.getElementById('articleContent');
    const preview = document.getElementById('contentPreview');
    const articleProse = preview?.querySelector('.article-prose');
    if (!textarea || !articleProse || !articleProse.children.length) return;

    const source = textarea.value;
    const cursorPos = textarea.selectionStart;
    if (cursorPos == null) return;

    // Extract plain text around cursor to search in preview
    const searchStart = Math.max(0, cursorPos - 30);
    const snippet = source.substring(searchStart, searchStart + 80)
      .replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim().substring(0, 30);

    if (!snippet) return;

    // Search rendered leaf nodes for the snippet
    const children = articleProse.querySelectorAll('*');
    for (const child of children) {
      if (child.children.length > 0) continue;
      if (child.textContent && child.textContent.includes(snippet.substring(0, 15))) {
        child.scrollIntoView({ block: 'center', behavior: 'smooth' });
        return;
      }
    }
  }

  // Trigger on typing, clicking, arrow keys, and selection changes
  const contentTextarea = document.getElementById('articleContent');
  let syncTimer = null;
  function debouncedSync() {
    clearTimeout(syncTimer);
    syncTimer = setTimeout(syncPreviewToCursor, 150);
  }
  contentTextarea.addEventListener('keyup', debouncedSync);
  contentTextarea.addEventListener('click', debouncedSync);
  contentTextarea.addEventListener('select', debouncedSync);

  // ---- Click-to-locate: click preview to highlight source in editor ----

  document.getElementById('contentPreview').addEventListener('click', function (e) {
    // Walk up from click target to find a block-level element with text
    let el = e.target;
    while (el && el !== this && !el.textContent.trim()) {
      el = el.parentElement;
    }
    if (!el || el === this) return;

    // Get the text content of the clicked element to search in source
    const clickedText = el.textContent.trim();
    if (!clickedText || clickedText.length < 3) return;

    const textarea = document.getElementById('articleContent');
    const source = textarea.value;

    // Try to find a meaningful snippet (first 40 chars, cleaned) in the source
    const searchText = clickedText.substring(0, 60).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(searchText.substring(0, Math.min(searchText.length, 40)), 'i');
    const match = source.match(regex);

    if (match && match.index !== undefined) {
      // Set selection first, then scroll to it
      textarea.selectionStart = match.index;
      textarea.selectionEnd = match.index + match[0].length;

      // Scroll textarea so selection is vertically centered
      // Temporarily move cursor to force browser to scroll to it
      textarea.blur();
      textarea.focus();
      // Browser auto-scrolls to caret on focus, but we want it centered
      const linesBefore = source.substring(0, match.index).split('\n').length;
      const totalLines = source.split('\n').length || 1;
      const visibleLines = Math.floor(textarea.clientHeight / (textarea.scrollHeight / totalLines));
      const targetLine = Math.max(0, linesBefore - Math.floor(visibleLines / 2));
      textarea.scrollTop = (targetLine / totalLines) * textarea.scrollHeight;
    }

    // Visual feedback: briefly highlight the clicked preview element
    el.style.outline = '2px solid #00D4D8';
    el.style.outlineOffset = '2px';
    setTimeout(() => {
      el.style.outline = '';
      el.style.outlineOffset = '';
    }, 1200);
  });

  // ---- CRUD Operations ----

  window.editArticle = function(id) {
    const article = articles.find(a => a.id === id);
    if (!article) return;

    editingArticle = article;
    document.getElementById('articleId').value = article.id;
    document.getElementById('articleTitle').value = article.title || '';
    document.getElementById('articleSlug').value = article.slug || '';
    document.getElementById('articleSlug').dataset.manualEdit = 'true';
    document.getElementById('articleType').value = article.article_type || '';
    document.getElementById('articleExcerpt').value = article.excerpt || '';
    document.getElementById('articleContent').value = article.content || '';
    document.getElementById('authorName').value = article.author_name || '';
    document.getElementById('authorTitle').value = article.author_title || '';
    document.getElementById('companyName').value = article.company_name || '';
    document.getElementById('projectName').value = article.project_name || '';
    document.getElementById('categoryName').value = article.category_name || '';
    document.getElementById('edition').value = article.edition || '';
    document.getElementById('metaTitle').value = article.meta_title || '';
    document.getElementById('metaDescription').value = article.meta_description || '';
    document.getElementById('isPublished').checked = article.is_published || false;

    // Set publish date
    if (article.published_at) {
      const dt = new Date(article.published_at);
      // Format as YYYY-MM-DDThh:mm for datetime-local input
      const local = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
      document.getElementById('publishedAt').value = local;
    }

    // Set featured image via MediaSelector's exposed API
    if (article.featured_image) {
      const mediaEl = document.querySelector('.media-selector-component');
      if (mediaEl) {
        const sid = mediaEl.getAttribute('data-selector-id');
        const setFn = sid && window[`setSelectedMedia_${sid}`];
        if (setFn) {
          setFn({ id: 'existing', file_url: article.featured_image, filename: article.featured_image.split('/').pop(), title: '', file_size: 0 });
        }
      }
    }

    // Preserve sections data for backward compat
    sections = Array.isArray(article.sections) ? [...article.sections] : [];

    // Populate relationship pills from joined data
    selectedFinalistIds = (article.finalists || []).map(f => f.id);
    selectedJudgeIds = (article.judges || []).map(j => j.id);
    selectedSponsorIds = (article.sponsors || []).map(s => s.id);
    renderPills('finalistPills', selectedFinalistIds, allFinalists, 'title');
    renderPills('judgePills', selectedJudgeIds, allJudges, 'name');
    renderPills('sponsorPills', selectedSponsorIds, allSponsors, 'name');

    toggleCaseStudyFields();
    updatePreview();
    openModal('edit');
  };

  window.deleteArticle = async function(id, title) {
    if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

    try {
      const response = await fetch('/api/admin/articles/', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id }),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      await loadArticles();
    } catch (error) {
      alert('Failed to delete article: ' + error.message);
    }
  };

  // ---- Form Submit ----

  document.getElementById('articleModalForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('articleId').value;
    const method = id ? 'PUT' : 'POST';

    // Get featured image from MediaSelector's exposed API
    let featured_image = '';
    const mediaSelector = document.querySelector('.media-selector-component');
    if (mediaSelector) {
      const sid = mediaSelector.getAttribute('data-selector-id');
      const getFn = sid && window[`getSelectedMedia_${sid}`];
      if (getFn) {
        const selected = getFn();
        if (selected && selected.length > 0) {
          featured_image = selected[0].file_url;
        }
      }
    }

    const body = {
      ...(id ? { id } : {}),
      title: document.getElementById('articleTitle').value,
      slug: document.getElementById('articleSlug').value,
      article_type: document.getElementById('articleType').value,
      excerpt: document.getElementById('articleExcerpt').value,
      content: document.getElementById('articleContent').value,
      author_name: document.getElementById('authorName').value,
      author_title: document.getElementById('authorTitle').value,
      company_name: document.getElementById('companyName').value,
      project_name: document.getElementById('projectName').value,
      category_name: document.getElementById('categoryName').value,
      edition: document.getElementById('edition').value,
      meta_title: document.getElementById('metaTitle').value,
      meta_description: document.getElementById('metaDescription').value,
      is_published: document.getElementById('isPublished').checked,
      published_at: document.getElementById('publishedAt').value ? new Date(document.getElementById('publishedAt').value).toISOString() : null,
      featured_image,
      sections,
      finalist_ids: selectedFinalistIds,
      judge_ids: selectedJudgeIds,
      sponsor_ids: selectedSponsorIds,
    };

    try {
      const response = await fetch('/api/admin/articles/', {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      closeModal();
      await loadArticles();
    } catch (error) {
      showError(error.message);
    }
  });

  // ---- Filter Events ----

  document.getElementById('searchInput').addEventListener('input', (e) => {
    filters.search = e.target.value;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(loadArticles, 300);
  });

  document.getElementById('typeFilter').addEventListener('change', (e) => {
    filters.type = e.target.value;
    loadArticles();
  });

  document.getElementById('statusFilter').addEventListener('change', (e) => {
    filters.status = e.target.value;
    loadArticles();
  });

  // ---- Modal Buttons ----

  document.getElementById('addArticleBtn').addEventListener('click', () => {
    closeModal();
    openModal('add');
  });

  document.getElementById('articleModalCloseBtn').addEventListener('click', closeModal);
  document.getElementById('articleModalCancelBtn').addEventListener('click', closeModal);

  // ---- Formatting Toolbar ----

  function showLinkDialog(textarea) {
    const selStart = textarea.selectionStart;
    const selEnd = textarea.selectionEnd;
    const selected = textarea.value.substring(selStart, selEnd);

    // Remove any existing dialog
    document.getElementById('linkDialog')?.remove();

    const dialog = document.createElement('div');
    dialog.id = 'linkDialog';
    dialog.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4)';
    dialog.innerHTML = `
      <div style="background:#fff;border-radius:8px;padding:1.5rem;width:380px;max-width:90vw;box-shadow:0 8px 30px rgba(0,0,0,0.2)">
        <p style="font-weight:600;font-size:0.9375rem;margin:0 0 1rem;color:#111827">Insert Link</p>
        <label style="display:block;font-size:0.8125rem;font-weight:500;color:#374151;margin-bottom:0.25rem">URL</label>
        <input id="linkDialogUrl" type="text" placeholder="https://example.com" style="width:100%;padding:0.5rem 0.625rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;margin-bottom:0.75rem;outline:none" />
        <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.8125rem;color:#374151;margin-bottom:1.25rem;cursor:pointer">
          <input id="linkDialogNewTab" type="checkbox" style="width:1rem;height:1rem;accent-color:#2563eb" />
          Open in new tab
        </label>
        <div style="display:flex;justify-content:flex-end;gap:0.5rem">
          <button id="linkDialogCancel" type="button" style="padding:0.4rem 1rem;border:1px solid #d1d5db;border-radius:6px;background:#fff;font-size:0.8125rem;cursor:pointer">Cancel</button>
          <button id="linkDialogInsert" type="button" style="padding:0.4rem 1rem;border:none;border-radius:6px;background:#2563eb;color:#fff;font-size:0.8125rem;font-weight:500;cursor:pointer">Insert</button>
        </div>
      </div>
    `;
    document.body.appendChild(dialog);

    const urlInput = document.getElementById('linkDialogUrl');
    urlInput.focus();

    function cleanup() { dialog.remove(); }

    document.getElementById('linkDialogCancel').addEventListener('click', cleanup);
    dialog.addEventListener('click', (e) => { if (e.target === dialog) cleanup(); });

    function insertLink() {
      const url = urlInput.value.trim();
      if (!url) { cleanup(); return; }
      const newTab = document.getElementById('linkDialogNewTab').checked;
      const open = newTab ? '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' : '<a href="' + url + '">';
      cleanup();
      // Restore selection and insert
      textarea.focus();
      textarea.selectionStart = selStart;
      textarea.selectionEnd = selEnd;
      const placeholder = selected || 'Link text';
      document.execCommand('insertText', false, open + placeholder + '</a>');
      textarea.selectionStart = selStart + open.length;
      textarea.selectionEnd = selStart + open.length + placeholder.length;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(updatePreview, 300);
    }

    document.getElementById('linkDialogInsert').addEventListener('click', insertLink);
    urlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); insertLink(); } });
  }

  // ---- Image Insert Dialog ----

  function showImageDialog(textarea) {
    const selStart = textarea.selectionStart;
    const selEnd = textarea.selectionEnd;

    document.getElementById('imageDialog')?.remove();

    let imgMedia = [];
    let imgOffset = 0;
    let imgHasMore = true;
    let imgLoading = false;
    let imgSearch = '';
    let selectedImgUrl = '';
    let selectedImgName = '';
    const IMG_LIMIT = 24;

    const dialog = document.createElement('div');
    dialog.id = 'imageDialog';
    dialog.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5)';
    dialog.innerHTML = `
      <div style="background:#fff;border-radius:12px;width:720px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 8px 30px rgba(0,0,0,0.25)">
        <div style="padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between">
          <h3 style="margin:0;font-size:1.125rem;font-weight:600;color:#111827">Insert Image</h3>
          <button id="imgDialogClose" type="button" style="background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:1.5rem;line-height:1">&times;</button>
        </div>
        <div style="display:flex;border-bottom:1px solid #e5e7eb">
          <button id="imgTabBrowse" type="button" class="img-tab-active" style="flex:1;padding:0.625rem;font-size:0.875rem;font-weight:500;border:none;border-bottom:2px solid #2563eb;color:#2563eb;background:none;cursor:pointer">Browse Media</button>
          <button id="imgTabUpload" type="button" style="flex:1;padding:0.625rem;font-size:0.875rem;font-weight:500;border:none;border-bottom:2px solid transparent;color:#6b7280;background:none;cursor:pointer">Upload New</button>
        </div>
        <div id="imgPanelBrowse" style="flex:1;overflow-y:auto;padding:1rem 1.5rem;min-height:300px;max-height:50vh">
          <input id="imgSearchInput" type="text" placeholder="Search media..." style="width:100%;padding:0.5rem 0.75rem;border:1px solid #d1d5db;border-radius:8px;font-size:0.875rem;margin-bottom:0.75rem;outline:none" />
          <div id="imgGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem">
            <div style="grid-column:1/-1;text-align:center;padding:2rem;color:#9ca3af;font-size:0.875rem">Loading media...</div>
          </div>
        </div>
        <div id="imgPanelUpload" style="flex:1;overflow-y:auto;padding:1.5rem;display:none;min-height:300px">
          <div id="imgDropZone" style="border:2px dashed #d1d5db;border-radius:12px;padding:3rem 2rem;text-align:center;cursor:pointer;transition:all 0.15s">
            <svg style="margin:0 auto 0.75rem;width:48px;height:48px;color:#9ca3af" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <p style="font-size:0.9375rem;font-weight:500;color:#374151;margin:0 0 0.25rem">Drop an image here or click to browse</p>
            <p style="font-size:0.8125rem;color:#9ca3af;margin:0">JPEG, PNG, WebP, GIF up to 10 MB</p>
            <input id="imgFileInput" type="file" accept="image/jpeg,image/png,image/webp,image/gif" style="display:none" />
          </div>
          <div id="imgUploadProgress" style="display:none;margin-top:1rem;text-align:center">
            <div style="width:100%;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden"><div id="imgProgressBar" style="width:0%;height:100%;background:#2563eb;transition:width 0.3s"></div></div>
            <p id="imgUploadStatus" style="font-size:0.8125rem;color:#6b7280;margin:0.5rem 0 0">Uploading...</p>
          </div>
        </div>
        <div style="padding:1rem 1.5rem;border-top:1px solid #e5e7eb;background:#f9fafb;border-radius:0 0 12px 12px">
          <div id="imgSelectedBar" style="display:none;margin-bottom:0.75rem;padding:0.5rem 0.75rem;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;align-items:center;gap:0.75rem">
            <img id="imgSelThumb" style="width:40px;height:40px;object-fit:cover;border-radius:4px" />
            <span id="imgSelName" style="font-size:0.8125rem;color:#1e40af;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
            <button id="imgSelClear" type="button" style="background:none;border:none;cursor:pointer;color:#6b7280;font-size:1.125rem;line-height:1;padding:2px 6px">&times;</button>
          </div>
          <label style="display:block;font-size:0.8125rem;font-weight:500;color:#374151;margin-bottom:0.25rem">Alt text</label>
          <input id="imgAltInput" type="text" placeholder="Describe the image..." style="width:100%;padding:0.5rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.875rem;margin-bottom:0.75rem;outline:none" />
          <div style="display:flex;justify-content:flex-end;gap:0.5rem">
            <button id="imgDialogCancel" type="button" style="padding:0.5rem 1rem;border:1px solid #d1d5db;border-radius:6px;background:#fff;font-size:0.8125rem;cursor:pointer">Cancel</button>
            <button id="imgDialogInsert" type="button" style="padding:0.5rem 1rem;border:none;border-radius:6px;background:#2563eb;color:#fff;font-size:0.8125rem;font-weight:500;cursor:pointer;opacity:0.5" disabled>Insert Image</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(dialog);

    const grid = document.getElementById('imgGrid');
    const insertBtn = document.getElementById('imgDialogInsert');
    const altInput = document.getElementById('imgAltInput');
    const selectedBar = document.getElementById('imgSelectedBar');

    // ---- Selection state ----

    function setSelectedImage(url, name) {
      selectedImgUrl = url;
      selectedImgName = name || '';
      if (url) {
        document.getElementById('imgSelThumb').src = url;
        document.getElementById('imgSelName').textContent = name || url.split('/').pop();
        selectedBar.style.display = 'flex';
        insertBtn.disabled = false;
        insertBtn.style.opacity = '1';
      } else {
        selectedBar.style.display = 'none';
        insertBtn.disabled = true;
        insertBtn.style.opacity = '0.5';
      }
    }

    document.getElementById('imgSelClear').addEventListener('click', (e) => {
      e.preventDefault();
      setSelectedImage('', '');
    });

    // ---- Tab switching ----

    const tabBrowse = document.getElementById('imgTabBrowse');
    const tabUpload = document.getElementById('imgTabUpload');
    const panelBrowse = document.getElementById('imgPanelBrowse');
    const panelUpload = document.getElementById('imgPanelUpload');

    tabBrowse.addEventListener('click', () => {
      panelBrowse.style.display = '';
      panelUpload.style.display = 'none';
      tabBrowse.style.borderBottomColor = '#2563eb';
      tabBrowse.style.color = '#2563eb';
      tabUpload.style.borderBottomColor = 'transparent';
      tabUpload.style.color = '#6b7280';
    });

    tabUpload.addEventListener('click', () => {
      panelBrowse.style.display = 'none';
      panelUpload.style.display = '';
      tabUpload.style.borderBottomColor = '#2563eb';
      tabUpload.style.color = '#2563eb';
      tabBrowse.style.borderBottomColor = 'transparent';
      tabBrowse.style.color = '#6b7280';
    });

    // ---- Browse Media ----

    async function loadImgMedia(append) {
      if (imgLoading) return;
      imgLoading = true;
      renderImgGrid();

      try {
        const params = new URLSearchParams({
          limit: IMG_LIMIT.toString(),
          offset: append ? imgOffset.toString() : '0',
          mimeTypes: 'image/jpeg,image/png,image/webp,image/gif'
        });
        const resp = await fetch('/api/media/?' + params);
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error);

        const items = data.media || [];
        if (append) {
          imgMedia = [...imgMedia, ...items];
        } else {
          imgMedia = items;
          imgOffset = 0;
        }
        imgOffset += items.length;
        imgHasMore = items.length === IMG_LIMIT;
      } catch (err) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#ef4444;font-size:0.875rem">Failed to load media</div>';
      } finally {
        imgLoading = false;
        renderImgGrid();
      }
    }

    function renderImgGrid() {
      const filtered = imgSearch
        ? imgMedia.filter(m =>
            (m.title || '').toLowerCase().includes(imgSearch) ||
            (m.filename || '').toLowerCase().includes(imgSearch) ||
            (m.original_filename || '').toLowerCase().includes(imgSearch)
          )
        : imgMedia;

      if (filtered.length === 0 && !imgLoading) {
        grid.innerHTML = imgMedia.length === 0
          ? '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#9ca3af;font-size:0.875rem">No images found. Upload one using the Upload tab.</div>'
          : '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:#9ca3af;font-size:0.875rem">No images match your search.</div>';
        return;
      }

      const cards = filtered.map(m => {
        const isSelected = m.file_url === selectedImgUrl;
        return `<button type="button" data-img-url="${m.file_url}" data-img-name="${m.title || m.filename || ''}" style="border:2px solid ${isSelected ? '#2563eb' : '#e5e7eb'};border-radius:8px;overflow:hidden;cursor:pointer;background:${isSelected ? '#eff6ff' : '#fff'};padding:0;text-align:left;transition:border-color 0.15s" class="img-pick-btn">
          <img src="${m.file_url}" alt="${m.title || m.filename}" style="width:100%;aspect-ratio:1;object-fit:cover" />
          <div style="padding:0.375rem 0.5rem">
            <p style="font-size:0.6875rem;font-weight:500;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#374151">${m.title || m.filename}</p>
          </div>
        </button>`;
      }).join('');

      const loadMore = (!imgSearch && imgHasMore) ? `
        <div style="grid-column:1/-1;text-align:center;padding:0.75rem">
          <button type="button" id="imgLoadMore" style="padding:0.5rem 1.25rem;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:0.8125rem;cursor:pointer${imgLoading ? ';opacity:0.5' : ''}"${imgLoading ? ' disabled' : ''}>${imgLoading ? 'Loading...' : 'Load More'}</button>
        </div>` : '';

      grid.innerHTML = cards + loadMore;

      grid.querySelectorAll('.img-pick-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          setSelectedImage(btn.dataset.imgUrl, btn.dataset.imgName);
          renderImgGrid();
        });
      });

      const loadMoreBtn = document.getElementById('imgLoadMore');
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', (e) => {
          e.preventDefault();
          loadImgMedia(true);
        });
      }
    }

    // Search
    let imgSearchTimer = null;
    document.getElementById('imgSearchInput').addEventListener('input', (e) => {
      clearTimeout(imgSearchTimer);
      imgSearchTimer = setTimeout(() => {
        imgSearch = e.target.value.toLowerCase().trim();
        renderImgGrid();
      }, 200);
    });

    // Initial load
    loadImgMedia(false);

    // ---- Upload New ----

    const dropZone = document.getElementById('imgDropZone');
    const fileInput = document.getElementById('imgFileInput');
    const progressWrap = document.getElementById('imgUploadProgress');
    const progressBar = document.getElementById('imgProgressBar');
    const uploadStatus = document.getElementById('imgUploadStatus');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#2563eb';
      dropZone.style.background = '#eff6ff';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) handleUpload(file);
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) handleUpload(fileInput.files[0]);
    });

    async function handleUpload(file) {
      if (file.size > 10 * 1024 * 1024) {
        uploadStatus.textContent = 'File too large (max 10 MB)';
        uploadStatus.style.color = '#ef4444';
        return;
      }

      dropZone.style.display = 'none';
      progressWrap.style.display = '';
      progressBar.style.width = '20%';
      uploadStatus.textContent = 'Reading file...';
      uploadStatus.style.color = '#6b7280';

      try {
        // Convert file to base64
        const base64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        progressBar.style.width = '50%';
        uploadStatus.textContent = 'Uploading to media library...';

        const resp = await fetch('/api/media/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            file: base64,
            filename: file.name,
            mimeType: file.type,
            title: file.name.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ')
          })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Upload failed');

        progressBar.style.width = '100%';
        uploadStatus.textContent = 'Upload complete!';
        uploadStatus.style.color = '#059669';

        // Select the uploaded image
        setSelectedImage(data.fileUrl, file.name);

        // Auto-fill alt text from filename if empty
        if (!altInput.value) {
          altInput.value = file.name.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ');
        }

        // Reset upload UI after a moment
        setTimeout(() => {
          dropZone.style.display = '';
          progressWrap.style.display = 'none';
          progressBar.style.width = '0%';
        }, 1500);

      } catch (err) {
        progressBar.style.width = '0%';
        uploadStatus.textContent = 'Upload failed: ' + err.message;
        uploadStatus.style.color = '#ef4444';
        setTimeout(() => {
          dropZone.style.display = '';
          progressWrap.style.display = 'none';
        }, 3000);
      }
    }

    // ---- Insert / Cancel / Close ----

    function cleanup() { dialog.remove(); }

    document.getElementById('imgDialogClose').addEventListener('click', cleanup);
    document.getElementById('imgDialogCancel').addEventListener('click', cleanup);
    dialog.addEventListener('click', (e) => { if (e.target === dialog) cleanup(); });

    insertBtn.addEventListener('click', () => {
      if (!selectedImgUrl) return;
      const alt = altInput.value.trim() || '';
      cleanup();

      textarea.focus();
      textarea.selectionStart = selStart;
      textarea.selectionEnd = selEnd;

      const imgTag = '\n<img src="' + selectedImgUrl + '" alt="' + alt.replace(/"/g, '&quot;') + '" />\n';
      document.execCommand('insertText', false, imgTag);

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(updatePreview, 300);
    });

    // Focus alt input for keyboard accessibility
    altInput.focus();
  }

  function wrapSelection(before, after) {
    const textarea = document.getElementById('articleContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    const placeholder = selected || 'Your text here';
    const replacement = before + placeholder + after;

    // Use execCommand so the insertion is part of the browser's undo stack (Ctrl+Z works)
    textarea.focus();
    textarea.selectionStart = start;
    textarea.selectionEnd = end;
    document.execCommand('insertText', false, replacement);

    // Select the inner content so user can immediately type over it
    textarea.selectionStart = start + before.length;
    textarea.selectionEnd = start + before.length + placeholder.length;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, 300);
  }

  document.querySelectorAll('[data-format]').forEach(btn => {
    btn.addEventListener('click', () => {
      const format = btn.dataset.format;
      const textarea = document.getElementById('articleContent');
      const selected = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();

      switch (format) {
        case 'bold':
          wrapSelection('<strong>', '</strong>');
          break;
        case 'italic':
          wrapSelection('<em>', '</em>');
          break;
        case 'link':
          showLinkDialog(textarea);
          break;
        case 'image':
          showImageDialog(textarea);
          break;
        case 'h2':
          wrapSelection('\n<h2>', '</h2>\n');
          break;
        case 'h3':
          wrapSelection('\n<h3>', '</h3>\n');
          break;
        case 'quote':
          wrapSelection(
            '\n<div class="quote-callout">\n  <span class="quote-icon">&ldquo;</span>\n  <p class="quote-text">',
            '</p>\n  <p class="quote-attribution">&mdash; Author Name, Title</p>\n</div>\n'
          );
          break;
        case 'advice':
          wrapSelection(
            '\n<div class="studio-advice-box">\n  <h3>Key Takeaway</h3>\n  <p>',
            '</p>\n</div>\n'
          );
          break;
        case 'hr':
          wrapSelection('\n<hr>\n', '');
          break;
        case 'cta':
          wrapSelection(
            '\n<div class="article-cta">\n  <h3>',
            '</h3>\n  <p>Supporting text here.</p>\n  <a href="#dynamic" class="article-cta-btn">Dynamic CTA</a>\n</div>\n'
          );
          break;
        case 'ctaBtn':
          wrapSelection(
            '\n<a href="/your-link/" class="article-inline-btn">',
            '</a>\n'
          );
          break;
        case 'numbered': {
          const count = (textarea.value.match(/number-badge/g) || []).length + 1;
          wrapSelection(
            `\n<div class="numbered-item">\n  <div class="number-badge">${count}</div>\n  <div class="numbered-content">\n    <h4>`,
            `</h4>\n    <p>Description here.</p>\n  </div>\n</div>\n`
          );
          break;
        }
      }
    });
  });

  // ---- Load CDN libraries for preview ----

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initPreviewLibs() {
    try {
      await loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js');
      // sanitize-html CDN is large; we'll rely on server-side sanitization for production
      // For admin preview, marked output is sufficient
    } catch (err) {
      console.warn('Preview libraries failed to load:', err);
    }
  }

  // ---- Initialize ----

  loadArticles();
  loadRelationshipEntities();
  initPreviewLibs();
</script>

<style>
  @import "tailwindcss";

  .toolbar-btn {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background: white;
    border: 1px solid #d1d5db;
    cursor: pointer;
    line-height: 1.5;
    min-width: 1.75rem;
    text-align: center;
    transition: background-color 0.1s;
  }
  .toolbar-btn:hover {
    background: #e5e7eb;
  }

</style>

<!-- Global styles for dynamically injected preview content (innerHTML doesn't get Astro scoping attributes) -->
<style is:global>
  #contentPreview .article-prose {
    overflow-wrap: break-word;
    word-break: break-word;
  }

  /* Scale down for preview panel */
  #contentPreview .article-prose h2 {
    font-size: 1.375rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  #contentPreview .article-prose h3 {
    font-size: 1.125rem;
    margin-top: 1.5rem;
  }

  #contentPreview .article-prose p {
    margin-bottom: 1em;
  }

  #contentPreview .section-marker {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }

  #contentPreview .section-marker h2 {
    font-size: 1.125rem;
  }

  #contentPreview .quote-callout {
    margin: 1.5rem 0;
    padding: 1.75rem 1.5rem 1.25rem;
  }

  #contentPreview .quote-icon {
    font-size: 4rem;
    left: -0.5rem;
  }

  #contentPreview .quote-text {
    font-size: 1.1rem;
  }

  #contentPreview .studio-advice-box {
    margin: 1.5rem 0;
    padding: 1.5rem;
    padding-top: 2rem;
  }

  #contentPreview .studio-advice-box h3 {
    font-size: 0.9375rem;
    top: -0.625rem;
  }

  #contentPreview img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }

  #contentPreview .number-badge {
    width: 28px;
    height: 28px;
    font-size: 0.875rem;
  }

  #contentPreview .numbered-item {
    gap: 0.75rem;
    margin-bottom: 1.25rem;
  }

  #contentPreview .article-prose hr {
    border: none;
    height: 1px;
    background: #E5E7EB;
    margin: 2rem 0;
  }

  #contentPreview .article-cta {
    margin: 1.5rem 0;
    padding: 1.5rem 1.25rem;
    border-radius: 0.5rem;
  }

  #contentPreview .article-cta h3 {
    font-size: 1.125rem;
    color: #FFFFFF;
    margin-top: 0;
  }

  #contentPreview .article-cta p {
    font-size: 0.875rem;
    color: #9CA3AF;
  }

  #contentPreview .article-cta-btn {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    border-radius: 0.375rem;
  }

  #contentPreview .article-inline-btn {
    padding: 0.4rem 0.875rem;
    font-size: 0.8125rem;
    border-radius: 0.375rem;
  }
</style>
