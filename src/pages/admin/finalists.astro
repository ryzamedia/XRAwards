---
/**
 * Admin Finalists Management Page
 */
 import AdminLayout from '../../components/admin/AdminLayout.astro';
import Modal from '../../components/admin/Modal.astro';
import MediaSelector from '../../components/admin/MediaSelector.astro';


---

<AdminLayout title="Finalists" activePage="finalists">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Finalists</h1>
        <p class="mt-2 text-gray-600">Manage award finalists and winners</p>
      </div>
      <button
        id="addFinalistBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
     >
        + Add Finalist
      </button>
    </div>

    <!-- Filter -->
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex flex-wrap gap-4">
        <input
          type="text"
          id="searchInput"
          placeholder="Search finalists..."
          class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500 min-w-64"
        />
        <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Categories</option>
        </select>
        <select id="eventFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All Events</option>
        </select>
        <select id="winnerFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500">
          <option value="">All</option>
          <option value="winners">Winners Only</option>
          <option value="finalists">Finalists Only</option>
        </select>
      </div>
    </div>

    <!-- Finalists List -->
    <div id="finalistsList" class="space-y-4">
      <!-- Loading state -->
      <div class="text-center py-12">
        <p class="text-gray-500">Loading finalists...</p>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <Modal id="finalistModal" title="Add Finalist">
      <form id="finalistModalForm" class="space-y-6 max-w-full">
          <input type="hidden" id="finalistId" name="id" />
          
          <!-- Basic Info Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Basic Information</h3>

            <div>
              <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                Title *
              </label>
              <input
                type="text"
                id="title"
                name="title"
                required
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., Amazing VR Adventure"
              />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="min-w-0">
                <label for="category_id" class="block text-sm font-medium text-gray-700 mb-1">
                  Category *
                </label>
                <div class="searchable-dropdown" data-select-id="category_id">
                  <button
                    type="button"
                    id="category_id_btn"
                    class="w-full px-2.5 py-2 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  >
                    <span id="category_id_text" class="text-gray-400">Select a category...</span>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  <input type="hidden" id="category_id" name="category_id" required />
                  <div id="category_id_dropdown" class="hidden absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-gray-300 max-h-60 overflow-hidden">
                    <div class="px-2 py-1 border-b border-gray-200">
                      <input
                        type="text"
                        id="category_id_search"
                        placeholder="Search..."
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div id="category_id_options" class="max-h-48 overflow-y-auto">
                      <!-- Options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>

              <div class="min-w-0">
                <label for="organization" class="block text-sm font-medium text-gray-700 mb-1">
                  Organization / Company
                </label>
                <input
                  type="text"
                  id="organization"
                  name="organization"
                  class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  placeholder="e.g., Meta, Unity, etc."
                />
              </div>
            </div>

            <div>
              <label for="finalistDescription" class="block text-sm font-medium text-gray-700 mb-1">
                Description
              </label>
              <textarea
                id="finalistDescription"
                name="description"
                rows="3"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="Brief description..."
             ></textarea>
            </div>

            <div>
              <label for="website_url" class="block text-sm font-medium text-gray-700 mb-1">
                Website URL
              </label>
              <input
                type="url"
                id="website_url"
                name="website_url"
                class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                placeholder="https://..."
              />
              <p class="text-xs text-gray-500 mt-1">Project or company site</p>
            </div>
          </div>

          <!-- Media Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Media</h3>

            <MediaSelector 
              multiple={false}
              label="Finalist Image"
              helpText="Select one image for this finalist"
            />
          </div>

          <!-- Award Details Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Award Details</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="min-w-0">
                <label for="event_id" class="block text-sm font-medium text-gray-700 mb-1">
                  Event *
                </label>
                <div class="searchable-dropdown relative" data-select-id="event_id">
                  <button
                    type="button"
                    id="event_id_btn"
                    class="w-full px-2.5 py-2 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  >
                    <span id="event_id_text" class="text-gray-400">Select event...</span>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  <input type="hidden" id="event_id" name="event_id" required />
                  <div id="event_id_dropdown" class="hidden absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-gray-300 max-h-60 overflow-hidden">
                    <div class="px-2 py-1 border-b border-gray-200">
                      <input
                        type="text"
                        id="event_id_search"
                        placeholder="Search..."
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div id="event_id_options" class="max-h-48 overflow-y-auto">
                      <!-- Options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>

              <div class="min-w-0">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Winner
                </label>
                <label class="flex items-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                  <input
                    type="checkbox"
                    id="is_winner"
                    name="is_winner"
                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  />
                  <span class="text-sm text-gray-700">Winner</span>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Awarded Accolades
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <!-- Selected accolades display -->
                <div id="selectedFinalistAccolades" class="flex flex-wrap gap-2 mb-2"></div>
                
                <!-- Accolade selector -->
                <div class="searchable-dropdown relative" data-select-id="finalistAccoladeSelector">
                  <button
                    type="button"
                    id="finalistAccoladeSelector_btn"
                    class="w-full px-3 py-2 border border-gray-200 rounded text-sm bg-white text-left flex items-center justify-between focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  >
                    <span id="finalistAccoladeSelector_text" class="text-gray-400">+ Add an accolade</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  <div id="finalistAccoladeSelector_dropdown" class="hidden absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-gray-300 max-h-60 overflow-hidden">
                    <div class="px-2 py-1 border-b border-gray-200">
                      <input
                        type="text"
                        id="finalistAccoladeSelector_search"
                        placeholder="Search..."
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div id="finalistAccoladeSelector_options" class="max-h-48 overflow-y-auto">
                      <!-- Options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-1">Select accolades awarded to this finalist (filtered by category)</p>
            </div>
          </div>

          <!-- Tags Section -->
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Tags</h3>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Tags
              </label>
              <div class="border border-gray-300 rounded-lg p-3 min-h-[80px]">
                <!-- Selected tags display -->
                <div id="selectedFinalistTags" class="flex flex-wrap gap-2 mb-2"></div>
                
                <!-- Tag selector -->
                <div class="searchable-dropdown relative" data-select-id="finalistTagSelector">
                  <button
                    type="button"
                    id="finalistTagSelector_btn"
                    class="w-full px-3 py-2 border border-gray-200 rounded text-sm bg-white text-left flex items-center justify-between focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                  >
                    <span id="finalistTagSelector_text" class="text-gray-400">+ Add a tag</span>
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  <div id="finalistTagSelector_dropdown" class="hidden absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg border border-gray-300 max-h-60 overflow-hidden">
                    <div class="px-2 py-1 border-b border-gray-200">
                      <input
                        type="text"
                        id="finalistTagSelector_search"
                        placeholder="Search..."
                        class="w-full px-4 py-3 text-sm border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div id="finalistTagSelector_options" class="max-h-48 overflow-y-auto">
                      <!-- Options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contacts Section -->
          <div class="space-y-4">
            <div class="flex items-center justify-between border-b pb-2">
              <h3 class="text-lg font-medium text-gray-900">Contacts</h3>
              <button
                type="button"
                id="addFinalistContactBtn"
                class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                + Add Contact
              </button>
            </div>

            <div id="finalistContactsList" class="space-y-2">
              <!-- Contacts will be populated here -->
            </div>
          </div>
      </form>
    </Modal>
  </div>
</AdminLayout>

<script>
  let finalists: any[] = [];
  let categories: any[] = [];
  let events: any[] = [];
  let availableTags: any[] = [];
  let allAccolades: any[] = []; // All accolades (flat)
  let availableAccolades: any[] = []; // Accolades available for selected category
  let selectedFinalistTags: any[] = [];
  let selectedFinalistAccolades: any[] = [];
  let mediaSelectorId: string = '';
  let filters = { category: '', event: '', winner: '', search: '' };
  let pagination = { page: 1, limit: 50, total: 0, totalPages: 0 };
  let isLoading = false;

  // Load tags
  async function loadTags() {
    try {
      const response = await fetch('/api/tags/');
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      
      availableTags = data.tags || [];
      updateFinalistTagSelector();
    } catch (error) {
      console.error('Error loading tags:', error);
    }
  }

  // Update tag selector dropdown
  function updateFinalistTagSelector() {
    const selectedIds = selectedFinalistTags.map(t => t.id);
    const options = availableTags
      .filter(tag => !selectedIds.includes(tag.id))
      .map(tag => ({ id: tag.id, text: tag.name }));
    
    if ((window as any).updateDropdown_finalistTagSelector) {
      (window as any).updateDropdown_finalistTagSelector(options);
    }
  }

  // Custom searchable dropdown functions
  function initSearchableDropdown(dropdownId: string) {
    const container = document.querySelector(`[data-select-id="${dropdownId}"]`) as HTMLElement;
    if (!container) return;
    
    const button = document.getElementById(`${dropdownId}_btn`) as HTMLButtonElement;
    const dropdown = document.getElementById(`${dropdownId}_dropdown`) as HTMLElement;
    const searchInput = document.getElementById(`${dropdownId}_search`) as HTMLInputElement;
    const optionsContainer = document.getElementById(`${dropdownId}_options`) as HTMLElement;
    const hiddenInput = document.getElementById(dropdownId) as HTMLInputElement;
    const textSpan = document.getElementById(`${dropdownId}_text`) as HTMLElement;
    
    if (!button || !dropdown || !optionsContainer) return;
    
    let isOpen = false;
    let allOptions: { id: string; text: string }[] = [];
    let filteredOptions: { id: string; text: string }[] = [];
    
    // Toggle dropdown
    const toggleDropdown = () => {
      isOpen = !isOpen;
      if (isOpen) {
        dropdown.classList.remove('hidden');
        if (searchInput) {
          setTimeout(() => searchInput.focus(), 0);
        }
      } else {
        dropdown.classList.add('hidden');
        if (searchInput) {
          searchInput.value = '';
          filteredOptions = [...allOptions];
          renderOptions();
        }
      }
    };
    
    // Render options
    const renderOptions = () => {
      if (filteredOptions.length === 0) {
        optionsContainer.innerHTML = '<div class="px-4 py-3 text-sm text-gray-500">No options found</div>';
        return;
      }
      
      optionsContainer.innerHTML = filteredOptions.map(opt => `
        <div
          class="px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer"
          data-value="${opt.id}"
        >
          ${escapeHtml(opt.text)}
        </div>
      `).join('');
      
      // Add click handlers
      optionsContainer.querySelectorAll('[data-value]').forEach(el => {
        el.addEventListener('click', (e) => {
          const value = (e.currentTarget as HTMLElement).dataset.value || '';
          const option = allOptions.find(o => o.id === value);
          if (option) {
            selectOption(option);
          }
        });
      });
    };
    
    // Select an option
    const selectOption = (option: { id: string; text: string }) => {
      if (hiddenInput) {
        hiddenInput.value = option.id;
      }
      if (textSpan) {
        textSpan.textContent = option.text;
        textSpan.classList.remove('text-gray-400');
        textSpan.classList.add('text-gray-900');
      }
      toggleDropdown();
      
      // Trigger change event for existing handlers
      if (dropdownId === 'category_id') {
        const event = new Event('change', { bubbles: true });
        if (hiddenInput) hiddenInput.dispatchEvent(event);
      } else if (dropdownId === 'event_id') {
        const event = new Event('change', { bubbles: true });
        if (hiddenInput) hiddenInput.dispatchEvent(event);
      } else if (dropdownId === 'finalistAccoladeSelector') {
        (window as any).addFinalistAccolade(option.id);
      } else if (dropdownId === 'finalistTagSelector') {
        (window as any).addFinalistTag(option.id);
      }
    };
    
    // Update options
    const updateOptions = (options: { id: string; text: string }[]) => {
      allOptions = options;
      filteredOptions = [...allOptions];
      renderOptions();
    };
    
    // Search filter
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const term = (e.target as HTMLInputElement).value.toLowerCase().trim();
        filteredOptions = allOptions.filter(opt => 
          opt.text.toLowerCase().includes(term)
        );
        renderOptions();
      });
    }
    
    // Button click
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDropdown();
    });
    
    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!container.contains(e.target as Node)) {
        if (isOpen) {
          toggleDropdown();
        }
      }
    });
    
    // Store update function
    (window as any)[`updateDropdown_${dropdownId}`] = updateOptions;
    (window as any)[`setDropdownValue_${dropdownId}`] = (value: string, text: string) => {
      if (hiddenInput) hiddenInput.value = value;
      if (textSpan) {
        textSpan.textContent = text;
        textSpan.classList.remove('text-gray-400');
        textSpan.classList.add('text-gray-900');
      }
    };
    (window as any)[`clearDropdown_${dropdownId}`] = () => {
      if (hiddenInput) hiddenInput.value = '';
      if (textSpan) {
        const placeholder = dropdownId === 'category_id' ? 'Select a category...' :
                          dropdownId === 'event_id' ? 'Select event...' :
                          dropdownId === 'finalistAccoladeSelector' ? '+ Add an accolade' :
                          '+ Add a tag';
        textSpan.textContent = placeholder;
        textSpan.classList.remove('text-gray-900');
        textSpan.classList.add('text-gray-400');
      }
    };
  }

  // Render selected tags as badges
  function renderSelectedFinalistTags() {
    const container = document.getElementById('selectedFinalistTags')!;
    
    if (selectedFinalistTags.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-400 italic">No tags selected</p>';
      return;
    }
    
    container.innerHTML = selectedFinalistTags.map(tag => `
      <span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
        ${tag.name}
        <button
          type="button"
          onclick="removeFinalistTag('${tag.id}')"
          class="hover:bg-blue-200 rounded-full p-0.5 transition-colors"
       >
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </span>
    `).join('');
  }

  // Add tag
  (window as any).addFinalistTag = (tagId: string) => {
    if (!tagId) return;
    
    const tag = availableTags.find(t => t.id === tagId);
    if (!tag) return;
    
    if (!selectedFinalistTags.find(t => t.id === tagId)) {
      selectedFinalistTags.push(tag);
      renderSelectedFinalistTags();
      updateFinalistTagSelector();
    }
  };

  // Remove tag
  (window as any).removeFinalistTag = (tagId: string) => {
    selectedFinalistTags = selectedFinalistTags.filter(t => t.id !== tagId);
    renderSelectedFinalistTags();
    updateFinalistTagSelector();
  };

  // Load all accolades
  async function loadAccolades() {
    try {
      const response = await fetch('/api/accolades/?flat=true');
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);
      
      allAccolades = data.accolades || [];
    } catch (error) {
      console.error('Error loading accolades:', error);
    }
  }

  // Update available accolades based on selected category
  function updateAvailableAccolades(categoryId: string) {
    if (!categoryId) {
      availableAccolades = [];
      updateFinalistAccoladeSelector();
      return;
    }

    // Find the category and its associated accolade types (level 1 - no parent)
    const category = categories.find(c => c.id === categoryId);
    if (!category || !category.accolades || category.accolades.length === 0) {
      availableAccolades = [];
      updateFinalistAccoladeSelector();
      return;
    }

    // Get the level 1 accolade type IDs for this category
    const typeIds = category.accolades.map((a: any) => a.id);

    // Find all level 2 accolades (individual accolades - children of the category's accolade types)
    availableAccolades = allAccolades.filter(acc => 
      acc.parent_id && typeIds.includes(acc.parent_id)
    );

    updateFinalistAccoladeSelector();
  }

  // Update accolade selector dropdown
  function updateFinalistAccoladeSelector() {
    const selectedIds = selectedFinalistAccolades.map(a => a.id);
    
    if (availableAccolades.length === 0) {
      if ((window as any).updateDropdown_finalistAccoladeSelector) {
        (window as any).updateDropdown_finalistAccoladeSelector([]);
      }
      return;
    }
    
    const options = availableAccolades
      .filter(acc => !selectedIds.includes(acc.id))
      .map(acc => ({ id: acc.id, text: `${acc.code} - ${acc.name}` }));
    
    if ((window as any).updateDropdown_finalistAccoladeSelector) {
      (window as any).updateDropdown_finalistAccoladeSelector(options);
    }
  }

  // Render selected accolades as badges
  function renderSelectedFinalistAccolades() {
    const container = document.getElementById('selectedFinalistAccolades')!;
    if (!container) return;
    
    if (selectedFinalistAccolades.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-400 italic">No accolades awarded</p>';
      return;
    }
    
    container.innerHTML = selectedFinalistAccolades.map(acc => `
      <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-800 rounded-full text-sm">
        ${acc.code} - ${acc.name}
        <button
          type="button"
          onclick="removeFinalistAccolade('${acc.id}')"
          class="hover:bg-amber-200 rounded-full p-0.5 transition-colors"
       >
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </span>
    `).join('');
  }

  // Add accolade
  (window as any).addFinalistAccolade = (accoladeId: string) => {
    if (!accoladeId) return;
    
    const accolade = availableAccolades.find(a => a.id === accoladeId);
    if (!accolade) return;
    
    if (!selectedFinalistAccolades.find(a => a.id === accoladeId)) {
      selectedFinalistAccolades.push(accolade);
      renderSelectedFinalistAccolades();
      updateFinalistAccoladeSelector();
    }
  };

  // Remove accolade
  (window as any).removeFinalistAccolade = (accoladeId: string) => {
    selectedFinalistAccolades = selectedFinalistAccolades.filter(a => a.id !== accoladeId);
    renderSelectedFinalistAccolades();
    updateFinalistAccoladeSelector();
  };

  // Handle tag selector change
  document.addEventListener('astro:page-load', () => {
    const tagSelector = document.getElementById('finalistTagSelector') as HTMLSelectElement;
    tagSelector?.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      (window as any).addFinalistTag(target.value);
      target.value = '';
    });

    const accoladeSelector = document.getElementById('finalistAccoladeSelector') as HTMLSelectElement;
    accoladeSelector?.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      (window as any).addFinalistAccolade(target.value);
      target.value = '';
    });

    // Update accolades when category changes
    const categorySelect = document.getElementById('category_id') as HTMLSelectElement;
    categorySelect?.addEventListener('change', (e) => {
      const target = e.target as HTMLSelectElement;
      // Clear selected accolades when category changes
      selectedFinalistAccolades = [];
      renderSelectedFinalistAccolades();
      updateAvailableAccolades(target.value);
    });

    // Get MediaSelector ID
    const selectorElement = document.querySelector('.media-selector-component') as HTMLElement;
    if (selectorElement) {
      mediaSelectorId = selectorElement.dataset.selectorId || '';
    }
    
    // Initialize custom searchable dropdowns
    initSearchableDropdown('category_id');
    initSearchableDropdown('event_id');
    initSearchableDropdown('finalistAccoladeSelector');
    initSearchableDropdown('finalistTagSelector');
    
    // Handle category change for accolades
    const categoryInput = document.getElementById('category_id') as HTMLInputElement;
    categoryInput?.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      selectedFinalistAccolades = [];
      renderSelectedFinalistAccolades();
      updateAvailableAccolades(target.value);
    });
  });

  // Load events
  async function loadEvents() {
    try {
      const response = await fetch('/api/events/');
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      events = data.events || [];

      // Populate event filter
      const eventFilter = document.getElementById('eventFilter')!;

      events.forEach(evt => {
        const option1 = document.createElement('option');
        option1.value = evt.id;
        option1.textContent = `${evt.event_name} (${evt.event_year})`;
        eventFilter.appendChild(option1);
      });
      
      // Update custom dropdown
      const eventOptions = events.map(evt => ({
        id: evt.id,
        text: `${evt.event_name} (${evt.event_year})`
      }));
      if ((window as any).updateDropdown_event_id) {
        (window as any).updateDropdown_event_id(eventOptions);
      }
    } catch (error) {
      console.error('Error loading events:', error);
    }
  }

  // Load categories
  async function loadCategories() {
    try {
      const response = await fetch('/api/categories/');
      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      categories = data.categories || [];

      // Populate category filter
      const categoryFilter = document.getElementById('categoryFilter')!;
      const categorySelect = document.getElementById('category_id')!;

      categories.forEach(cat => {
        const option1 = document.createElement('option');
        option1.value = cat.id;
        option1.textContent = cat.name;
        categoryFilter.appendChild(option1);
      });
      
      // Update custom dropdown
      const categoryOptions = categories.map(cat => ({
        id: cat.id,
        text: cat.name
      }));
      if ((window as any).updateDropdown_category_id) {
        (window as any).updateDropdown_category_id(categoryOptions);
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  // Load finalists with pagination and filters
  async function loadFinalists(page = 1) {
    if (isLoading) return;
    
    isLoading = true;
    const list = document.getElementById('finalistsList')!;
    list.innerHTML = `
      <div class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="text-gray-500 mt-2">Loading finalists...</p>
      </div>
    `;
    
    try {
      // Build query parameters
      const params = new URLSearchParams({
        page: page.toString(),
        limit: pagination.limit.toString(),
        ...(filters.search && { search: filters.search }),
        ...(filters.category && { category: filters.category }),
        ...(filters.event && { event: filters.event }),
        ...(filters.winner && { winner: filters.winner })
      });

      const response = await fetch(`/api/finalists/?${params}`);
      const data = await response.json();
      
      if (!response.ok) throw new Error(data.error);
      
      finalists = data.finalists || [];
      pagination = data.pagination || { page: 1, limit: 50, total: 0, totalPages: 0 };
      renderFinalists();
    } catch (error: any) {
      const list = document.getElementById('finalistsList')!;
      list.innerHTML = `
        <div class="text-center py-12">
          <p class="text-red-600">Error loading finalists: ${error.message}</p>
        </div>
      `;
    } finally {
      isLoading = false;
    }
  }

  // Helper to escape HTML for safe display
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Helper to convert newlines to HTML
  function nl2br(text: string | null | undefined): string {
    if (!text) return '';
    const paragraphs = text.split(/\n\n+/);
    return paragraphs
      .map(para => para.trim())
      .filter(para => para.length> 0)
      .map(para => `<p class="mb-3 last:mb-0">${escapeHtml(para).replace(/\n/g, '<br>')}</p>`)
      .join('');
  }

  // Filter finalists (now handled server-side, but keeping for compatibility)
  function getFilteredFinalists() {
    return finalists;
  }

  // Render finalists with pagination
  function renderFinalists() {
    const list = document.getElementById('finalistsList')!;
    const filtered = getFilteredFinalists();
    
    if (filtered.length === 0) {
      list.innerHTML = `
        <div class="text-center py-12">
          <p class="text-gray-500">No finalists found. ${pagination.total > 0 ? 'Try adjusting filters.' : 'Add your first finalist!'}</p>
        </div>
      `;
      return;
    }

    let html = filtered.map(finalist => `
      <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-sm transition-shadow">
        <div class="flex items-start gap-4">
          ${finalist.image_url ? `
            <img src="${escapeHtml(finalist.image_url)}" alt="${escapeHtml(finalist.title)}" loading="lazy" class="w-24 h-24 object-cover rounded-lg" />
          ` : `
            <div class="w-24 h-24 bg-gray-100 rounded-lg flex items-center justify-center">
              <span class="text-gray-400 text-xs">No image</span>
            </div>
          `}
          <div class="flex-1">
            <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(finalist.title)}</h3>
              ${finalist.organization ? `<p class="text-sm text-gray-500">${escapeHtml(finalist.organization)}</p>` : ''}
              <p class="text-sm text-gray-600 mt-1">
                ${finalist.categories?.name ? escapeHtml(finalist.categories.name) : 'Uncategorized'}
                ${finalist.event_details ? ` • ${finalist.event_details.event_year}` : ''}
                ${finalist.is_winner ? ' • <span class="text-yellow-600 font-medium">Winner</span>' : ''}
              </p>
              ${finalist.accolades && finalist.accolades.length > 0 ? `
                <div class="flex flex-wrap gap-1 mt-2">
                  ${finalist.accolades.map((acc: any) => `<span class="inline-flex px-2 py-0.5 bg-amber-100 text-amber-800 rounded text-xs">${escapeHtml(acc.code)}</span>`).join('')}
                </div>
              ` : ''}
              <p class="text-xs text-gray-400 mt-1 font-mono">ID: ${finalist.id}</p>
              ${finalist.description ? `<div class="text-sm text-gray-600 mt-2">${nl2br(finalist.description)}</div>` : ''}
              ${finalist.website_url ? `<a href="${escapeHtml(finalist.website_url)}" target="_blank" class="text-xs text-blue-600 hover:underline mt-1 inline-block">${escapeHtml(finalist.website_url)}</a>` : ''}
            </div>
            </div>
            <div class="flex space-x-2 mt-4">
              <button
                onclick="editFinalist('${finalist.id}')"
                class="px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
             >
                Edit
              </button>
              <button
                onclick="deleteFinalist('${finalist.id}', '${escapeHtml(finalist.title)}')"
                class="px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors"
             >
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `).join('');

    // Add pagination controls
    if (pagination.totalPages > 1) {
      html += `
        <div class="mt-8 flex items-center justify-between bg-white border border-gray-200 rounded-lg p-4">
          <div class="text-sm text-gray-700">
            Showing ${((pagination.page - 1) * pagination.limit) + 1} to ${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total} results
          </div>
          <div class="flex items-center space-x-2">
            <button
              onclick="loadFinalists(${pagination.page - 1})"
              ${pagination.page <= 1 ? 'disabled' : ''}
              class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Previous
            </button>
            <span class="px-3 py-2 text-sm text-gray-700">
              Page ${pagination.page} of ${pagination.totalPages}
            </span>
            <button
              onclick="loadFinalists(${pagination.page + 1})"
              ${pagination.page >= pagination.totalPages ? 'disabled' : ''}
              class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next
            </button>
          </div>
        </div>
      `;
    }

    list.innerHTML = html;
  }

  // Filters with debouncing for search
  let searchTimeout: NodeJS.Timeout;
  document.getElementById('searchInput')!.addEventListener('input', (e) => {
    filters.search = (e.target as HTMLInputElement).value;
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      pagination.page = 1; // Reset to first page when searching
      loadFinalists(1);
    }, 500); // 500ms debounce
  });

  document.getElementById('categoryFilter')!.addEventListener('change', (e) => {
    filters.category = (e.target as HTMLSelectElement).value;
    pagination.page = 1; // Reset to first page when filtering
    loadFinalists(1);
  });

  document.getElementById('eventFilter')!.addEventListener('change', (e) => {
    filters.event = (e.target as HTMLSelectElement).value;
    pagination.page = 1; // Reset to first page when filtering
    loadFinalists(1);
  });

  document.getElementById('winnerFilter')!.addEventListener('change', (e) => {
    filters.winner = (e.target as HTMLSelectElement).value;
    pagination.page = 1; // Reset to first page when filtering
    loadFinalists(1);
  });

  // Modal controls
  const modal = document.getElementById('finalistModal')!;
  const modalTitle = document.getElementById('finalistModalTitle')!;
  const form = document.getElementById('finalistModalForm') as HTMLFormElement;
  const modalError = document.getElementById('finalistModalError')!;

  function openModal(title: string) {
    modalTitle.textContent = title;
    modalError.classList.add('hidden');
    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
    form.reset();
    (document.getElementById('finalistId') as HTMLInputElement).value = '';
    selectedFinalistTags = [];
    selectedFinalistAccolades = [];
    availableAccolades = [];
    renderSelectedFinalistTags();
    renderSelectedFinalistAccolades();
    updateFinalistTagSelector();
    updateFinalistAccoladeSelector();
    
    // Clear contacts
    currentFinalistId = null;
    finalistContacts = [];
    renderFinalistContacts();
    
    // Clear custom dropdowns
    ['category_id', 'event_id', 'finalistAccoladeSelector', 'finalistTagSelector'].forEach(id => {
      if ((window as any)[`clearDropdown_${id}`]) {
        (window as any)[`clearDropdown_${id}`]();
      }
    });
    
    // Clear media selector
    if (mediaSelectorId && (window as any)[`clearSelectedMedia_${mediaSelectorId}`]) {
      (window as any)[`clearSelectedMedia_${mediaSelectorId}`]();
    }
  }

  document.getElementById('addFinalistBtn')!.addEventListener('click', () => {
    selectedFinalistTags = [];
    selectedFinalistAccolades = [];
    availableAccolades = [];
    renderSelectedFinalistTags();
    renderSelectedFinalistAccolades();
    updateFinalistTagSelector();
    updateFinalistAccoladeSelector();
    
    // Clear media selector
    if (mediaSelectorId && (window as any)[`clearSelectedMedia_${mediaSelectorId}`]) {
      (window as any)[`clearSelectedMedia_${mediaSelectorId}`]();
    }
    
    openModal('Add Finalist');
  });

  document.getElementById('finalistModalCloseBtn')!.addEventListener('click', closeModal);
  document.getElementById('finalistModalCancelBtn')!.addEventListener('click', closeModal);

  // Edit finalist
  (window as any).editFinalist = async (id: string) => {
    const finalist = finalists.find(f => f.id === id);
    if (!finalist) return;

    (document.getElementById('finalistId') as HTMLInputElement).value = finalist.id;
    (document.getElementById('title') as HTMLInputElement).value = finalist.title;
    (document.getElementById('organization') as HTMLInputElement).value = finalist.organization || '';
    (document.getElementById('finalistDescription') as HTMLTextAreaElement).value = finalist.description || '';
    (document.getElementById('website_url') as HTMLInputElement).value = finalist.website_url || '';
    (document.getElementById('is_winner') as HTMLInputElement).checked = finalist.is_winner || false;
    
    // Set category dropdown
    if (finalist.category_id && finalist.categories?.name) {
      if ((window as any).setDropdownValue_category_id) {
        (window as any).setDropdownValue_category_id(finalist.category_id, finalist.categories.name);
      }
    } else if ((window as any).clearDropdown_category_id) {
      (window as any).clearDropdown_category_id();
    }
    
    // Set event dropdown
    if (finalist.event_id) {
      const event = events.find(e => e.id === finalist.event_id);
      if (event && (window as any).setDropdownValue_event_id) {
        const eventText = `${event.event_name} (${event.event_year})`;
        (window as any).setDropdownValue_event_id(finalist.event_id, eventText);
      } else if ((window as any).clearDropdown_event_id) {
        (window as any).clearDropdown_event_id();
      }
    } else if ((window as any).clearDropdown_event_id) {
      (window as any).clearDropdown_event_id();
    }
    
    // Set selected tags
    selectedFinalistTags = finalist.tags || [];
    renderSelectedFinalistTags();
    updateFinalistTagSelector();

    // Update available accolades based on category and set selected
    updateAvailableAccolades(finalist.category_id);
    selectedFinalistAccolades = finalist.accolades || [];
    renderSelectedFinalistAccolades();
    updateFinalistAccoladeSelector();

    // Load media for this finalist
    try {
      const response = await fetch(`/api/media/?finalistIds=${id}`);
      const data = await response.json();
      if (response.ok && data.media && data.media.length> 0) {
        // Set media in selector (only first one since single selection)
        if (mediaSelectorId && (window as any)[`setSelectedMedia_${mediaSelectorId}`]) {
          (window as any)[`setSelectedMedia_${mediaSelectorId}`](data.media);
        }
      } else {
        // Clear if no media
        if (mediaSelectorId && (window as any)[`clearSelectedMedia_${mediaSelectorId}`]) {
          (window as any)[`clearSelectedMedia_${mediaSelectorId}`]();
        }
      }
    } catch (error) {
      console.error('Error loading finalist media:', error);
      if (mediaSelectorId && (window as any)[`clearSelectedMedia_${mediaSelectorId}`]) {
        (window as any)[`clearSelectedMedia_${mediaSelectorId}`]();
      }
    }

    openModal('Edit Finalist');
  };

  // Delete finalist
  (window as any).deleteFinalist = async (id: string, title: string) => {
    if (!confirm(`Are you sure you want to delete "${title}"?`)) return;

    try {
      const response = await fetch('/api/finalists/', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id }),
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error);

      await loadFinalists(pagination.page);
    } catch (error: any) {
      alert('Error deleting finalist: ' + error.message);
    }
  };

  // Form submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    modalError.classList.add('hidden');

    const formData = new FormData(form);
    const id = formData.get('id') as string;
    
    // Get selected media from MediaSelector component
    const selectedMedia = mediaSelectorId && (window as any)[`getSelectedMedia_${mediaSelectorId}`]
      ? (window as any)[`getSelectedMedia_${mediaSelectorId}`]()
      : [];
    
    const data = {
      id: id || undefined,
      title: formData.get('title'),
      organization: formData.get('organization') || null,
      description: formData.get('description') || null,
      category_id: formData.get('category_id'),
      event_id: formData.get('event_id'),
      image_url: selectedMedia.length> 0 ? selectedMedia[0].file_url : null,
      website_url: formData.get('website_url') || null,
      is_winner: (document.getElementById('is_winner') as HTMLInputElement).checked,
      tag_ids: selectedFinalistTags.map(t => t.id),
      media_ids: selectedMedia.map((m: any) => m.id),
      accolade_ids: selectedFinalistAccolades.map(a => a.id),
    };

    try {
      const response = await fetch('/api/finalists/', {
        method: id ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();
      if (!response.ok) throw new Error(result.error);

      closeModal();
      await loadFinalists(pagination.page);
    } catch (error: any) {
      modalError.textContent = error.message;
      modalError.classList.remove('hidden');
    }
  });

  // Make loadFinalists globally accessible for pagination buttons
  (window as any).loadFinalists = loadFinalists;

  // Initial load
  // Contacts management for finalists
  let finalistContacts: any[] = [];
  let currentFinalistId: string | null = null;

  // Load contacts for a finalist
  async function loadFinalistContacts(finalistId: string) {
    try {
      const accessToken = window.__SUPABASE_ACCESS_TOKEN__ || '';
      const response = await fetch(`/api/contacts/?finalist_id=${finalistId}`, {
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      });

      if (!response.ok) throw new Error('Failed to fetch contacts');

      const data = await response.json();
      finalistContacts = data.contacts || [];
      renderFinalistContacts();
    } catch (error) {
      console.error('Error loading contacts:', error);
      finalistContacts = [];
      renderFinalistContacts();
    }
  }

  // Render contacts list
  function renderFinalistContacts() {
    const list = document.getElementById('finalistContactsList')!;
    
    if (finalistContacts.length === 0) {
      list.innerHTML = '<p class="text-sm text-gray-500">No contacts added yet.</p>';
      return;
    }

    const html = finalistContacts.map(contact => {
      const name = [contact.first_name, contact.last_name].filter(Boolean).join(' ') || 'N/A';
      return `
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 flex items-start justify-between">
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-900">${escapeHtml(name)}</p>
            <p class="text-xs text-gray-600">${escapeHtml(contact.email)}</p>
            ${contact.organization ? `<p class="text-xs text-gray-500">${escapeHtml(contact.organization)}</p>` : ''}
            ${contact.is_active ? 
              '<span class="inline-block mt-1 px-2 py-0.5 text-xs font-medium rounded bg-green-100 text-green-800">Active</span>' :
              '<span class="inline-block mt-1 px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-800">Inactive</span>'
            }
          </div>
          <div class="flex space-x-2 ml-3">
            <button
              onclick="event.stopPropagation(); event.preventDefault(); editFinalistContact('${contact.id}', event);"
              class="px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded transition-colors"
            >
              Edit
            </button>
            <button
              onclick="event.stopPropagation(); event.preventDefault(); deleteFinalistContact('${contact.id}', '${escapeHtml(contact.email)}', event);"
              class="px-2 py-1 text-xs text-red-600 hover:bg-red-50 rounded transition-colors"
            >
              Delete
            </button>
          </div>
        </div>
      `;
    }).join('');

    list.innerHTML = html;
  }

  // Add contact button handler
  document.getElementById('addFinalistContactBtn')?.addEventListener('click', () => {
    if (!currentFinalistId) {
      alert('Please save the finalist first before adding contacts.');
      return;
    }
    openFinalistContactModal('Add Contact');
  });

  // Open contact modal
  function openFinalistContactModal(title: string) {
    const modal = document.getElementById('finalistContactModal')!;
    const modalTitle = document.getElementById('finalistContactModalTitle')!;
    if (modalTitle) modalTitle.textContent = title;
    // Set higher z-index for nested modal
    modal.style.zIndex = '60';
    modal.classList.remove('hidden');
    
    // Prevent backdrop clicks from closing parent modal
    const backdrop = modal.querySelector('.bg-black\\/50') as HTMLElement;
    if (backdrop) {
      backdrop.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
    
    // Prevent modal content clicks from bubbling
    const modalContent = modal.querySelector('.bg-white') as HTMLElement;
    if (modalContent) {
      modalContent.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  }

  function closeFinalistContactModal(event?: Event) {
    if (event) {
      event.stopPropagation();
    }
    const modal = document.getElementById('finalistContactModal')!;
    const form = document.getElementById('finalistContactModalForm') as HTMLFormElement;
    modal.classList.add('hidden');
    if (form) form.reset();
    const contactIdEl = document.getElementById('finalistContactId') as HTMLInputElement;
    if (contactIdEl) contactIdEl.value = '';
  }

  // Edit contact
  (window as any).editFinalistContact = function(id: string, event?: Event) {
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }
    const contact = finalistContacts.find(c => c.id === id);
    if (!contact) return;

    openFinalistContactModal('Edit Contact');
    (document.getElementById('finalistContactId') as HTMLInputElement).value = contact.id;
    (document.getElementById('finalistContactEmail') as HTMLInputElement).value = contact.email || '';
    (document.getElementById('finalistContactFirstName') as HTMLInputElement).value = contact.first_name || '';
    (document.getElementById('finalistContactLastName') as HTMLInputElement).value = contact.last_name || '';
    (document.getElementById('finalistContactOrganization') as HTMLInputElement).value = contact.organization || '';
    (document.getElementById('finalistContactIsActive') as HTMLInputElement).checked = contact.is_active !== false;
  };

  // Delete contact
  (window as any).deleteFinalistContact = async function(id: string, email: string, event?: Event) {
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }
    if (!confirm(`Are you sure you want to delete the contact "${email}"?`)) return;

    try {
      const accessToken = window.__SUPABASE_ACCESS_TOKEN__ || '';
      const response = await fetch('/api/contacts/', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({ id })
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Failed to delete contact');

      if (currentFinalistId) {
        await loadFinalistContacts(currentFinalistId);
      }
    } catch (error: any) {
      alert('Error deleting contact: ' + error.message);
    }
  };

  // Contact modal close handlers
  document.getElementById('finalistContactModalCloseBtn')?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeFinalistContactModal(e);
  });
  document.getElementById('finalistContactModalCancelBtn')?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeFinalistContactModal(e);
  });

  // Finalist contact form submission
  const finalistContactForm = document.getElementById('finalistContactModalForm') as HTMLFormElement;
  if (!finalistContactForm) {
    console.error('Finalist contact form not found!');
  } else {
    console.log('Attaching finalist contact form submit handler');
  }
  
  finalistContactForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('Finalist contact form submitted');
    if (!currentFinalistId) {
      alert('Please save the finalist first before adding contacts.');
      return;
    }

    const contactId = (document.getElementById('finalistContactId') as HTMLInputElement).value;
    const email = (document.getElementById('finalistContactEmail') as HTMLInputElement).value;
    const firstName = (document.getElementById('finalistContactFirstName') as HTMLInputElement).value;
    const lastName = (document.getElementById('finalistContactLastName') as HTMLInputElement).value;
    const organization = (document.getElementById('finalistContactOrganization') as HTMLInputElement).value;
    const isActive = (document.getElementById('finalistContactIsActive') as HTMLInputElement).checked;

    try {
      const accessToken = window.__SUPABASE_ACCESS_TOKEN__ || '';
      const url = '/api/contacts/';
      const method = contactId ? 'PUT' : 'POST';
      const body: any = {
        email,
        first_name: firstName || null,
        last_name: lastName || null,
        organization: organization || null,
        is_active: isActive
      };

      if (contactId) {
        body.id = contactId;
      } else {
        // Type is derived from association - just add the finalist_id
        body.finalist_id = currentFinalistId;
      }

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Failed to save contact');

      closeFinalistContactModal();
      await loadFinalistContacts(currentFinalistId);
    } catch (error: any) {
      alert('Error saving contact: ' + error.message);
    }
  });

  // Update editFinalist to load contacts
  const originalEditFinalist = (window as any).editFinalist;
  (window as any).editFinalist = async function(id: string) {
    await originalEditFinalist(id);
    currentFinalistId = id;
    await loadFinalistContacts(id);
  };

  // Clear contacts when adding new finalist
  const addFinalistBtn = document.getElementById('addFinalistBtn');
  if (addFinalistBtn) {
    const originalClick = addFinalistBtn.onclick;
    addFinalistBtn.addEventListener('click', () => {
      currentFinalistId = null;
      finalistContacts = [];
      renderFinalistContacts();
      if (originalClick) originalClick.call(addFinalistBtn, new Event('click'));
    });
  }

  Promise.all([loadCategories(), loadEvents(), loadTags(), loadAccolades()]).then(() => loadFinalists(1));
</script>

<!-- Contact Modal for Finalists -->
<Modal id="finalistContactModal" title="Add Contact">
  <form id="finalistContactModalForm" class="space-y-4">
    <input type="hidden" id="finalistContactId" />
    
    <div>
      <label for="finalistContactEmail" class="block text-sm font-medium text-gray-700 mb-1">
        Email *
      </label>
      <input
        type="email"
        id="finalistContactEmail"
        required
        class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
        placeholder="contact@example.com"
      />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="finalistContactFirstName" class="block text-sm font-medium text-gray-700 mb-1">
          First Name
        </label>
        <input
          type="text"
          id="finalistContactFirstName"
          class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
          placeholder="John"
        />
      </div>

      <div>
        <label for="finalistContactLastName" class="block text-sm font-medium text-gray-700 mb-1">
          Last Name
        </label>
        <input
          type="text"
          id="finalistContactLastName"
          class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
          placeholder="Doe"
        />
      </div>
    </div>

    <div>
      <label for="finalistContactOrganization" class="block text-sm font-medium text-gray-700 mb-1">
        Organization
      </label>
      <input
        type="text"
        id="finalistContactOrganization"
        class="w-full px-2.5 py-2 border border-gray-300 rounded-lg focus:outline-hidden focus:ring-2 focus:ring-blue-500"
        placeholder="Company Name"
      />
    </div>

    <div>
      <label class="flex items-center space-x-2 px-4 py-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
        <input
          type="checkbox"
          id="finalistContactIsActive"
          checked
          class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
        />
        <span class="text-sm text-gray-700">Active (can receive emails)</span>
      </label>
    </div>
  </form>
</Modal>

